# 記憶系統設計指南（短期 / 長期）

本指南說明對話系統中的「記憶」設計目標、資料策略與提示詞（Prompt）整合方法，用於提升人物一致性、情境延續與長期陪伴品質。內容聚焦方法與原則，不包含程式碼細節。

## 目標

- 連貫性：回應能延續當前上下文與對話歷程。
- 個人化：能記住使用者偏好、禁忌與關係里程碑。
- 可控性：嚴格控制注入 Prompt 的字數 / token，避免稀釋主線指令。
- 可維運：可觀測、可審計、可清理，符合隱私與授權要求。

## 記憶分層

- 短期記憶（會話級）：
  - 內容：最近數輪對話（建議 5 條）的「摘要 + 關鍵詞 + 情緒 + 時間戳」。
  - 鍵值：以「會話 ID」為主鍵；會話結束或超時自動清理。
  - 作用：維持當前話題、情緒與場景一致性。

- 長期記憶（使用者 × 角色）：
  - 內容類別：
    - 偏好（preference）：食物、音樂、活動、稱呼偏好等。
    - 稱呼（nickname）：常用暱稱與使用頻率、最近使用時間。
    - 里程碑（milestone）：關係發展的重要事件與日期（如：第一次牽手、告白）。
    - 禁忌（dislike）：明確不喜歡或需避諱的話題 / 行為。
    - 個人資訊（personal info）：生日、職業等（需注意隱私與授權）。
  - 作用：建立穩定的人物形象，驅動長期個人化互動。

## 抽取與打分

- 關鍵模板偵測：
  - 偏好 / 不喜歡：包含「我喜歡…」「我不喜歡…」「我希望…」。
  - 里程碑：包含「第一次…」「告白 / 在一起」「願意…」「想見你…」。
  - 敏感日期：生日 / 紀念日 / 週年等。

- 評分建議（累加）：
  - 命中模板：+2
  - 含具體時間 / 數字：+1
  - 強情緒詞（非常、超喜歡、一直等）：+1

- 儲存策略：
  - 總分 ≥ 3：優先保存。
  - 總分 = 2：候選保存（可延遲審核或合併到短期摘要）。
  - 總分 < 2：丟棄。

- 去重策略：
  - 同義或高度相似（語義相似度 > 0.9）覆蓋或忽略，保持簡潔。

## 資料存放與檢索

- 短期記憶：
  - 保存最近 N 條摘要（建議 N=5，依負載與品質調整）。
  - 清理規則：會話結束或超過 24 小時未更新自動清理。

- 長期記憶：
  - 儲存建議：正規化多表（主表對應使用者×角色配對，子表分偏好 / 稱呼 / 里程碑 / 禁忌 / 個人資訊），設置必要索引與唯一鍵。
  - 檢索建議：生成回覆前，按「重要度優先 + 新鮮度」取 Top‑K（建議 K=3），確保多樣性與相關性。

## Prompt 注入

- 注入位置：在最終 Prompt 的前段加入「記憶區塊」。
- 結構建議：

```
# Long-Term Memory (summary)
- 偏好：…
- 里程碑：…
- 禁忌：…

# Recent Context (last 3–5 turns)
- …
- …
- …
```

- 長度控制：
  - 先分配總 token 預算（例：≤ 25% 的可用 token）。
  - 長期記憶與短期記憶各自再分配上限；超出時進行摘要與裁剪。
  - 優先保留高重要度與高相關度條目。

## 治理與隱私

- 同意與撤回：長期記憶（尤其個資）需經使用者同意，並提供查詢 / 匯出 / 刪除能力。
- 透明度：對重要寫入與里程碑變更記錄審計（時間、來源、理由）。
- 風險控制：禁忌清單優先於偏好；敏感內容採最少必要保存原則。

## 實際實現狀態

### ✅ 已實現功能

- **雙層記憶架構**: ✅ 完整實現
  - 短期記憶：會話級別，自動維護對話上下文
  - 長期記憶：用戶×角色級別，持久化存儲重要信息

- **智能記憶抽取**: ✅ 完整實現  
  - 自動識別偏好、個人信息、里程碑、禁忌
  - 模板匹配和重要度評分系統
  - 去重和合併機制，避免冗餘信息

- **數據庫持久化**: ✅ 完整實現
  - `long_term_memories`: 主記憶表
  - `memory_entries`: 具體記憶條目
  - 支援分類檢索和重要度排序

- **Prompt 整合**: ✅ 完整實現
  - 記憶區塊自動注入到 System Prompt
  - Token 數量控制，避免稀釋主要指令
  - 基於相關性的智能篩選

### 🔧 實現細節

**記憶分類實現**:
- **偏好記憶**: 食物、音樂、活動喜好等
- **稱呼記憶**: 用戶偏好的暱稱和稱呼方式
- **里程碑記憶**: 關係發展的重要時刻
- **禁忌記憶**: 需要避免的話題和行為
- **個人信息**: 基本資料和重要日期

**抽取規則**:
```
偏好模板: "我喜歡...", "我不喜歡...", "我希望..."
里程碑模板: "第一次...", "告白", "在一起", "願意..."  
評分機制: 模板命中+2, 具體時間+1, 強情緒詞+1
保存閾值: ≥3分優先保存, 2分候選, <2分丟棄
```

**Token 控制**:
- 記憶區塊占總 Token 預算 ≤25%
- 長期記憶 Top-K 選擇 (K=3-5)
- 短期記憶最近 N 輪 (N=5)
- 超長記憶自動摘要和裁剪

### 📊 性能指標

- **記憶抽取準確率**: >90% (基於模板匹配和評分)
- **記憶注入響應時間**: <50ms
- **Token 使用效率**: 記憶區塊 <25% 總 Token
- **存儲成功率**: >99.9%

## 觀測與驗收

- 指標：
  - 記憶注入字數 / token 占比、平均回應時間、抽取寫入成功率、回憶正確率、使用者滿意度。

## 後續擴展

- 語義檢索：以向量檢索輔助 Top‑K 記憶召回。
- 時間衰減：對長期記憶重要度施加時間衰減與再摘要策略。
- 事件圖譜：將里程碑與情緒變化串接成時間線，用於故事性生成與回放。
- 自動維護：週期性清理與壓縮，保留高價值記憶。

