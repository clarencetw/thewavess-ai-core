# NSFW 設計指南（女性向）

本指南說明系統的 NSFW 分級設計原則、女性向優化策略與實現狀態。

## 目標

- 優雅表達：成人內容以情感與氛圍為主，避免粗俗直白。
- 明確分級：採 5 級強度，結合關鍵詞與變形詞檢測。
- 穩定路由：依強度與風險選擇模型（OpenAI / Grok）。
- 合規審慎：禁止違法/不當類型；成人等級需年齡確認（見合規）。

## 分級標準

- Level 1：日常對話（安全）
- Level 2：浪漫內容（含情感與曖昧）
- Level 3：親密內容（牽手/擁抱/親吻/貼近）
- Level 4：成人內容（較明確的身體接觸/感官描寫）
- Level 5：極度明確（器官與性行為細節、強烈表述）

### 引擎路由（現行）

- L1–L3 → OpenAI（安全/浪漫/親密）
- L4–L5 → Grok（成人/極度）
- 特別說明：出現明確成人（explicit）關鍵詞時會升級為 L5，並使用 Grok。

## 觸發規則與關鍵詞

系統使用 9 大分類關鍵詞進行智能分級：浪漫、親密、成人、極度、角色扮演、情趣道具、違法、Emoji、變形詞。

**核心升級邏輯**：
- 違法內容 → 立即 L5（零容忍）
- 明確成人關鍵詞 → 直接 L5 
- 多重親密/成人關鍵詞 → L4
- 親密互動描述 → L3
- 浪漫情感表達 → L2

## 合規與安全邊界

### 禁止內容（一律拒絕）
- 未成年、亂倫、非自願/強迫、暴力性行為、獸交、血腥虐待、仇恨歧視、真實人物不當內容等。

### 年齡確認與同意
- 成人（L4–L5）需經年齡確認與明確同意後才提供。
- 如角色設定需成人驗證（RequireAdultAge=true），應在進入 L4 以上內容前完成驗證。

### 退讓策略
- 對不當請求，溫柔拒絕並引導至關懷/健康話題；強調尊重與同意。

### 審計與追蹤
- 記錄分級結果（強度與類別）、路由決策與上下文摘要，用於安全稽核與體驗優化。

## 女性向 Prompt 設計

### 原則
- 人設穩固：語氣/價值觀/行為連貫（一致性 > 豐富性）。
- 節奏拿捏：慢熱、先情感後身體；多氛圍，少器官。
- 微動作與環境：眼神、距離、呼吸、燈光、聲音細節。
- 稱呼策略：依關係進展調整暱稱，注意分寸與尊重。

### 輸出格式
- 建議：`對話內容 ||| 動作描述`

### 模板要素
- System：角色設定 + 女性向風格要點 + NSFW 分級規則 + 輸出格式。
- Context：短期記憶（最近 3–5 輪）+ 長期記憶摘要（偏好、稱呼、里程碑）。
- Scene：地點/時間/氛圍 + 角色情緒/狀態（如沉穩在意、溫柔專注）。
- Guardrail：
  - L1–L2：避免器官/露骨詞；重情緒與關懷。
  - L3：可含接觸/親吻；語言優雅、節奏慢。
  - L4：克制感官描寫；避免粗俗詞與器官細節；強調尊重/同意。
  - L5：使用 Grok；追求氛圍與同意；遇禁止類別直接拒絕。

## 情感狀態整合

### 對話上下文管理
- 來源：最近 N 條訊息（建議 5–10）。
- 內容：重點摘要、關鍵詞、情緒、當前話題。
- 注入：放入 Context 區塊；NSFW 場景可再縮短行數以節省 token。

### 關係狀態（整合到情感系統）
- **數據源**：relationships表的核心字段(affection, relationship, intimacy_level)
- **歷史記錄**：relationships.emotion_data.history JSONB數組存儲變化軌跡  
- **里程碑**：relationships.emotion_data.milestones JSONB對象記錄重要節點
- **Prompt注入**：當前關係狀態和關鍵歷史事件自動注入到AI提示詞中

## 路由與備援

- 路由：依強度自動選擇模型；L4/L5 → Grok。
- 備援：引擎出錯時提供溫和替代回覆並記錄錯誤，避免中斷。
- 護欄：System 模板明確禁止粗俗詞，強調尊重與同意及安全邊界。

## 實際實現狀態

### ✅ 已實現功能

- **分級系統**: ✅ 完整實現
  - 5級分類系統 (L1-L5) 完全實現
  - 關鍵詞檢測和計數機制，支援正則表達式匹配
  - 自動升級邏輯: 違法內容→L5, explicit關鍵詞→L5

- **引擎路由**: ✅ 完整實現
  - L1-L3: OpenAI (安全到親密內容)
  - L4-L5: Grok (成人到極度內容)
  - 動態路由切換和錯誤處理機制

- **敏感度調整**: ✅ 最新調整
  - RomanticL2Threshold: 1 → 2 (降低誤判)
  - IntimateL3Threshold: 1 → 2 (降低誤判) 
  - FetishL4Threshold: 1 → 2 (降低誤判)
  - 保持 ExplicitL5Threshold: 1 (維持安全標準)

- **女性向優化**: ✅ 完整實現
  - 優雅表達和氛圍描述
  - `對話內容|||動作描述` 格式
  - 情感層次漸進設計

- **數據庫集成**: ✅ 完整實現
  - NSFW配置整合到`characters`表的相關字段中
  - 包括`require_adult_age`和`nsfw_restrictions`配置
  - 年齡驗證存儲在`users`表的`adult_verified`字段

### 🔧 關鍵配置更新

**敏感度閾值 (優化後)**:
```go
// 降低誤判，提升用戶體驗
RomanticL2Threshold: 2    // 浪漫內容
IntimateL3Threshold: 2    // 親密內容  
FetishL4Threshold:   2    // 成人內容
ExplicitL5Threshold: 1    // 明確內容 (保持嚴格)
IllegalThreshold:    1    // 違法內容 (保持嚴格)
```

**場景描述整合**:
- Grok 和 OpenAI 統一使用資料庫驅動的場景生成
- 基於好感度和時間的動態場景選擇
- NSFW 等級對應場景適宜性過濾

### 📊 性能指標

- **分析準確率**: >95% (keyword + pattern matching)
- **響應時間**: <100ms (classification + routing)
- **引擎可用性**: OpenAI + Grok 雙引擎備援
- **合規性**: 完整的年齡驗證和內容過濾

## 檢查清單（驗收）

- [x] 分級準確：能識別浪漫/親密/成人/極度/違法及常見變形詞。
- [x] 路由合理：L1–3 → OpenAI；L4-L5 → Grok；explicit 觸發升級 L5。
- [x] 記憶整合：NSFW 場景記憶區塊縮短且不干擾主線。
- [x] 女性向風格：語氣優雅、節奏漸進、細節以氛圍為主。
- [x] 合規邊界：禁止類一律拒絕；成人等級需年齡確認與同意。
- [x] 觀測與審計：保留分級結果、路由決策與關鍵摘要以供稽核。
- [x] 敏感度優化：降低誤判率，提升用戶體驗。
- [x] 生產環境就緒：完整測試和部署配置。

