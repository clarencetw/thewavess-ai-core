# NSFW 功能實作指南（女性向）

本文件說明系統的 NSFW 分級、觸發規則、引擎路由、提示詞（Prompt）設計與記憶整合，重點針對女性向（女性受眾）聊天體驗優化。

> **參考資料**：關於記憶儲存/檢索與 Prompt 注入的最小可用方案，請參考 [MEMORY_GUIDE.md](MEMORY_GUIDE.md)。

## 目標

- 提供優雅不粗俗的成人內容表達，並符合女性受眾偏好
- 以 5 級內容分級為核心，結合關鍵詞與語義判斷做引擎路由
- 在 Prompt 中強化角色人設、情感節奏與互動細節，並注入短期/長期記憶
- 嚴格合規：18+ 年齡驗證、禁止違法/不當類型、完整審計日誌

## 分級標準

系統採用 5 級內容分級標準：

- **Level 1**：日常對話（安全）
- **Level 2**：浪漫內容（含情感與曖昧）
- **Level 3**：親密內容（牽手/擁抱/親吻/貼近）
- **Level 4**：成人內容（較明確的身體接觸/感官描述）
- **Level 5**：極度明確（露骨性器官與性行為描述）

### 引擎路由規則

- **Level 1-4** → OpenAI
- **Level 5** → Grok（極度明確內容）

## 觸發規則與關鍵詞

### 關鍵詞分類（中英混合）

系統採用多層次關鍵詞分析，包含以下分類：

#### 主要分級關鍵詞

- **浪漫（L2）**：
  - 中文：喜歡你、愛你、想你、心動、約會、臉紅、害羞、溫柔、甜蜜、浪漫、陪伴、呵護、思念、悸動、在意、關心
  - 英文：love, like, miss, romantic, date, gentle, beautiful, cute, charming, attractive, heartbeat, sweet, darling

- **親密（L3）**：
  - 中文：擁抱、親吻、靠近、貼近、觸碰、撫摸、愛撫、肌膚、體溫、心跳、親密、激情、慾望、性感、誘惑、調情、肉體、身體
  - 英文：kiss, touch, caress, embrace, skin, warm, shiver, intimate, passion, desire, sexy, seduce, tease, flirt, body

- **成人（L4）**：
  - 中文：做愛、愛愛、啪啪啪、性行為、性愛、高潮、口交、乳交、陰莖、陰道、乳房、胸部、私處、性器、濕潤、勃起、敏感、呻吟
  - 英文：sex, fuck, cum, orgasm, penetrate, naked, nude, penis, vagina, breast, nipple, pussy, cock, wet, hard, moan, blowjob

- **極度（L5）**：
  - 中文：狂操、猛插、爆射、內射、肛交、深喉、群交、3P、調教、綁縛、SM、潮吹、失禁、淫蕩、騷、賤
  - 英文：gangbang, threesome, anal, dp, deepthroat, facial, creampie, squirt, bondage, domination, submissive, kinky

#### 進階分類

- **角色扮演**：女僕、OL、秘書、護士、老師、上司、霸總、制服、cosplay
- **情趣道具**：跳蛋、按摩棒、震動棒、手銬、眼罩、項圈、情趣內衣
- **違法內容**：未成年、蘿莉、正太、亂倫、強暴、強姦、非自願、獸交（一律 Level 5）
- **表意符號**：🍆、🍑、💦、👅、😈、😏、🥵、🫦、💋、🛏、🔞
- **變形詞彙**：f*ck、f**k、s3x、secks、c0ck、d1ck 等

### 判斷規則（更新版）

系統採用加權計算機制，包含以下規則：

#### 核心規則
- **Level 5 觸發**：
  - 違法類關鍵詞 ≥1（未成年/強暴/亂倫/獸交等）
  - 極度明確詞彙 ≥2
  - 極度詞彙 ≥1 且 成人詞彙 ≥2
- **Level 4 觸發**：
  - 成人詞彙 ≥2
  - 成人詞彙 ≥1 且 親密詞彙 ≥2
- **Level 3 觸發**：
  - 親密詞彙 ≥2
  - 親密詞彙 ≥1 且 浪漫詞彙 ≥2
- **Level 2 觸發**：
  - 浪漫詞彙 ≥2 或 親密詞彙 ≥1

#### 加權機制
- Emoji 符號加權到親密類別
- 角色扮演、情趣道具詞彙加權到成人類別
- 變形詞彙加權到成人類別
- 違法類詞彙雙倍加權到極度類別

#### 文本正規化
- **NFKC 標準化**：處理全形/半形字元
- **Squashed 匹配**：移除空白與標點符號的緊密匹配
- **模糊匹配**：正則表達式處理變形詞彙（如 f.u.c.k、f u c k）

> **注意**：系統支援繁體中文口語用法與各種變形詞彙，持續優化匹配精度

## 合規與安全邊界

### 內容限制

- **禁止內容**：未成年人、強迫/非自願、暴力性行為、血腥虐待、仇恨歧視、真實人物不當內容等
- **系統設計**：NSFW 功能預設完全啟用，無需使用者設定或年齡驗證

### 退讓策略

- **不當請求** → 溫柔拒絕，轉移至情感支持或健康關懷話題
- **系統原則** → 基於內容分析自動選擇適當引擎，無降級機制

### 審計與追蹤

記錄偵測結果、路由決策與上下文摘要。

**對應程式碼**：
- **分析器**：`services/nsfw_analyzer.go` - `NSFWAnalyzer.AnalyzeContent()`
- **引擎選擇**：`services/chat_service.go:selectAIEngine()` 
- **關鍵詞庫**：`NSFWAnalyzer.NewNSFWAnalyzer()` 中的各類關鍵詞數組

## 女性向 Prompt 設計

### 設計原則

- **人設穩固**：始終維持角色語氣、價值觀與行為邏輯（一致性 > 豐富性）
- **節奏拿捏**：慢熱、循序漸進，先情感後身體；更多「情緒/氛圍」少「器官/動作」
- **微動作細節**：眼神、距離、呼吸、手勢、環境氛圍，讓讀者「感覺被在場」
- **稱呼策略**：根據關係進展調整（你→妳、小傻瓜/乖/寶貝等，注意分寸）
- **關懷優先**：先確認情緒/身體狀態，再表達慾望；強調尊重與同意

### 輸出格式

建議格式：`對話內容 ||| 動作描述`

### 模板要素

- **System**：角色設定 + 女性向風格要點 + NSFW 等級行為規則 + 輸出格式
- **Context**：短期對話記憶（最近 3-5 輪）+ 長期記憶摘要（偏好、稱呼、里程碑）
- **Scene**：地點/時間/氛圍 + 角色情緒/狀態（例如：沉穩但在意、溫柔而專注）
- **Guardrail**：
  - **Level 1-2**：避免器官/露骨詞；重情緒與關懷
  - **Level 3**：可含接觸/親吻，語言優雅、節奏慢
  - **Level 4**：克制的感官描寫，不用粗俗詞；避免具體器官細節
  - **Level 5**：移交 Grok，以人設與氛圍為主，仍保持尊重與同意

### 示例片段

以下為 OpenAI/Level 3，陸寒淵角色的示例：

```text
System:
你是陸寒淵，28 歲霸道總裁……（略）
女性向指引：節奏慢、先情感後身體；避免粗俗詞；尊重與同意。
輸出：對話內容 ||| 動作描述
Scene：黃昏的辦公室，城市燈火在落地窗外閃爍
Emotion：保護慾強、語氣低沉但溫柔

User：我今天有點累……

Assistant（示例）：
想靠一會兒就說，我在。|||他放下手中的筆，走近為你調暗了燈光，視線始終落在你身上。
```

## 記憶設計

### 短期記憶（會話級）

- **來源**：資料庫最近 N 條訊息（建議 5-10）
- **內容**：使用者重點、角色回覆語氣、未完成的話題、最新情緒
- **用法**：摘要後注入 Prompt 的 Context 區塊（限制字數，避免干擾主線）

### 長期記憶（使用者/角色關係級）

- **來源**：重要對話/事件抽取、偏好學習、里程碑（第一次牽手/告白等）
- **內容**：
  - 偏好：稱呼、喜歡的關懷方式、禁用詞/不喜歡的話題
  - 個資與紀念日：生日、重要日期
  - 關係狀態：affection、relationship、intimacy level
- **用法**：
  - 檢索 Top-K（語義相似 + 時間權重）+ 重要度摘要
  - 注入 Prompt 的 Memory 區塊（條列簡短要點）

### 更新時機

- **每輪對話結束**：根據 AI 回覆與使用者輸入，抽取可能的記憶片段
- **里程碑事件**：關係階段變更、好感度跨閾值、觸發特殊事件
- **重複訊息去重**：避免冗餘；維持最高質量樣本

**對應程式碼**：`services/chat_service.go:updateMemorySystem`（待完善）、`getRecentMemories`

## 引擎路由策略

- **路由**：`selectAIEngine` 純粹基於 `ContentAnalysis.ShouldUseGrok` 判斷
- **Level 1-4** → OpenAI
- **Level 5** → Grok
- **備援處理**：若 AI 引擎出錯，提供備用回應並記錄錯誤
- **提示詞護欄**：在 System 明確禁止粗俗詞、要求優雅語彙、強調尊重與同意

## 實現狀態

### 已完成功能

- [完成] **NSFW 分級**：`NSFWAnalyzer` 完整實現進階多層次分析
  - [完成] 8 大關鍵詞分類（浪漫/親密/成人/極度/角色扮演/情趣/違法/變形）
  - [完成] NFKC 文本正規化與 squashed 匹配
  - [完成] 正則模糊匹配變形詞彙（如 f.u.c.k）
  - [完成] 加權計算機制與信心度評估
- [完成] **Prompt 統一**：OpenAI 使用 `BuildCharacterPrompt`；Grok 使用 `BuildNSFWPrompt`
- [完成] **輸出解析**：
  - [完成] 多種輸出格式解析器實現（`parseDialogueActionFormat`, `parseJSONFormat` 等）
  - [完成] 回退策略：`generatePersonalizedAction` 已實現
- [完成] **引擎選擇**：`selectAIEngine` 基於 `ContentAnalysis.ShouldUseGrok` 自動路由
- [完成] **審計**：`ScoringEvaluator` 記錄完整指標，包含詳細 NSFW 分析日誌

### 待完成項目

- [待完成] **記憶注入到 Prompt**：TODO 標記已添加，需實現 `buildMemoryBlock` 功能

## 開發者檢查清單

- [x] **`NSFWAnalyzer` 進階分級系統**：
  - [完成] 8 大關鍵詞分類與加權計算
  - [完成] NFKC 正規化與模糊匹配
  - [完成] 違法內容檢測與強制 Level 5 路由
  - [完成] 信心度評估與 `ShouldUseGrok` 判斷
- [x] **Prompt 系統**：
  - [完成] `BuildCharacterPrompt` & `BuildNSFWPrompt` 實現
  - [完成] 女性向風格指引與護欄機制
- [ ] **記憶系統**：
  - [待完成] 記憶檢索與 Prompt 注入功能
- [x] **引擎路由**：
  - [完成] `selectAIEngine` 基於 `ContentAnalysis.ShouldUseGrok`
  - [完成] Level 1-4 → OpenAI，Level 5 → Grok
  - [完成] NSFW 預設啟用，無需使用者設定
- [x] **輸出處理**：
  - [完成] `對話|||動作` 格式解析
  - [完成] 多種回退策略與錯誤處理
- [x] **審計與日誌**：
  - [完成] `ScoringEvaluator` 完整評分指標
  - [完成] 結構化 NSFW 分析日誌
  - [完成] OpenAI/Grok 請求詳細記錄

