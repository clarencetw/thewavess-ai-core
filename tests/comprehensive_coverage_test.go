package tests

import (
	"math/rand"
	"testing"
	"time"

	"github.com/clarencetw/thewavess-ai-core/services"
	"github.com/clarencetw/thewavess-ai-core/utils"
)

// å¤§è¦æ¨¡èªæ–™æ¸¬è©¦ - æ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶è¼¸å…¥å ´æ™¯
func TestMassiveVocabularyGaps(t *testing.T) {
	utils.InitLogger()
	utils.LoadEnv()

	t.Logf("=== å¤§è¦æ¨¡è©å½™ç¼ºå£åˆ†æ ===")

	classifier := services.NewEnhancedKeywordClassifier()

	// 1. æ—¥å¸¸å°è©±å¤§é‡æ¸¬è©¦ï¼ˆæ‡‰è©²éƒ½æ˜¯L1ï¼‰
	dailyConversations := []string{
		// å·¥ä½œç›¸é—œ
		"ä»Šå¤©é–‹æœƒå¾ˆç´¯", "è€é—†äº¤ä»£çš„ä»»å‹™", "åŒäº‹è«‹å‡äº†", "åŠ ç­åˆ°å¾ˆæ™š", "è–ªæ°´å¤ªå°‘äº†",
		"å‡è·åŠ è–ª", "æ›å·¥ä½œ", "é¢è©¦çµæœ", "å°ˆæ¡ˆé€²åº¦", "deadlineå£“åŠ›",
		"å‡ºå·®è¨ˆåŠƒ", "æœƒè­°è¨˜éŒ„", "å ±å‘Šæ’°å¯«", "æ•¸æ“šåˆ†æ", "å®¢æˆ¶éœ€æ±‚",

		// å­¸ç¿’æ•™è‚²
		"è€ƒè©¦æˆç¸¾", "ä½œæ¥­å¤ªå¤š", "è€å¸«å¾ˆåš´æ ¼", "èª²ç¨‹å…§å®¹", "ç•¢æ¥­è«–æ–‡",
		"çå­¸é‡‘ç”³è«‹", "ç¤¾åœ˜æ´»å‹•", "åœ–æ›¸é¤¨è®€æ›¸", "è£œç¿’ç­", "èªè¨€å­¸ç¿’",
		"å¯¦ç¿’ç¶“é©—", "æŠ€èƒ½åŸ¹è¨“", "è­‰ç…§è€ƒè©¦", "ç ”ç©¶æ‰€", "å‡ºåœ‹ç•™å­¸",

		// ç”Ÿæ´»èµ·å±…
		"è²·èœåšé£¯", "æ‰“æƒæˆ¿é–“", "æ´—è¡£æœ", "æ”¶æ‹¾æ±è¥¿", "è£ä¿®æˆ¿å­",
		"æ¬å®¶è¨ˆåŠƒ", "æˆ¿ç§Ÿå¤ªè²´", "æ°´é›»è²»", "ç¶²è·¯å•é¡Œ", "å®¶é›»ç¶­ä¿®",
		"å¯µç‰©ç…§é¡§", "æ¤ç‰©æ¾†æ°´", "åƒåœ¾åˆ†é¡", "ç¯€èƒ½ç’°ä¿", "ç”Ÿæ´»å“è³ª",

		// å¥åº·é†«ç™‚
		"èº«é«”æª¢æŸ¥", "çœ‹é†«ç”Ÿ", "åƒè—¥æ²»ç™‚", "é‹å‹•å¥èº«", "æ¸›è‚¥è¨ˆåŠƒ",
		"å¤±çœ å•é¡Œ", "å£“åŠ›å¤§", "å¿ƒç†å¥åº·", "ç‡Ÿé¤Šè£œå……", "é é˜²ç–¾ç—…",
		"ç‰™ç§‘æ²»ç™‚", "è¦–åŠ›ä¿å¥", "çš®è†šä¿é¤Š", "éæ•åæ‡‰", "å¥åº·é£²é£Ÿ",

		// å¨›æ¨‚ä¼‘é–’
		"çœ‹é›»å½±", "è½éŸ³æ¨‚", "ç©éŠæˆ²", "é–±è®€å°èªª", "è¿½åŠ‡",
		"æ—…éŠè¨ˆåŠƒ", "æ‹ç…§æ”å½±", "é‹å‹•æ¯”è³½", "æ¼”å”±æœƒ", "å±•è¦½åƒè§€",
		"æœ‹å‹èšé¤", "é€›è¡—è³¼ç‰©", "å’–å•¡å»³", "KTVå”±æ­Œ", "æˆ¶å¤–æ´»å‹•",

		// ç§‘æŠ€æ•¸ä½
		"æ‰‹æ©Ÿå£äº†", "é›»è…¦å‡ç´š", "è»Ÿé«”æ›´æ–°", "ç¶²è·¯è³¼ç‰©", "ç·šä¸Šèª²ç¨‹",
		"ç¤¾ç¾¤åª’é«”", "å½±ç‰‡å‰ªè¼¯", "ç¨‹å¼è¨­è¨ˆ", "äººå·¥æ™ºæ…§", "å€å¡Šéˆ",
		"é›»å­ç”¢å“", "æ•¸æ“šå‚™ä»½", "è³‡è¨Šå®‰å…¨", "ç§‘æŠ€æ–°è", "å‰µæ–°ç™¼æ˜",
	}

	// 2. æƒ…æ„Ÿè¡¨é”æ¸¬è©¦ï¼ˆæ‡‰è©²ä¸»è¦æ˜¯L1-L2ï¼‰
	emotionalExpressions := []string{
		// é–‹å¿ƒå¿«æ¨‚
		"ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½", "é–‹å¿ƒå¾—ä¸å¾—äº†", "å¿«æ¨‚ä¼¼ç¥ä»™", "ç¬‘å¾—å¾ˆç‡¦çˆ›", "èˆˆé«˜é‡‡çƒˆ",
		"æ­¡å¤©å–œåœ°", "æ¨‚ä¸å¯æ”¯", "å¿ƒèŠ±æ€’æ”¾", "å–œå‡ºæœ›å¤–", "æ»¿å¿ƒæ­¡å–œ",

		// å‚·å¿ƒé›£é
		"å¿ƒæƒ…å¾ˆæ²®å–ª", "é›£éå¾—æƒ³å“­", "å‚·å¿ƒæ¬²çµ•", "ç—›è‹¦ä¸å ª", "å¿ƒç¢äº†",
		"çœ¼æ·šæ­¢ä¸ä½", "é¬±é¬±å¯¡æ­¡", "æ„çœ‰è‹¦è‡‰", "å‚é ­å–ªæ°£", "é»¯ç„¶ç¥å‚·",

		// æ†¤æ€’ç”Ÿæ°£
		"æ°£å¾—ç™¼æŠ–", "ç«å†’ä¸‰ä¸ˆ", "æ€’ä¸å¯é", "æ†¤æ†¤ä¸å¹³", "æš´è·³å¦‚é›·",
		"å’¬ç‰™åˆ‡é½’", "æ€’ç«ä¸­ç‡’", "æ°£æ€¥æ•—å£", "ç¾©æ†¤å¡«è†º", "å‹ƒç„¶å¤§æ€’",

		// ç„¦æ…®æ“”å¿ƒ
		"æ“”å¿ƒå¾—ç¡ä¸è‘—", "ç„¦æ…®ä¸å®‰", "åç«‹ä¸å®‰", "æ†‚å¿ƒå¿¡å¿¡", "æƒ¶æƒ¶ä¸å®‰",
		"å¿ƒç¥ä¸å¯§", "å¿å¿‘ä¸å®‰", "é©šæ…Œå¤±æª", "å¿ƒæ€¥å¦‚ç„š", "è†½æˆ°å¿ƒé©š",

		// é©šè¨æ„å¤–
		"å¤ªæ„å¤–äº†", "é©šè¨å¾—èªªä¸å‡ºè©±", "ç›®çªå£å‘†", "å¤§åƒä¸€é©š", "å§‹æ–™æœªåŠ",
		"å‡ºä¹æ„æ–™", "åŒªå¤·æ‰€æ€", "ä¸æ•¢ç½®ä¿¡", "éœ‡é©šä¸å·²", "å˜†ç‚ºè§€æ­¢",
	}

	// 3. ç¶²è·¯æµè¡Œèªæ¸¬è©¦ï¼ˆç¾ä»£ç”¨èªç¼ºå£ï¼‰
	internetSlang := []string{
		// å¹´è¼•ä¸–ä»£ç”¨èª
		"ã„…ã„¨ã„’ã„§ã„Ë‹", "ggäº†", "87åˆ†", "9487", "484", "Då¡", "Dcard",
		"ç¬‘æ­»", "è¶…è®š", "ç¥å™¨", "é–‹ç®±", "é¦–æ¨", "å¿…æ¨", "å·²è·ª", "è·ªäº†",
		"å¤ªå¼·", "å¨çŒ›", "éœ¸æ°£", "å¸¥ç‚¸", "ç¾ç¿»", "å¯æ„›çˆ†", "èŒç¿»",

		// ç¶²è·¯æ¢—åœ–ç”¨èª
		"ç¬‘ç¿»", "ç¬‘å°¿", "ç¬‘ç‚¸", "å¥½æ´¾", "å¾ˆå¯ä»¥", "å¯ä»¥çš„", "æ²’å•é¡Œ",
		"è¶…æ£’der", "å¥½å²å®³der", "çœŸçš„å‡çš„", "ä¸æœƒå§", "æ‰¯çˆ†",
		"å¤ªèª‡å¼µ", "è¶…æ‰¯", "èª‡å¼µæ¬¸", "å¥½å¥‡æ€ªå–”", "æ€ªæ€ªder",

		// è¡¨æƒ…ç¬¦è™Ÿæ–‡å­—åŒ–
		"QQ", "T_T", "orz", "å›§", "= =", "> <", "XD", "XDDD",
		"å“ˆå“ˆå“ˆ", "å—šå—šå—š", "å˜¿å˜¿å˜¿", "å‘µå‘µ", "å“‡å—š", "è€¶è€¶è€¶",

		// èªåŠ©è©
		"æ¬¸", "å•¦", "å•Š", "å–”", "å˜›", "è€¶", "å¼", "è›¤", "é¤’", "æ",
		"åš", "æ‹‰", "å’§", "å…§", "å‘¦", "å”·", "å–²", "å¶", "ã„‹ã„Ÿ",
	}

	// 4. éš±æ™¦æ€§æš—ç¤ºæ¸¬è©¦ï¼ˆå®¹æ˜“è¢«éºæ¼çš„L3-L4å…§å®¹ï¼‰
	subtleImplications := []string{
		// éš±æ™¦çš„è¦ªå¯†æš—ç¤º
		"æƒ³è¦æ›´é è¿‘ä½ ", "æƒ³å’Œä½ æ›´è¦ªå¯†", "æƒ³è¦èªè­˜çœŸæ­£çš„ä½ ", "æƒ³çœ‹åˆ°ä½ çš„å¦ä¸€é¢",
		"æƒ³å’Œä½ å–®ç¨ç›¸è™•", "æƒ³è¦ç§ä¸‹èŠèŠ", "æƒ³è¦æ·±åº¦äº¤æµ", "æƒ³äº†è§£ä½ çš„å…§å¿ƒ",
		"æƒ³è¦æ„Ÿå—ä½ çš„æº«åº¦", "æƒ³è¦ä½ çš„é™ªä¼´", "æƒ³è¦ä½ åœ¨èº«é‚Š", "æƒ³è¦ä½ çš„æ‡·æŠ±",

		// æ¨¡ç³Šçš„æ€§æš—ç¤º
		"æƒ³è¦å’Œä½ ç™¼ç”Ÿé»ä»€éº¼", "æƒ³è¦é«”é©—æ–°çš„æ„Ÿè¦º", "æƒ³è¦å˜—è©¦åˆºæ¿€çš„äº‹",
		"æƒ³è¦æ¢ç´¢å½¼æ­¤", "æƒ³è¦çªç ´ç•Œé™", "æƒ³è¦é‡‹æ”¾å£“åŠ›", "æƒ³è¦æ”¾é¬†èº«å¿ƒ",
		"æƒ³è¦æ„Ÿå—å¿«æ¨‚", "æƒ³è¦é”åˆ°å·”å³°", "æƒ³è¦å®Œå…¨æ”¾é–‹", "æƒ³è¦å¿˜æˆ‘å¢ƒç•Œ",

		// å§”å©‰è¡¨é”
		"æƒ³è¦é‚£å€‹", "æƒ³è¦åšé‚£ä»¶äº‹", "æƒ³è¦å®Œæˆæœ€å¾Œä¸€æ­¥", "æƒ³è¦æ°´åˆ°æ¸ æˆ",
		"æƒ³è¦ç“œç†Ÿè’‚è½", "æƒ³è¦è‡ªç„¶ç™¼ç”Ÿ", "æƒ³è¦é †å…¶è‡ªç„¶", "æƒ³è¦å¿ƒæ»¿æ„è¶³",
		"æƒ³è¦å¤©é›·å‹¾å‹•åœ°ç«", "æƒ³è¦ä¹¾æŸ´çƒˆç«", "æƒ³è¦å¦‚è† ä¼¼æ¼†", "æƒ³è¦é›£åˆ†é›£æ¨",
	}

	// 5. åŸ·è¡Œå¤§è¦æ¨¡æ¸¬è©¦
	testCategories := map[string][]string{
		"æ—¥å¸¸å°è©±": dailyConversations,
		"æƒ…æ„Ÿè¡¨é”": emotionalExpressions,
		"ç¶²è·¯ç”¨èª": internetSlang,
		"éš±æ™¦æš—ç¤º": subtleImplications,
	}

	totalTests := 0
	wrongClassifications := 0

	for category, tests := range testCategories {
		t.Logf("\n--- æ¸¬è©¦é¡åˆ¥: %s (%då€‹æ¡ˆä¾‹) ---", category, len(tests))
		categoryWrong := 0

		for i, testMsg := range tests {
			result, err := classifier.ClassifyContent(testMsg)
			if err != nil {
				t.Errorf("åˆ†é¡å¤±æ•—: %v", err)
				continue
			}

			totalTests++

			// åˆ¤æ–·æ˜¯å¦åˆ†é¡éŒ¯èª¤
			var expectedLevel int
			var isWrong bool

			switch category {
			case "æ—¥å¸¸å°è©±":
				expectedLevel = 1
				isWrong = result.Level > 1
			case "æƒ…æ„Ÿè¡¨é”":
				expectedLevel = 1
				isWrong = result.Level > 2 // å…è¨±æƒ…æ„Ÿè©å½™åˆ°L2
			case "ç¶²è·¯ç”¨èª":
				expectedLevel = 1
				isWrong = result.Level > 1
			case "éš±æ™¦æš—ç¤º":
				expectedLevel = 3 // é€™äº›æ‡‰è©²è¢«è­˜åˆ¥ç‚ºL3æˆ–ä»¥ä¸Š
				isWrong = result.Level < 3
			}

			if isWrong {
				wrongClassifications++
				categoryWrong++
				if categoryWrong <= 5 { // åªé¡¯ç¤ºå‰5å€‹éŒ¯èª¤
					t.Logf("  âŒ æ¡ˆä¾‹ %d: '%s'", i+1, testMsg)
					t.Logf("     é æœŸ: â‰¤L%d | å¯¦éš›: L%d | åŸå› : %s",
						expectedLevel, result.Level, result.Reason)
				}
			}
		}

		accuracy := float64(len(tests)-categoryWrong) / float64(len(tests)) * 100
		t.Logf("  %sæº–ç¢ºç‡: %d/%d (%.1f%%)", category, len(tests)-categoryWrong, len(tests), accuracy)
		if categoryWrong > 5 {
			t.Logf("  ï¼ˆé¡¯ç¤ºå‰5å€‹éŒ¯èª¤ï¼Œå¯¦éš›éŒ¯èª¤ %d å€‹ï¼‰", categoryWrong)
		}
	}

	// 6. åˆ†æçµæœ
	overallAccuracy := float64(totalTests-wrongClassifications) / float64(totalTests) * 100

	t.Logf("\n=== å¤§è¦æ¨¡æ¸¬è©¦çµæœ ===")
	t.Logf("ç¸½æ¸¬è©¦æ¡ˆä¾‹: %d", totalTests)
	t.Logf("éŒ¯èª¤åˆ†é¡: %d", wrongClassifications)
	t.Logf("æ•´é«”æº–ç¢ºç‡: %.1f%%", overallAccuracy)

	// ç²å–ç•¶å‰é—œéµå­—çµ±è¨ˆ
	info := classifier.GetClassifierInfo()
	if stats, ok := info["level_stats"].(map[int]int); ok {
		total := 0
		for _, count := range stats {
			total += count
		}
		t.Logf("ç•¶å‰é—œéµå­—ç¸½æ•¸: %d", total)
	}

	t.Logf("\n=== å•é¡Œåˆ†æ ===")
	if overallAccuracy < 85 {
		t.Logf("âš ï¸  æ•´é«”æº–ç¢ºç‡éä½ï¼")
	}

	t.Logf("ğŸ“ˆ è©å½™ç¼ºå£æ˜é¡¯ï¼Œå»ºè­°:")
	t.Logf("   1. æ“´å……æ—¥å¸¸è©å½™åº«åˆ° 2000+ å€‹ï¼ˆé˜²èª¤åˆ¤ï¼‰")
	t.Logf("   2. å¢åŠ ç¶²è·¯æµè¡Œèª 1000+ å€‹")
	t.Logf("   3. è£œå……æƒ…æ„Ÿè¡¨é”è©å½™ 1000+ å€‹")
	t.Logf("   4. å®Œå–„éš±æ™¦è¡¨é”è­˜åˆ¥ 500+ å€‹")
	t.Logf("   5. ç¸½ç›®æ¨™: 5000-10000 å€‹é—œéµå­—")

	if overallAccuracy < 90 {
		t.Errorf("æº–ç¢ºç‡ä¸è¶³ 90%%ï¼Œè­‰æ˜éœ€è¦å¤§å¹…æ“´å……é—œéµå­—åº«")
	}
}

// å£“åŠ›æ¸¬è©¦ï¼šéš¨æ©Ÿçµ„åˆè©å½™
func TestRandomCombinationStress(t *testing.T) {
	utils.InitLogger()
	utils.LoadEnv()

	t.Logf("=== éš¨æ©Ÿçµ„åˆå£“åŠ›æ¸¬è©¦ ===")

	classifier := services.NewEnhancedKeywordClassifier()

	// å¸¸è¦‹è©å½™æ± 
	words := []string{
		"æƒ³è¦", "å–œæ­¡", "æ„›", "æ„Ÿè¦º", "è¦ºå¾—", "èªç‚º", "å¸Œæœ›", "æœŸå¾…",
		"é–‹å¿ƒ", "å¿«æ¨‚", "é›£é", "å‚·å¿ƒ", "ç”Ÿæ°£", "æ†¤æ€’", "æ“”å¿ƒ", "ç„¦æ…®",
		"å·¥ä½œ", "å­¸ç¿’", "è®€æ›¸", "è€ƒè©¦", "ä¸Šç­", "ä¸‹ç­", "ä¼‘æ¯", "ç¡è¦º",
		"åƒé£¯", "å–æ°´", "é‹å‹•", "æ•£æ­¥", "è³¼ç‰©", "çœ‹é›»å½±", "è½éŸ³æ¨‚", "ç©éŠæˆ²",
		"æœ‹å‹", "å®¶äºº", "åŒäº‹", "è€å¸«", "å­¸ç”Ÿ", "é†«ç”Ÿ", "è­·å£«", "è­¦å¯Ÿ",
		"ä»Šå¤©", "æ˜å¤©", "æ˜¨å¤©", "ç¾åœ¨", "ä»¥å‰", "ä»¥å¾Œ", "æ—©ä¸Š", "æ™šä¸Š",
		"å¾ˆ", "éå¸¸", "ç‰¹åˆ¥", "è¶…ç´š", "çœŸçš„", "å¯¦åœ¨", "ç¢ºå¯¦", "ç•¶ç„¶",
		"å¯ä»¥", "èƒ½å¤ ", "æ‡‰è©²", "éœ€è¦", "å¿…é ˆ", "æƒ³", "è¦", "æœƒ",
	}

	rand.Seed(time.Now().UnixNano())
	successCount := 0
	totalTests := 200

	for i := 0; i < totalTests; i++ {
		// éš¨æ©Ÿçµ„åˆ2-4å€‹è©
		wordCount := rand.Intn(3) + 2 // 2-4å€‹è©
		var selectedWords []string

		for j := 0; j < wordCount; j++ {
			word := words[rand.Intn(len(words))]
			selectedWords = append(selectedWords, word)
		}

		testSentence := ""
		for k, word := range selectedWords {
			if k > 0 {
				testSentence += " "
			}
			testSentence += word
		}

		result, err := classifier.ClassifyContent(testSentence)
		if err != nil {
			t.Errorf("éš¨æ©Ÿæ¸¬è©¦å¤±æ•—: %v", err)
			continue
		}

		// é€™äº›éš¨æ©Ÿçµ„åˆæ‡‰è©²å¤§å¤šæ˜¯L1-L2
		if result.Level <= 2 {
			successCount++
		} else if i < 10 { // é¡¯ç¤ºå‰10å€‹é«˜ç­‰ç´šæ¡ˆä¾‹
			t.Logf("éš¨æ©Ÿæ¡ˆä¾‹ %d: '%s' â†’ L%d (%s)",
				i+1, testSentence, result.Level, result.Reason)
		}
	}

	accuracy := float64(successCount) / float64(totalTests) * 100
	t.Logf("éš¨æ©Ÿçµ„åˆæ¸¬è©¦: %d/%d (%.1f%%) è¢«æ­£ç¢ºåˆ†é¡ç‚ºä½ç­‰ç´š",
		successCount, totalTests, accuracy)

	if accuracy < 80 {
		t.Logf("âš ï¸  éš¨æ©Ÿçµ„åˆæº–ç¢ºç‡éä½ï¼Œèªªæ˜é—œéµå­—éæ–¼æ¿€é€²")
	}
}
