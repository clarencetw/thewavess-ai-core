# é—œä¿‚ç³»çµ±æŒ‡å—

## ç³»çµ±æ¦‚è¿°

æœ¬ç³»çµ±æ¡ç”¨**AIé©…å‹•çš„é—œä¿‚ç®¡ç†**ï¼Œé€éåˆ†æå°è©±å…§å®¹å³æ™‚æ›´æ–°ç”¨æˆ¶èˆ‡è§’è‰²ä¹‹é–“çš„äº’å‹•ç‹€æ…‹ã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ¨™
- **æ™ºèƒ½åŒ–**ï¼šAI è‡ªå‹•è©•ä¼°æƒ…æ„Ÿè®ŠåŒ–ï¼Œç„¡éœ€ç¡¬å¼è¦å‰‡
- **å€‹æ€§åŒ–**ï¼šä¾æ“šå°è©±æ­·å²èˆ‡è§’è‰²ç‰¹æ€§èª¿æ•´åæ‡‰
- **æŒä¹…åŒ–**ï¼šå®Œæ•´è¨˜éŒ„é—œä¿‚ç™¼å±•èˆ‡æƒ…æ„Ÿäº‹ä»¶
- **å¯è¿½æº¯**ï¼šæä¾›æ¸…æ¥šçš„æ­·å²ä¾†æºèˆ‡çµ±è¨ˆè³‡æ–™

## é—œä¿‚æ¨¡å‹

### ğŸ“Š æ ¸å¿ƒç¶­åº¦
- **å¥½æ„Ÿåº¦ (Affection)**ï¼š0-100 æ•¸å€¼ï¼Œåæ˜ æƒ…æ„Ÿè¦ªå¯†ç¨‹åº¦
- **å¿ƒæƒ…ç‹€æ…‹ (Mood)**ï¼šç•¶å‰æƒ…ç·’é¡å‹ï¼ˆhappyã€sadã€excitedâ€¦ï¼‰
- **é—œä¿‚é¡å‹ (Relationship)**ï¼šé—œä¿‚çš„èªæ„æè¿°
- **è¦ªå¯†ç­‰ç´š (Intimacy Level)**ï¼šäº’å‹•çš„æ·±åº¦å±¤ç´š

### ğŸ­ é—œä¿‚ç­‰ç´šç³»çµ±
| å¥½æ„Ÿåº¦ç¯„åœ | é—œä¿‚é¡å‹ | è¦ªå¯†ç­‰ç´š | ç‰¹å¾µæè¿° |
| ---------- | -------- | -------- | -------- |
| 0-19       | stranger | distant  | åˆæ¬¡è¦‹é¢ï¼Œç¶­æŒç¦®è²Œè·é›¢ |
| 20-39      | friend   | casual   | æ™®é€šæœ‹å‹ï¼Œè¼•é¬†å°è©± |
| 40-59      | friend   | casual   | å¥½æœ‹å‹ï¼Œç›¸äº’ä¿¡ä»» |
| 60-79      | close    | close    | è¦ªå¯†æœ‹å‹ï¼Œèƒ½é€²è¡Œæ·±åº¦äº¤æµ |
| 80-89      | intimate | intimate | æˆ€äººé—œä¿‚ï¼Œæƒ…æ„Ÿæ·±åš |
| 90-100     | soulmate | intimate | éˆé­‚ä¼´ä¾¶ï¼Œå¿ƒéˆç›¸é€š |

## æ•¸æ“šåº«æ¶æ§‹

### ğŸ—„ï¸ Relationships è¡¨çµæ§‹
```sql
relationships:
â”œâ”€â”€ id (string, PK)
â”œâ”€â”€ user_id (string, FK)
â”œâ”€â”€ character_id (string, FK)
â”œâ”€â”€ chat_id (string, FK, å¯é¸)
â”œâ”€â”€ affection (int)
â”œâ”€â”€ mood (string)
â”œâ”€â”€ relationship (string)
â”œâ”€â”€ intimacy_level (string)
â”œâ”€â”€ total_interactions (int)
â”œâ”€â”€ last_interaction (timestamp)
â”œâ”€â”€ emotion_data (jsonb)
â”œâ”€â”€ created_at (timestamp)
â””â”€â”€ updated_at (timestamp)
```

### ğŸ“ æƒ…æ„Ÿæ­·å² (emotion_data)
```json
{
  "history": [
    {
      "timestamp": "2025-09-01T18:00:00Z",
      "trigger_type": "user_message",
      "trigger_content": "ç”¨æˆ¶è¡¨é”é—œå¿ƒ",
      "old_affection": 45,
      "new_affection": 48,
      "affection_change": 3,
      "old_mood": "neutral",
      "new_mood": "happy"
    }
  ]
}
```

## API ç«¯é»

### `GET /api/v1/relationships/chat/{chat_id}/status`
- **ç”¨é€”**ï¼šå–å¾—æŒ‡å®šå°è©±çš„å³æ™‚é—œä¿‚ç‹€æ…‹
- **ä¸»è¦æ¬„ä½**ï¼š`user_id`, `character_id`, `chat_id`, `affection`, `mood`, `mood_intensity`, `mood_description`, `relationship`, `intimacy_level`, `total_interactions`, `last_interaction_at`, `updated_at`
- **è³‡æ–™ä¾†æº**ï¼šç›´æ¥ä½¿ç”¨ `relationships` è¡¨ä¸­çš„å³æ™‚æ•¸æ“š

### `GET /api/v1/relationships/chat/{chat_id}/affection`
- **ç”¨é€”**ï¼šæª¢è¦–å¥½æ„Ÿåº¦ç´°ç¯€èˆ‡å‡ç´šé€²åº¦
- **ä¸»è¦æ¬„ä½**ï¼š`current`, `level_name`, `level_tier`, `description`, `next_level_threshold`, `points_to_next`, `updated_at`
- **è¨ˆç®—æ–¹å¼**ï¼šä¾æ“š affection æ•¸å€¼è¨ˆç®—ç­‰ç´šèˆ‡ä¸‹ä¸€é–€æª»ï¼Œç§»é™¤ä»»ä½•ç¡¬ç·¨ç¢¼æˆ–å‡è³‡æ–™

### `GET /api/v1/relationships/chat/{chat_id}/history`
- **ç”¨é€”**ï¼šå›é¡§æƒ…æ„Ÿè®ŠåŒ–è»Œè·¡
- **ä¸»è¦æ¬„ä½**ï¼š`current_affection`, `total_interactions`, `history[]`
  - æ¯ç­†æ­·å²ç´€éŒ„åŒ…å«ï¼š`timestamp`, `trigger_type`, `trigger_content`, `affection_before`, `affection_after`, `affection_change`, `mood_before`, `mood_after`
- **æ•¸æ“šä¾†æº**ï¼šå¾ `emotion_data.history` è®€å–çœŸå¯¦ JSONB ç´€éŒ„ï¼›è‹¥ç„¡æ­·å²è³‡æ–™å‰‡å›å‚³ç©ºé™£åˆ—

## ç³»çµ±ç‰¹è‰²

### âœ¨ æ™ºèƒ½ç‰¹æ€§
1. **å‹•æ…‹é©æ‡‰**ï¼šçµåˆ AI åˆ†æèˆ‡æ­·å²è³‡æ–™èª¿æ•´åæ‡‰
2. **å€‹äººåŒ–åæ‡‰**ï¼šä¸åŒè§’è‰²å…·å‚™å°ˆå±¬æƒ…ç·’èˆ‡å¥½æ„Ÿåº¦æ›²ç·š
3. **è‡ªç„¶é€²å±•**ï¼šé¿å…å›ºå®šè…³æœ¬ï¼Œè¿½æ±‚è²¼è¿‘çœŸäººäº’å‹•
4. **æƒ…æ„Ÿè¨˜æ†¶**ï¼šé‡è¦äº‹ä»¶æœƒè¢«å¯«å…¥ `emotion_data` ä»¥ä¾›å¾ŒçºŒåƒè€ƒ

### ğŸ”„ å¤šæœƒè©±æ”¯æ´
- æ¯å€‹ `chat_id` æ“æœ‰ç¨ç«‹çš„é—œä¿‚ç‹€æ…‹
- å¦‚éœ€è·¨æœƒè©±å…±äº«ï¼Œå¯ä½¿ç”¨ `chat_id IS NULL` çš„å…¨å±€ç´€éŒ„

### ğŸ“Š æ•¸æ“šæ´å¯Ÿ
- é€éæ­·å²ç´€éŒ„æŒæ¡å¥½æ„Ÿåº¦è®ŠåŒ–èˆ‡è§¸ç™¼å› ç´ 
- åˆ©ç”¨ `total_interactions` èˆ‡ `last_interaction_at` è¿½è¹¤äº’å‹•é »ç‡

## æ€§èƒ½èˆ‡ç›£æ§

- **JSONB ç´¢å¼•**ï¼šç¢ºä¿ emotion_data æŸ¥è©¢æ•ˆç‡
- **æ‰¹æ¬¡æ›´æ–°**ï¼šåœ¨è¨Šæ¯è™•ç†æµç¨‹ä¸­ä¸€æ¬¡æ›´æ–° affectionã€moodã€relationship ç­‰æ¬„ä½
- **å¿«ç…§å¼å›æ‡‰**ï¼šæ‰€æœ‰ handler ç«‹å³è¿”å›è³‡æ–™åº«ä¸­çš„çœŸå¯¦æ•¸æ“š

## å¯¦ä½œé‡é»

- æ”¹æ¡**å‹åˆ¥åŒ–çš„å›æ‡‰çµæ§‹**ï¼Œç§»é™¤åŸå…ˆçš„å‹•æ…‹ Map èˆ‡å‡è³‡æ–™æ¬„ä½
- ç›´æ¥ä½¿ç”¨è³‡æ–™åº«æ¬„ä½ï¼Œé¿å…ç¡¬ç·¨ç¢¼æè¿°æˆ–è‡¨æ™‚çµ±è¨ˆ
- æ­·å²ç«¯é»åƒ…åœ¨ emotion_data æœ‰è³‡æ–™æ™‚å›å‚³äº‹ä»¶ï¼Œç¶­æŒè³‡æ–™å¯ä¿¡åº¦
- æ‰€æœ‰æ™‚é–“æ¬„ä½çµ±ä¸€è¼¸å‡º ISO 8601ï¼ˆRFC3339ï¼‰æ ¼å¼

---

*é—œä¿‚ç³»çµ±é€é AI èˆ‡è³‡æ–™åº«çš„ç·Šå¯†æ•´åˆï¼Œæä¾›è‡ªç„¶ä¸”å¯è¿½è¹¤çš„äº’å‹•é«”é©—ã€‚*
