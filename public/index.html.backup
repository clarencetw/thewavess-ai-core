<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thewavess AI Core - API æ¸¬è©¦ç•Œé¢</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; background: #f5f5f5; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tabs { display: flex; background: white; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab { padding: 15px 25px; cursor: pointer; border: none; background: #f8f9fa; flex: 1; text-align: center; transition: all 0.3s; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { background: white; padding: 20px; border-radius: 8px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        
        /* Chat Interface */
        .chat-container { 
            border: 1px solid #ddd; height: 400px; overflow-y: auto; 
            padding: 15px; margin: 20px 0; background: #fafafa; border-radius: 8px;
        }
        .message { margin: 10px 0; padding: 12px; border-radius: 12px; max-width: 80%; }
        .user-message { background: #007bff; color: white; margin-left: auto; }
        .ai-message { background: white; border: 1px solid #e0e0e0; }
        .scene-description { background: #e8f5e8; font-style: italic; margin: 5px 0; padding: 8px; border-radius: 6px; border-left: 3px solid #4caf50; }
        .character-action { color: #666; font-size: 14px; margin-top: 5px; padding: 4px 8px; background: #f0f0f0; border-radius: 4px; }
        .emotion-state { font-size: 12px; color: #888; margin-top: 8px; padding: 4px; background: #fff3cd; border-radius: 4px; }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 14px; transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #007bff; }
        button { 
            padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; 
            cursor: pointer; font-size: 14px; transition: all 0.3s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        /* Status */
        .status { margin: 10px 0; padding: 12px; border-radius: 6px; border-left: 4px solid; }
        .status.success { background: #d4edda; color: #155724; border-color: #28a745; }
        .status.error { background: #f8d7da; color: #721c24; border-color: #dc3545; }
        .status.info { background: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
        
        /* Response Display */
        .response-box { 
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; 
            padding: 15px; margin: 10px 0; font-family: monospace; font-size: 13px;
            max-height: 300px; overflow-y: auto;
        }
        
        /* Session Management */
        .session-list { margin: 15px 0; }
        .session-item { 
            background: white; border: 1px solid #dee2e6; border-radius: 6px; 
            padding: 15px; margin: 10px 0; cursor: pointer; transition: all 0.3s;
        }
        .session-item:hover { border-color: #007bff; box-shadow: 0 2px 4px rgba(0,123,255,0.1); }
        .session-item.active { border-color: #007bff; background: #f8f9ff; }
        .session-title { font-weight: 500; color: #333; }
        .session-meta { font-size: 12px; color: #666; margin-top: 5px; }
        
        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Thewavess AI Core - å®Œæ•´åŠŸèƒ½æ¸¬è©¦</h1>
            <p>åŸºæ–¼çœŸå¯¦ API çš„å®Œæ•´åŠŸèƒ½æ¸¬è©¦ç•Œé¢ï¼Œæ‰€æœ‰æ•¸æ“šä¾†è‡ªå¾Œç«¯ API</p>
            <div id="globalStatus" class="status"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('session')">æœƒè©±ç®¡ç†</button>
            <button class="tab" onclick="switchTab('chat')">å°è©±æ¸¬è©¦</button>
            <button class="tab" onclick="switchTab('user')">ç”¨æˆ¶åŠŸèƒ½</button>
            <button class="tab" onclick="switchTab('character')">è§’è‰²ç³»çµ±</button>
        </div>

        <!-- æœƒè©±ç®¡ç† -->
        <div id="sessionTab" class="tab-content active">
            <h2>ğŸ“ æœƒè©±ç®¡ç†</h2>
            <div class="grid">
                <div>
                    <h3>å‰µå»ºæ–°æœƒè©±</h3>
                    <div class="form-group">
                        <label>è§’è‰²é¸æ“‡</label>
                        <select id="characterSelect">
                            <option value="">é¸æ“‡è§’è‰²...</option>
                            <option value="char_001">é™¸å¯’æ·µ (éœ¸é“ç¸½è£)</option>
                            <option value="char_002">æ²ˆè¨€å¢¨ (æº«æŸ”é†«ç”Ÿ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœƒè©±æ¨™é¡Œ</label>
                        <input type="text" id="sessionTitle" placeholder="è¼¸å…¥æœƒè©±æ¨™é¡Œ">
                    </div>
                    <div class="form-group">
                        <label>å°è©±æ¨¡å¼</label>
                        <select id="sessionMode">
                            <option value="normal">æ™®é€šæ¨¡å¼</option>
                            <option value="novel">å°èªªæ¨¡å¼</option>
                            <option value="nsfw">æˆäººæ¨¡å¼</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="createSession()">å‰µå»ºæœƒè©±</button>
                </div>
                
                <div>
                    <h3>æˆ‘çš„æœƒè©±åˆ—è¡¨</h3>
                    <button class="btn-secondary" onclick="loadSessions()">åˆ·æ–°åˆ—è¡¨</button>
                    <div id="sessionList" class="session-list"></div>
                </div>
            </div>
            
            <div class="full-width">
                <h3>æœƒè©±æ“ä½œ</h3>
                <div class="grid">
                    <div>
                        <button class="btn-secondary" onclick="switchMode()">åˆ‡æ›æ¨¡å¼</button>
                        <button class="btn-success" onclick="addTags()">æ·»åŠ æ¨™ç±¤</button>
                        <button class="btn-primary" onclick="exportSession()">åŒ¯å‡ºæœƒè©±</button>
                    </div>
                    <div>
                        <button class="btn-danger" onclick="deleteSession()">åˆªé™¤æœƒè©±</button>
                        <input type="text" id="selectedSession" placeholder="ç•¶å‰é¸ä¸­æœƒè©± ID" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- å°è©±æ¸¬è©¦ -->
        <div id="chatTab" class="tab-content">
            <h2>ğŸ’¬ å°è©±æ¸¬è©¦</h2>
            <div id="chatStatus" class="status info">è«‹å…ˆåœ¨æœƒè©±ç®¡ç†ä¸­å‰µå»ºæˆ–é¸æ“‡ä¸€å€‹æœƒè©±</div>
            
            <div class="chat-container" id="chatContainer">
                <div class="message ai-message">
                    <div>ğŸ¤– è«‹å…ˆå‰µå»ºæˆ–é¸æ“‡ä¸€å€‹æœƒè©±é–‹å§‹å°è©±</div>
                </div>
            </div>
            
            <div class="grid">
                <div>
                    <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleKeyPress(event)">
                    <button class="btn-primary" onclick="sendMessage()">ç™¼é€</button>
                    <button class="btn-secondary" onclick="regenerateMessage()">é‡æ–°ç”Ÿæˆ</button>
                </div>
                <div>
                    <button class="btn-success" onclick="loadHistory()">è¼‰å…¥æ­·å²</button>
                    <button class="btn-danger" onclick="clearChat()">æ¸…ç©ºé¡¯ç¤º</button>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶åŠŸèƒ½ -->
        <div id="userTab" class="tab-content">
            <h2>ğŸ‘¤ ç”¨æˆ¶åŠŸèƒ½æ¸¬è©¦</h2>
            <div class="grid">
                <div>
                    <h3>ç”¨æˆ¶è¨»å†Š</h3>
                    <div class="form-group">
                        <input type="text" id="regUsername" placeholder="ç”¨æˆ¶å">
                    </div>
                    <div class="form-group">
                        <input type="email" id="regEmail" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <input type="password" id="regPassword" placeholder="å¯†ç¢¼">
                    </div>
                    <div class="form-group">
                        <input type="date" id="regBirthDate">
                    </div>
                    <div class="form-group">
                        <select id="regGender">
                            <option value="female">å¥³</option>
                            <option value="male">ç”·</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="registerUser()">è¨»å†Šç”¨æˆ¶</button>
                </div>
                
                <div>
                    <h3>ç”¨æˆ¶ç™»å…¥</h3>
                    <div class="form-group">
                        <input type="text" id="loginUsername" placeholder="ç”¨æˆ¶å">
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPassword" placeholder="å¯†ç¢¼">
                    </div>
                    <button class="btn-success" onclick="loginUser()">ç™»å…¥</button>
                    <button class="btn-secondary" onclick="getProfile()">ç²å–è³‡æ–™</button>
                </div>
            </div>
            
            <div class="response-box" id="userResponse"></div>
        </div>

        <!-- è§’è‰²ç³»çµ± -->
        <div id="characterTab" class="tab-content">
            <h2>ğŸ­ è§’è‰²ç³»çµ±</h2>
            <button class="btn-primary" onclick="loadCharacters()">è¼‰å…¥è§’è‰²åˆ—è¡¨</button>
            <div id="characterList"></div>
            <div class="response-box" id="characterResponse"></div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let currentSessionId = null;
        let currentToken = 'Bearer demo_token_12345678901234567890'; // æ¸¬è©¦ç”¨ token
        let lastMessageId = null;

        // é é¢åˆå§‹åŒ–
        window.onload = function() {
            showGlobalStatus('ğŸš€ API æ¸¬è©¦ç•Œé¢å·²è¼‰å…¥ï¼Œæ‰€æœ‰åŠŸèƒ½åŸºæ–¼çœŸå¯¦ API', 'info');
            loadSessions();
            loadCharacters();
        };

        // Tab åˆ‡æ›
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // ç‹€æ…‹é¡¯ç¤º
        function showGlobalStatus(message, type) {
            const status = document.getElementById('globalStatus');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = 'status ' + type;
            }
        }

        // ========== æœƒè©±ç®¡ç†åŠŸèƒ½ ==========
        
        async function createSession() {
            const characterId = document.getElementById('characterSelect').value;
            const title = document.getElementById('sessionTitle').value;
            const mode = document.getElementById('sessionMode').value;

            if (!characterId) {
                showGlobalStatus('âŒ è«‹é¸æ“‡è§’è‰²', 'error');
                return;
            }

            try {
                const response = await fetch('/api/v1/chat/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentToken
                    },
                    body: JSON.stringify({
                        character_id: characterId,
                        title: title || 'æ–°å°è©±',
                        mode: mode,
                        tags: ['æ¸¬è©¦', 'API']
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentSessionId = data.data.id;
                    document.getElementById('selectedSession').value = currentSessionId;
                    showGlobalStatus('âœ… æœƒè©±å‰µå»ºæˆåŠŸ: ' + data.data.title, 'success');
                    loadSessions(); // åˆ·æ–°åˆ—è¡¨
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('sessionTitle').value = '';
                } else {
                    showGlobalStatus('âŒ å‰µå»ºå¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/v1/chat/sessions?limit=10', {
                    headers: { 'Authorization': currentToken }
                });

                const data = await response.json();
                if (data.success) {
                    displaySessions(data.data.sessions, data.data.summary);
                } else {
                    showGlobalStatus('âŒ è¼‰å…¥æœƒè©±å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ è¼‰å…¥æœƒè©±ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        function displaySessions(sessions, summary) {
            const list = document.getElementById('sessionList');
            if (!sessions || sessions.length === 0) {
                list.innerHTML = '<div class="session-item">æš«ç„¡æœƒè©±ï¼Œè«‹å‰µå»ºæ–°æœƒè©±</div>';
                return;
            }

            let html = `<div style="padding: 10px; background: #e9ecef; border-radius: 4px; margin-bottom: 10px;">
                ç¸½è¨ˆ: ${sessions.length} å€‹æœƒè©± | æ´»èº: ${summary?.active_count || 0} | ç¸½è¨Šæ¯: ${summary?.total_messages || 0}
            </div>`;

            sessions.forEach(session => {
                const isActive = session.id === currentSessionId;
                html += `
                    <div class="session-item ${isActive ? 'active' : ''}" onclick="selectSession('${session.id}')">
                        <div class="session-title">${session.title}</div>
                        <div class="session-meta">
                            ID: ${session.id} | æ¨¡å¼: ${session.mode} | è¨Šæ¯: ${session.message_count} | ç‹€æ…‹: ${session.status}
                            <br>è§’è‰²: ${session.character_id} | æ¨™ç±¤: ${session.tags.join(', ')}
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        function selectSession(sessionId) {
            currentSessionId = sessionId;
            document.getElementById('selectedSession').value = sessionId;
            showGlobalStatus('âœ… å·²é¸æ“‡æœƒè©±: ' + sessionId, 'success');
            
            // åˆ·æ–°æœƒè©±åˆ—è¡¨é¡¯ç¤º
            loadSessions();
            
            // æ›´æ–°èŠå¤©ç‹€æ…‹
            showStatus('chatStatus', 'ç•¶å‰æœƒè©±: ' + sessionId, 'info');
            
            // è¼‰å…¥è©²æœƒè©±çš„æ­·å²
            loadHistory();
        }

        async function switchMode() {
            if (!currentSessionId) {
                showGlobalStatus('âŒ è«‹å…ˆé¸æ“‡æœƒè©±', 'error');
                return;
            }

            const newMode = prompt('è¼¸å…¥æ–°æ¨¡å¼ (normal/novel/nsfw):', 'normal');
            if (!newMode) return;

            try {
                const response = await fetch(`/api/v1/chat/session/${currentSessionId}/mode`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentToken
                    },
                    body: JSON.stringify({
                        mode: newMode,
                        transition_message: `åˆ‡æ›åˆ°${newMode}æ¨¡å¼`
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showGlobalStatus('âœ… æ¨¡å¼åˆ‡æ›æˆåŠŸ: ' + newMode, 'success');
                    loadSessions(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showGlobalStatus('âŒ æ¨¡å¼åˆ‡æ›å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ æ¨¡å¼åˆ‡æ›ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function addTags() {
            if (!currentSessionId) {
                showGlobalStatus('âŒ è«‹å…ˆé¸æ“‡æœƒè©±', 'error');
                return;
            }

            const tags = prompt('è¼¸å…¥æ¨™ç±¤ (ç”¨é€—è™Ÿåˆ†éš”):', 'æ¸¬è©¦,API');
            if (!tags) return;

            try {
                const response = await fetch(`/api/v1/chat/session/${currentSessionId}/tag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentToken
                    },
                    body: JSON.stringify({
                        tags: tags.split(',').map(t => t.trim())
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showGlobalStatus('âœ… æ¨™ç±¤æ·»åŠ æˆåŠŸ', 'success');
                    loadSessions(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showGlobalStatus('âŒ æ¨™ç±¤æ·»åŠ å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ æ¨™ç±¤æ·»åŠ ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function exportSession() {
            if (!currentSessionId) {
                showGlobalStatus('âŒ è«‹å…ˆé¸æ“‡æœƒè©±', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/v1/chat/session/${currentSessionId}/export`, {
                    headers: { 'Authorization': currentToken }
                });

                const data = await response.json();
                if (data.success) {
                    // ä¸‹è¼‰ JSON æ–‡ä»¶
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat_${currentSessionId}_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showGlobalStatus('âœ… æœƒè©±åŒ¯å‡ºæˆåŠŸ', 'success');
                } else {
                    showGlobalStatus('âŒ æœƒè©±åŒ¯å‡ºå¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ æœƒè©±åŒ¯å‡ºç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function deleteSession() {
            if (!currentSessionId) {
                showGlobalStatus('âŒ è«‹å…ˆé¸æ“‡æœƒè©±', 'error');
                return;
            }

            if (!confirm('ç¢ºå®šè¦åˆªé™¤æœƒè©± ' + currentSessionId + ' å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/chat/session/${currentSessionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer demo_token' } // ä½¿ç”¨æ­£ç¢ºçš„çŸ­ token
                });

                const data = await response.json();
                if (data.success) {
                    showGlobalStatus('âœ… æœƒè©±åˆªé™¤æˆåŠŸ', 'success');
                    currentSessionId = null;
                    document.getElementById('selectedSession').value = '';
                    loadSessions(); // åˆ·æ–°åˆ—è¡¨
                    clearChat();
                } else {
                    showGlobalStatus('âŒ æœƒè©±åˆªé™¤å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ æœƒè©±åˆªé™¤ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // ========== å°è©±åŠŸèƒ½ ==========

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            if (!currentSessionId) {
                showGlobalStatus('âŒ è«‹å…ˆé¸æ“‡æœƒè©±', 'error');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            addUserMessage(message);
            input.value = '';

            try {
                const response = await fetch('/api/v1/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentToken
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addAIMessage(data.data);
                    lastMessageId = data.data.message_id;
                    showGlobalStatus('âœ… è¨Šæ¯ç™¼é€æˆåŠŸ', 'success');
                } else {
                    showGlobalStatus('âŒ è¨Šæ¯ç™¼é€å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ è¨Šæ¯ç™¼é€ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function regenerateMessage() {
            if (!lastMessageId) {
                showGlobalStatus('âŒ æ²’æœ‰å¯é‡æ–°ç”Ÿæˆçš„è¨Šæ¯', 'error');
                return;
            }

            try {
                const response = await fetch('/api/v1/chat/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentToken
                    },
                    body: JSON.stringify({
                        message_id: lastMessageId,
                        regeneration_reason: 'tone'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addAIMessage(data.data, true);
                    showGlobalStatus('âœ… è¨Šæ¯é‡æ–°ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    showGlobalStatus('âŒ è¨Šæ¯é‡æ–°ç”Ÿæˆå¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ è¨Šæ¯é‡æ–°ç”Ÿæˆç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function loadHistory() {
            if (!currentSessionId) return;

            try {
                const response = await fetch(`/api/v1/chat/session/${currentSessionId}/history?limit=20`, {
                    headers: { 'Authorization': currentToken }
                });

                const data = await response.json();
                if (data.success) {
                    displayHistory(data.data.messages);
                    showStatus('chatStatus', `å·²è¼‰å…¥ ${data.data.messages.length} æ¢æ­·å²è¨Šæ¯`, 'info');
                } else {
                    showGlobalStatus('âŒ è¼‰å…¥æ­·å²å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ è¼‰å…¥æ­·å²ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        function displayHistory(messages) {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';

            if (!messages || messages.length === 0) {
                chatContainer.innerHTML = '<div class="message ai-message"><div>æš«ç„¡æ­·å²è¨Šæ¯ï¼Œé–‹å§‹æ–°å°è©±å§ï¼</div></div>';
                return;
            }

            messages.forEach(msg => {
                if (msg.role === 'user') {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message user-message';
                    messageDiv.innerHTML = `<div><strong>ä½ ï¼š</strong>${escapeHtml(msg.content)}</div>`;
                    chatContainer.appendChild(messageDiv);
                } else if (msg.role === 'assistant') {
                    const messageData = {
                        scene_description: msg.scene_description,
                        character_response: { message: msg.content },
                        character_action: msg.character_action,
                        emotional_state: msg.emotional_state || {}
                    };
                    addAIMessage(messageData);
                }
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `<div><strong>ä½ ï¼š</strong>${escapeHtml(message)}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addAIMessage(data, isRegenerated = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            let html = '';
            
            if (isRegenerated) {
                html += '<div style="color: #ff6b6b; font-size: 12px; margin-bottom: 5px;">ğŸ”„ é‡æ–°ç”Ÿæˆ</div>';
            }
            
            // å ´æ™¯æè¿°
            if (data.scene_description) {
                html += `<div class="scene-description">${escapeHtml(data.scene_description)}</div>`;
            }
            
            // è§’è‰²å°è©±
            const characterName = currentSessionId && currentSessionId.includes('char_002') ? 'æ²ˆè¨€å¢¨' : 'é™¸å¯’æ·µ';
            html += `<div><strong>${characterName}ï¼š</strong>${escapeHtml(data.character_response.message)}</div>`;
            
            // è§’è‰²å‹•ä½œ
            if (data.character_action) {
                html += `<div class="character-action">${escapeHtml(data.character_action)}</div>`;
            }
            
            // æƒ…æ„Ÿç‹€æ…‹
            if (data.emotional_state) {
                const emotion = data.emotional_state;
                html += `<div class="emotion-state">
                    å¥½æ„Ÿåº¦: ${emotion.affection || 50} | 
                    é—œä¿‚: ${emotion.relationship || 'friend'} | 
                    å¿ƒæƒ…: ${emotion.mood || 'neutral'}
                    ${emotion.intimacy_level ? ' | è¦ªå¯†åº¦: ' + emotion.intimacy_level : ''}
                </div>`;
            }
            
            messageDiv.innerHTML = html;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '<div class="message ai-message"><div>å°è©±å·²æ¸…ç©ºï¼Œè¼¸å…¥è¨Šæ¯é–‹å§‹æ–°å°è©±</div></div>';
            lastMessageId = null;
        }

        // ========== ç”¨æˆ¶åŠŸèƒ½ ==========

        async function registerUser() {
            const userData = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                birth_date: document.getElementById('regBirthDate').value,
                gender: document.getElementById('regGender').value,
                nickname: document.getElementById('regUsername').value + 'æ¸¬è©¦'
            };

            if (!userData.username || !userData.email || !userData.password || !userData.birth_date) {
                showGlobalStatus('âŒ è«‹å¡«å¯«æ‰€æœ‰å¿…è¦ä¿¡æ¯', 'error');
                return;
            }

            try {
                const response = await fetch('/api/v1/user/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                const responseBox = document.getElementById('userResponse');
                responseBox.textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    showGlobalStatus('âœ… ç”¨æˆ¶è¨»å†ŠæˆåŠŸ', 'success');
                    // å¯ä»¥ä¿å­˜ token
                    if (data.data?.access_token) {
                        currentToken = 'Bearer ' + data.data.access_token;
                    }
                } else {
                    showGlobalStatus('âŒ ç”¨æˆ¶è¨»å†Šå¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ è¨»å†Šç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function loginUser() {
            const loginData = {
                username: document.getElementById('loginUsername').value,
                password: document.getElementById('loginPassword').value
            };

            if (!loginData.username || !loginData.password) {
                showGlobalStatus('âŒ è«‹è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼', 'error');
                return;
            }

            try {
                const response = await fetch('/api/v1/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData)
                });

                const data = await response.json();
                const responseBox = document.getElementById('userResponse');
                responseBox.textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    showGlobalStatus('âœ… ç™»å…¥æˆåŠŸ', 'success');
                    if (data.data?.access_token) {
                        currentToken = 'Bearer ' + data.data.access_token;
                    }
                } else {
                    showGlobalStatus('âŒ ç™»å…¥å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ ç™»å…¥ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        async function getProfile() {
            try {
                const response = await fetch('/api/v1/user/profile', {
                    headers: { 'Authorization': currentToken }
                });

                const data = await response.json();
                const responseBox = document.getElementById('userResponse');
                responseBox.textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    showGlobalStatus('âœ… ç²å–ç”¨æˆ¶è³‡æ–™æˆåŠŸ', 'success');
                } else {
                    showGlobalStatus('âŒ ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ ç²å–ç”¨æˆ¶è³‡æ–™ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // ========== è§’è‰²åŠŸèƒ½ ==========

        async function loadCharacters() {
            try {
                const response = await fetch('/api/v1/character/list?limit=10', {
                    headers: { 'Authorization': currentToken }
                });

                const data = await response.json();
                if (data.success) {
                    displayCharacters(data.data.characters);
                    document.getElementById('characterResponse').textContent = JSON.stringify(data, null, 2);
                } else {
                    showGlobalStatus('âŒ è¼‰å…¥è§’è‰²å¤±æ•—: ' + (data.error?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showGlobalStatus('âŒ è¼‰å…¥è§’è‰²ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }

        function displayCharacters(characters) {
            const list = document.getElementById('characterList');
            if (!characters || characters.length === 0) {
                list.innerHTML = '<div>æš«ç„¡è§’è‰²æ•¸æ“š</div>';
                return;
            }

            let html = '';
            characters.forEach(char => {
                html += `
                    <div class="session-item">
                        <div class="session-title">${char.name} (${char.type})</div>
                        <div class="session-meta">
                            ID: ${char.id} | äººæ°£: ${char.popularity} | æè¿°: ${char.description}
                            <br>æ¨™ç±¤: ${char.tags.join(', ')}
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        // å·¥å…·å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>