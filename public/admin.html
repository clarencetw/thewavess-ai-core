<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統管理 - Thewavess AI</title>
    
    <!-- Tailwind CSS 3.4.17 -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-tw.min.js"></script>
    
    <style>
        /* 簡約按鈕樣式 */
        .btn-simple {
            @apply px-3 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 transition-colors;
        }
        .btn-primary {
            @apply px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors;
        }
        .btn-danger {
            @apply px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors;
        }
        
        /* 簡約卡片樣式 */
        .card-minimal {
            @apply bg-white border border-gray-200 rounded-lg;
        }
        
        /* 載入動畫 */
        .loading {
            @apply inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin mr-2;
        }
        
        /* 狀態指示器 */
        .status-healthy {
            @apply w-3 h-3 bg-green-500 rounded-full;
        }
        .status-warning {
            @apply w-3 h-3 bg-yellow-500 rounded-full;
        }
        .status-error {
            @apply w-3 h-3 bg-red-500 rounded-full;
        }
    </style>
    
    <!-- Flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</head>
<body class="h-full flex flex-col bg-white text-gray-900">
    <!-- 簡化的頂部導航 -->
    <nav class="border-b border-gray-200 p-3 md:p-4 flex-shrink-0">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center space-x-2 md:space-x-4">
                <button 
                    class="btn-simple text-sm md:text-base"
                    onclick="Router.navigate('/')"
                >
                    ← 返回
                </button>
                
                <div>
                    <h1 class="text-lg md:text-xl font-medium">系統管理</h1>
                    <div class="text-xs md:text-sm text-gray-500">統計、監控、用戶管理</div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 text-sm">
                    <div class="status-healthy" id="healthIndicator"></div>
                    <span id="systemHealth" class="text-sm font-medium">檢查中...</span>
                </div>
                <button class="btn-simple" onclick="refreshAllData()">
                    <i class="fas fa-sync mr-1"></i>
                    刷新
                </button>
            </div>
        </div>
    </nav>

    <!-- Toast 容器 -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2 md:top-5 md:right-5 sm:top-4 sm:right-4 sm:left-4 sm:right-auto sm:max-w-sm"></div>
    <!-- 主內容區 -->
    <div class="flex-1 overflow-auto p-3 md:p-4">
        <div class="max-w-7xl mx-auto space-y-4 md:space-y-6">
            
            <!-- 系統概覽 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- 總用戶數 -->
                <div class="card-minimal p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">總用戶數</div>
                            <div class="text-lg font-medium" id="totalUsers">-</div>
                        </div>
                        <i class="fas fa-users text-blue-500"></i>
                    </div>
                </div>
                
                <!-- 今日訪問 -->
                <div class="card-minimal p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">今日訪問</div>
                            <div class="text-lg font-medium" id="todayVisits">-</div>
                        </div>
                        <i class="fas fa-chart-line text-green-500"></i>
                    </div>
                </div>
                
                <!-- API 請求數 -->
                <div class="card-minimal p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">API 請求</div>
                            <div class="text-lg font-medium" id="apiRequests">-</div>
                        </div>
                        <i class="fas fa-server text-purple-500"></i>
                    </div>
                </div>
                
                <!-- 系統內存 -->
                <div class="card-minimal p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">內存使用</div>
                            <div class="text-lg font-medium" id="memoryUsage">-</div>
                        </div>
                        <i class="fas fa-memory text-orange-500"></i>
                    </div>
                </div>
            </div>

            <!-- 分頁導航 -->
            <div class="card-minimal p-4 md:p-6">
                <div class="flex flex-wrap border-b border-gray-200 mb-4 md:mb-6">
                    <button class="tab-btn px-3 py-2 text-sm text-blue-600 border-b-2 border-blue-600 font-medium" onclick="switchTab('monitor', this)">系統監控</button>
                    <button class="tab-btn px-3 py-2 text-sm text-gray-600 hover:text-blue-600" onclick="switchTab('users', this)">用戶管理</button>
                    <button class="tab-btn px-3 py-2 text-sm text-gray-600 hover:text-blue-600" onclick="switchTab('logs', this)">系統日誌</button>
                    <button class="tab-btn px-3 py-2 text-sm text-gray-600 hover:text-blue-600" onclick="switchTab('stats', this)">詳細統計</button>
                </div>

                <!-- 系統監控 -->
                <div id="monitor" class="tab-content">
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium mb-4">系統監控</h3>
                        
                        <!-- 服務狀態 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="serviceStatus">
                            <!-- 動態生成服務狀態卡片 -->
                        </div>
                        
                        <!-- 系統指標 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="card-minimal p-4">
                                <h4 class="text-md font-medium mb-3">CPU 使用率</h4>
                                <div class="space-y-2" id="cpuMetrics">
                                    <!-- 動態生成 CPU 指標 -->
                                </div>
                            </div>
                            
                            <div class="card-minimal p-4">
                                <h4 class="text-md font-medium mb-3">內存使用率</h4>
                                <div class="space-y-2" id="memoryMetrics">
                                    <!-- 動態生成內存指標 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用戶管理 -->
                <div id="users" class="tab-content" style="display: none;">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium">用戶管理</h3>
                            <button class="btn-primary" onclick="loadUsers()">載入用戶列表</button>
                        </div>
                        
                        <!-- 搜尋和篩選 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input 
                                type="text" 
                                id="userSearch"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                placeholder="搜尋用戶..."
                                onkeyup="searchUsers()"
                            >
                            
                            <select 
                                id="userStatusFilter"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                onchange="filterUsers()"
                            >
                                <option value="">所有狀態</option>
                                <option value="active">活躍</option>
                                <option value="inactive">非活躍</option>
                                <option value="banned">已封禁</option>
                            </select>
                            
                            <select 
                                id="userRoleFilter"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                onchange="filterUsers()"
                            >
                                <option value="">所有角色</option>
                                <option value="admin">管理員</option>
                                <option value="user">普通用戶</option>
                            </select>
                        </div>
                        
                        <!-- 用戶列表 -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">用戶</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">角色</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">狀態</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">註冊時間</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- 動態生成用戶列表 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分頁 -->
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600" id="usersCount">
                                總共 0 位用戶
                            </div>
                            <div class="flex space-x-2" id="usersPagination">
                                <!-- 動態生成分頁按鈕 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系統日誌 -->
                <div id="logs" class="tab-content" style="display: none;">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium">系統日誌</h3>
                            <button class="btn-primary" onclick="loadLogs()">載入日誌</button>
                        </div>
                        
                        <!-- 日誌篩選 -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <select 
                                id="logLevel"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">所有級別</option>
                                <option value="error">錯誤</option>
                                <option value="warn">警告</option>
                                <option value="info">信息</option>
                                <option value="debug">調試</option>
                            </select>
                            
                            <input 
                                type="datetime-local" 
                                id="logStartTime"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                            >
                            
                            <input 
                                type="datetime-local" 
                                id="logEndTime"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                            >
                            
                            <input 
                                type="text" 
                                id="logKeyword"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                placeholder="關鍵字搜尋..."
                            >
                        </div>
                        
                        <!-- 日誌列表 -->
                        <div class="card-minimal p-4 max-h-96 overflow-y-auto">
                            <div id="logsList" class="space-y-2">
                                <!-- 動態生成日誌條目 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 詳細統計 -->
                <div id="stats" class="tab-content" style="display: none;">
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium mb-4">詳細統計</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- API 統計 -->
                            <div class="card-minimal p-4">
                                <h4 class="text-md font-medium mb-3">API 調用統計</h4>
                                <div id="apiStats" class="space-y-2">
                                    <!-- 動態生成 API 統計 -->
                                </div>
                            </div>
                            
                            <!-- 數據庫統計 -->
                            <div class="card-minimal p-4">
                                <h4 class="text-md font-medium mb-3">數據庫統計</h4>
                                <div id="dbStats" class="space-y-2">
                                    <!-- 動態生成數據庫統計 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 性能統計 -->
                        <div class="card-minimal p-4">
                            <h4 class="text-md font-medium mb-3">性能統計</h4>
                            <div id="performanceStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- 動態生成性能統計 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用戶編輯模態框 -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-medium mb-4">編輯用戶</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">用戶名</label>
                        <input 
                            type="text" 
                            id="editUsername"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                            readonly
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">郵箱</label>
                        <input 
                            type="email" 
                            id="editEmail"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">角色</label>
                        <select 
                            id="editRole"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="user">普通用戶</option>
                            <option value="admin">管理員</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-6">
                    <button class="btn-simple" onclick="closeEditUserModal()">取消</button>
                    <button class="btn-primary" onclick="saveUserChanges()">保存</button>
                    <button class="btn-danger" onclick="resetUserPassword()">重置密碼</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="/public/assets/common.js"></script>
    <script>
        let currentUsersPage = 1;
        let usersPerPage = 10;
        let allUsers = [];
        let filteredUsers = [];
        let currentEditingUserId = null;

        // 頁面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await App.init();
            
            // 載入初始數據
            await loadSystemHealth();
            await loadSystemStats();
            await loadMonitorData();
        });

        // 分頁切換
        function switchTab(tabName, element) {
            // 隱藏所有分頁內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // 移除所有分頁按鈕的樣式
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.className = 'tab-btn px-3 py-2 text-sm text-gray-600 hover:text-blue-600';
            });
            
            // 顯示選中的分頁內容
            document.getElementById(tabName).style.display = 'block';
            
            // 設置選中的分頁按鈕樣式
            element.className = 'tab-btn px-3 py-2 text-sm text-blue-600 border-b-2 border-blue-600 font-medium';
            
            // 根據分頁載入相應數據
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'stats':
                    loadDetailedStats();
                    break;
            }
        }

        // 載入系統健康狀態
        async function loadSystemHealth() {
            try {
                const result = await ApiClient.get('/api/v1/monitor/health');
                
                if (result.success && result.data) {
                    const status = result.data.status;
                    const healthElement = document.getElementById('systemHealth');
                    const indicatorElement = document.getElementById('healthIndicator');
                    
                    healthElement.textContent = status === 'healthy' ? '正常' : '異常';
                    
                    if (status === 'healthy') {
                        indicatorElement.className = 'status-healthy';
                    } else {
                        indicatorElement.className = 'status-error';
                    }
                } else {
                    throw new Error('無法獲取系統狀態');
                }
            } catch (error) {
                console.error('載入系統健康狀態失敗:', error);
                document.getElementById('systemHealth').textContent = '檢查失敗';
                document.getElementById('healthIndicator').className = 'status-error';
            }
        }

        // 載入系統統計
        async function loadSystemStats() {
            try {
                // 先嘗試載入管理統計 (需要認證)
                const adminResult = await ApiClient.get('/api/v1/admin/stats');
                
                if (adminResult.success && adminResult.data) {
                    const stats = adminResult.data;
                    
                    document.getElementById('totalUsers').textContent = stats.total_users || '0';
                    document.getElementById('todayVisits').textContent = stats.today_visits || '0';
                    document.getElementById('apiRequests').textContent = stats.api_requests_total || '0';
                    
                    // 格式化內存使用
                    if (stats.memory_usage) {
                        const memoryPercent = Math.round(stats.memory_usage * 100);
                        document.getElementById('memoryUsage').textContent = `${memoryPercent}%`;
                    }
                } else {
                    throw new Error('需要管理員認證');
                }
            } catch (error) {
                console.warn('管理統計需要認證，使用監控數據:', error);
                
                // 如果管理統計失敗，使用監控數據作為替代
                try {
                    const monitorResult = await ApiClient.get('/api/v1/monitor/stats');
                    if (monitorResult.success && monitorResult.data) {
                        const data = monitorResult.data;
                        
                        document.getElementById('totalUsers').textContent = '需要登入';
                        document.getElementById('todayVisits').textContent = '需要登入';
                        document.getElementById('apiRequests').textContent = data.runtime?.goroutines || '0';
                        document.getElementById('memoryUsage').textContent = data.runtime?.memory_usage || '0 MB';
                    }
                } catch (monitorError) {
                    console.error('載入監控統計也失敗:', monitorError);
                    // 顯示默認值
                    document.getElementById('totalUsers').textContent = '-';
                    document.getElementById('todayVisits').textContent = '-';
                    document.getElementById('apiRequests').textContent = '-';
                    document.getElementById('memoryUsage').textContent = '-';
                }
            }
        }

        // 載入監控數據
        async function loadMonitorData() {
            try {
                const result = await ApiClient.get('/api/v1/monitor/stats');
                
                if (result.success && result.data) {
                    displayServiceStatus(result.data);
                    displaySystemMetrics(result.data);
                }
            } catch (error) {
                console.error('載入監控數據失敗:', error);
            }
        }

        // 顯示服務狀態
        function displayServiceStatus(data) {
            const services = [
                { name: 'API 服務', status: 'healthy', key: 'api' },
                { name: 'PostgreSQL', status: data.database?.connected ? 'healthy' : 'error', key: 'database' },
                { name: 'OpenAI', status: data.services?.openai === 'configured' ? 'healthy' : 'warning', key: 'openai' },
                { name: 'Grok', status: data.services?.grok === 'configured' ? 'healthy' : 'warning', key: 'grok' },
                { name: 'TTS', status: data.services?.tts === 'configured' ? 'healthy' : 'warning', key: 'tts' }
            ];
            
            const container = document.getElementById('serviceStatus');
            container.innerHTML = '';
            
            services.forEach(service => {
                const statusClass = service.status === 'healthy' ? 'status-healthy' : 
                                  service.status === 'warning' ? 'status-warning' : 'status-error';
                
                const statusText = service.status === 'healthy' ? '正常' :
                                 service.status === 'warning' ? '警告' : '異常';
                
                const serviceCard = document.createElement('div');
                serviceCard.className = 'card-minimal p-4';
                serviceCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">${service.name}</div>
                            <div class="text-md font-medium">${statusText}</div>
                        </div>
                        <div class="${statusClass}"></div>
                    </div>
                `;
                
                container.appendChild(serviceCard);
            });
        }

        // 顯示系統指標
        function displaySystemMetrics(data) {
            // CPU 指標 - 使用 goroutines 作為活動指標
            const cpuContainer = document.getElementById('cpuMetrics');
            const goroutines = data.runtime?.goroutines || 0;
            const cpuUsage = Math.min((goroutines / 100) * 100, 100); // 簡單的計算方式
            
            cpuContainer.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">活躍協程</span>
                    <span class="text-sm font-medium">${goroutines}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(cpuUsage, 100)}%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    Go 版本: ${data.system?.go_version || 'unknown'}
                </div>
            `;
            
            // 內存指標
            const memoryContainer = document.getElementById('memoryMetrics');
            const memoryUsage = data.runtime?.memory_usage || '0 MB';
            const gcCount = data.runtime?.gc_count || 0;
            
            memoryContainer.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">內存使用</span>
                    <span class="text-sm font-medium">${memoryUsage}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">GC 次數</span>
                    <span class="text-sm font-medium">${gcCount}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    下次 GC: ${data.runtime?.next_gc || 'unknown'}
                </div>
            `;
        }

        // 載入用戶列表
        async function loadUsers() {
            try {
                const result = await ApiClient.get(`/api/v1/admin/users?page=${currentUsersPage}&limit=${usersPerPage}`);
                
                if (result.success && result.data) {
                    allUsers = result.data.users || [];
                    filteredUsers = [...allUsers];
                    displayUsers();
                    updateUsersPagination(result.data.total || 0);
                } else {
                    throw new Error(result.message || '載入失敗');
                }
            } catch (error) {
                console.error('載入用戶列表失敗:', error);
                
                if (error.message && error.message.includes('認證')) {
                    UI.showToast('需要管理員登入才能查看用戶列表', 'warning');
                    
                    // 顯示需要登入的提示
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-3 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-lock text-4xl mb-4 text-gray-300"></i>
                                    <p class="text-lg font-medium">需要管理員權限</p>
                                    <p class="text-sm">請先登入管理員帳號才能查看用戶列表</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    document.getElementById('usersCount').textContent = '需要管理員認證';
                } else {
                    UI.showToast('載入用戶列表失敗: ' + error.message, 'error');
                }
            }
        }

        // 顯示用戶列表
        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' :
                                  user.status === 'inactive' ? 'bg-gray-100 text-gray-800' :
                                  'bg-red-100 text-red-800';
                
                const statusText = user.status === 'active' ? '活躍' :
                                 user.status === 'inactive' ? '非活躍' : '已封禁';
                
                row.innerHTML = `
                    <td class="px-3 py-2">
                        <div>
                            <div class="font-medium">${user.username}</div>
                            <div class="text-xs text-gray-500">${user.email}</div>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${user.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.role === 'admin' ? '管理員' : '普通用戶'}
                        </span>
                    </td>
                    <td class="px-3 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-600">
                        ${user.created_at ? moment(user.created_at).format('YYYY-MM-DD') : '-'}
                    </td>
                    <td class="px-3 py-2">
                        <button 
                            class="btn-simple text-xs mr-1"
                            onclick="editUser('${user.id}')"
                        >
                            編輯
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // 更新計數
            document.getElementById('usersCount').textContent = `總共 ${filteredUsers.length} 位用戶`;
        }

        // 搜尋用戶
        function searchUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            
            if (query) {
                filteredUsers = allUsers.filter(user => 
                    user.username.toLowerCase().includes(query) ||
                    user.email.toLowerCase().includes(query)
                );
            } else {
                filteredUsers = [...allUsers];
            }
            
            applyFilters();
            displayUsers();
        }

        // 篩選用戶
        function filterUsers() {
            applyFilters();
            displayUsers();
        }

        // 應用篩選條件
        function applyFilters() {
            const statusFilter = document.getElementById('userStatusFilter').value;
            const roleFilter = document.getElementById('userRoleFilter').value;
            
            let filtered = [...filteredUsers];
            
            if (statusFilter) {
                filtered = filtered.filter(user => user.status === statusFilter);
            }
            
            if (roleFilter) {
                filtered = filtered.filter(user => user.role === roleFilter);
            }
            
            filteredUsers = filtered;
        }

        // 編輯用戶
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentEditingUserId = userId;
            
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role;
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        // 關閉編輯模態框
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            currentEditingUserId = null;
        }

        // 保存用戶修改
        async function saveUserChanges() {
            if (!currentEditingUserId) return;
            
            const userData = {
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value
            };
            
            try {
                const result = await ApiClient.put(`/api/v1/admin/users/${currentEditingUserId}`, userData);
                
                if (result.success) {
                    UI.showToast('用戶信息已更新', 'success');
                    closeEditUserModal();
                    loadUsers();
                } else {
                    throw new Error(result.error?.message || '更新失敗');
                }
            } catch (error) {
                console.error('保存用戶修改失敗:', error);
                UI.showToast('保存失敗: ' + error.message, 'error');
            }
        }

        // 重置用戶密碼
        async function resetUserPassword() {
            if (!currentEditingUserId) return;
            
            if (!confirm('確定要重置該用戶的密碼嗎？')) return;
            
            try {
                const result = await ApiClient.put(`/api/v1/admin/users/${currentEditingUserId}/password`, {
                    new_password: generateRandomPassword()
                });
                
                if (result.success) {
                    UI.showToast('密碼已重置', 'success');
                    closeEditUserModal();
                } else {
                    throw new Error(result.error?.message || '重置失敗');
                }
            } catch (error) {
                console.error('重置密碼失敗:', error);
                UI.showToast('重置失敗: ' + error.message, 'error');
            }
        }

        // 生成隨機密碼
        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // 更新用戶分頁
        function updateUsersPagination(total) {
            const totalPages = Math.ceil(total / usersPerPage);
            const paginationContainer = document.getElementById('usersPagination');
            paginationContainer.innerHTML = '';
            
            // 上一頁
            if (currentUsersPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn-simple';
                prevBtn.textContent = '上一頁';
                prevBtn.onclick = () => {
                    currentUsersPage--;
                    loadUsers();
                };
                paginationContainer.appendChild(prevBtn);
            }
            
            // 頁碼
            for (let i = Math.max(1, currentUsersPage - 2); i <= Math.min(totalPages, currentUsersPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = i === currentUsersPage ? 'btn-primary' : 'btn-simple';
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentUsersPage = i;
                    loadUsers();
                };
                paginationContainer.appendChild(pageBtn);
            }
            
            // 下一頁
            if (currentUsersPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn-simple';
                nextBtn.textContent = '下一頁';
                nextBtn.onclick = () => {
                    currentUsersPage++;
                    loadUsers();
                };
                paginationContainer.appendChild(nextBtn);
            }
        }

        // 載入系統日誌
        async function loadLogs() {
            try {
                const params = new URLSearchParams();
                
                const level = document.getElementById('logLevel').value;
                const startTime = document.getElementById('logStartTime').value;
                const endTime = document.getElementById('logEndTime').value;
                const keyword = document.getElementById('logKeyword').value;
                
                if (level) params.append('level', level);
                if (startTime) params.append('start_time', startTime);
                if (endTime) params.append('end_time', endTime);
                if (keyword) params.append('keyword', keyword);
                
                const url = `/api/v1/admin/logs${params.toString() ? '?' + params.toString() : ''}`;
                const result = await ApiClient.get(url);
                
                if (result.success && result.data) {
                    displayLogs(result.data.logs || []);
                } else {
                    throw new Error(result.message || '載入失敗');
                }
            } catch (error) {
                console.error('載入日誌失敗:', error);
                
                if (error.message && error.message.includes('認證')) {
                    UI.showToast('需要管理員登入才能查看系統日誌', 'warning');
                    
                    // 顯示需要登入的提示
                    const container = document.getElementById('logsList');
                    container.innerHTML = `
                        <div class="flex flex-col items-center py-8 text-gray-500">
                            <i class="fas fa-lock text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg font-medium">需要管理員權限</p>
                            <p class="text-sm">請先登入管理員帳號才能查看系統日誌</p>
                        </div>
                    `;
                } else {
                    UI.showToast('載入日誌失敗: ' + error.message, 'error');
                    
                    // 顯示模擬日誌作為示例
                    const mockLogs = [
                        { level: 'info', timestamp: new Date().toISOString(), message: '系統正常運行中', source: 'system' },
                        { level: 'info', timestamp: new Date(Date.now() - 60000).toISOString(), message: 'API 服務啟動完成', source: 'api' },
                        { level: 'info', timestamp: new Date(Date.now() - 120000).toISOString(), message: '資料庫連接建立', source: 'database' }
                    ];
                    displayLogs(mockLogs);
                }
            }
        }

        // 顯示日誌
        function displayLogs(logs) {
            const container = document.getElementById('logsList');
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">沒有找到日誌記錄</div>';
                return;
            }
            
            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'border border-gray-200 rounded p-3';
                
                const levelClass = log.level === 'error' ? 'text-red-600' :
                                 log.level === 'warn' ? 'text-yellow-600' :
                                 log.level === 'info' ? 'text-blue-600' :
                                 'text-gray-600';
                
                logItem.innerHTML = `
                    <div class="flex items-start justify-between mb-1">
                        <span class="text-xs ${levelClass} font-medium uppercase">${log.level}</span>
                        <span class="text-xs text-gray-500">${moment(log.timestamp).format('YYYY-MM-DD HH:mm:ss')}</span>
                    </div>
                    <div class="text-sm">${log.message}</div>
                    ${log.source ? `<div class="text-xs text-gray-500 mt-1">來源: ${log.source}</div>` : ''}
                `;
                
                container.appendChild(logItem);
            });
        }

        // 載入詳細統計
        async function loadDetailedStats() {
            try {
                const result = await ApiClient.get('/api/v1/admin/stats');
                
                if (result.success && result.data) {
                    displayDetailedStats(result.data);
                } else {
                    throw new Error(result.message || '載入失敗');
                }
            } catch (error) {
                console.warn('管理統計需要認證，使用監控數據:', error);
                
                // 使用監控數據作為替代
                try {
                    const monitorResult = await ApiClient.get('/api/v1/monitor/stats');
                    if (monitorResult.success && monitorResult.data) {
                        displayDetailedStatsFromMonitor(monitorResult.data);
                    }
                } catch (monitorError) {
                    console.error('載入監控統計也失敗:', monitorError);
                    displayDefaultStats();
                }
            }
        }

        // 使用監控數據顯示統計
        function displayDetailedStatsFromMonitor(data) {
            // API 統計
            const apiStatsContainer = document.getElementById('apiStats');
            apiStatsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">協程數</span>
                    <span class="text-sm font-medium">${data.runtime?.goroutines || '0'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">系統架構</span>
                    <span class="text-sm font-medium">${data.system?.architecture || 'unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">CPU 核心</span>
                    <span class="text-sm font-medium">${data.system?.num_cpu || '0'}</span>
                </div>
            `;
            
            // 數據庫統計
            const dbStatsContainer = document.getElementById('dbStats');
            dbStatsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">連接狀態</span>
                    <span class="text-sm font-medium">${data.database?.connected ? '已連接' : '未連接'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">資料庫類型</span>
                    <span class="text-sm font-medium">${data.database?.type || 'unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">延遲</span>
                    <span class="text-sm font-medium">${data.database?.ping_latency || '0ms'}</span>
                </div>
            `;
            
            // 性能統計
            const performanceStatsContainer = document.getElementById('performanceStats');
            performanceStatsContainer.innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-medium">${data.runtime?.memory_usage || '0 MB'}</div>
                    <div class="text-sm text-gray-600">內存使用量</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-medium">${data.runtime?.gc_count || '0'}</div>
                    <div class="text-sm text-gray-600">GC 次數</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-medium">${data.system?.os || 'unknown'}</div>
                    <div class="text-sm text-gray-600">作業系統</div>
                </div>
            `;
        }

        // 顯示默認統計
        function displayDefaultStats() {
            ['apiStats', 'dbStats'].forEach(id => {
                document.getElementById(id).innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-lock text-2xl mb-2"></i>
                        <p class="text-sm">需要管理員權限</p>
                    </div>
                `;
            });
            
            document.getElementById('performanceStats').innerHTML = `
                <div class="text-center text-gray-500 py-4 col-span-3">
                    <i class="fas fa-lock text-2xl mb-2"></i>
                    <p class="text-sm">需要管理員權限查看詳細統計</p>
                </div>
            `;
        }

        // 顯示詳細統計
        function displayDetailedStats(stats) {
            // API 統計
            const apiStatsContainer = document.getElementById('apiStats');
            apiStatsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">總請求數</span>
                    <span class="text-sm font-medium">${stats.api_requests_total || '0'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">成功率</span>
                    <span class="text-sm font-medium">${stats.api_success_rate ? (stats.api_success_rate * 100).toFixed(1) : '0'}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">平均響應時間</span>
                    <span class="text-sm font-medium">${stats.api_avg_response_time || '0'}ms</span>
                </div>
            `;
            
            // 數據庫統計
            const dbStatsContainer = document.getElementById('dbStats');
            dbStatsContainer.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">連接數</span>
                    <span class="text-sm font-medium">${stats.db_connections || '0'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">查詢總數</span>
                    <span class="text-sm font-medium">${stats.db_queries_total || '0'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">平均查詢時間</span>
                    <span class="text-sm font-medium">${stats.db_avg_query_time || '0'}ms</span>
                </div>
            `;
            
            // 性能統計
            const performanceStatsContainer = document.getElementById('performanceStats');
            performanceStatsContainer.innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-medium">${stats.uptime_hours || '0'}h</div>
                    <div class="text-sm text-gray-600">系統運行時間</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-medium">${stats.goroutines || '0'}</div>
                    <div class="text-sm text-gray-600">活躍協程數</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-medium">${stats.heap_size ? (stats.heap_size / 1024 / 1024).toFixed(1) : '0'}MB</div>
                    <div class="text-sm text-gray-600">堆內存使用</div>
                </div>
            `;
        }

        // 刷新所有數據
        async function refreshAllData() {
            UI.showToast('正在刷新數據...', 'info');
            
            await Promise.all([
                loadSystemHealth(),
                loadSystemStats(),
                loadMonitorData()
            ]);
            
            UI.showToast('數據已刷新', 'success');
        }
    </script>
</body>
</html>