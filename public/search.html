<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜尋 - Thewavess AI Core</title>
    
    <!-- Tailwind CSS 3.4.17 -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-tw.min.js"></script>
    
</head>
<body class="min-h-full p-4 bg-gray-50 text-gray-900">
    <!-- 頂部導航 -->
    <nav class="bg-white border rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button 
                    class="bg-gray-600 hover:bg-gray-700 text-white p-2 rounded"
                    onclick="goBack()"
                >
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <h1 class="text-2xl font-bold">
                    <i class="fas fa-search text-blue-400 mr-2"></i>
                    全域搜尋
                </h1>
            </div>
        </div>
    </nav>
    
    <!-- 搜尋區域 -->
    <div class="max-w-4xl mx-auto space-y-6">
        <!-- 搜尋框 -->
        <div class="bg-white border rounded-lg p-6">
            <div class="flex space-x-4">
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="searchQuery"
                        class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900 focus:ring-2 focus:ring-blue-500"
                        placeholder="搜尋對話內容、角色互動、記憶片段..."
                        onkeypress="handleSearchKeyPress(event)"
                    >
                </div>
                <button 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded"
                    onclick="performSearch()"
                >
                    <i class="fas fa-search mr-2"></i>
                    搜尋
                </button>
            </div>
            
            <!-- 搜尋選項 -->
            <div class="mt-4 flex flex-wrap gap-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="searchChats" checked class="rounded">
                    <span>對話內容</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="searchMemories" checked class="rounded">
                    <span>記憶片段</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="searchCharacters" checked class="rounded">
                    <span>角色互動</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="searchEmotions" class="rounded">
                    <span>情感狀態</span>
                </label>
            </div>
        </div>
        
        <!-- 搜尋結果 -->
        <div id="searchResults" class="bg-white border rounded-lg p-6" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-list text-green-400 mr-2"></i>
                搜尋結果
            </h2>
            
            <div id="resultsContainer">
                <!-- 搜尋結果將動態插入這裡 -->
            </div>
            
            <!-- 載入更多 -->
            <div class="text-center mt-6">
                <button 
                    id="loadMoreBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded"
                    onclick="loadMoreResults()"
                    style="display: none;"
                >
                    載入更多結果
                </button>
            </div>
        </div>
        
        <!-- 快速搜尋 -->
        <div class="bg-white border rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                快速搜尋
            </h3>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button 
                    class="bg-purple-100 hover:bg-purple-200 text-purple-800 p-3 rounded text-center"
                    onclick="quickSearch('今天的對話')"
                >
                    <i class="fas fa-calendar-day mb-2"></i>
                    <div>今天的對話</div>
                </button>
                
                <button 
                    class="bg-pink-100 hover:bg-pink-200 text-pink-800 p-3 rounded text-center"
                    onclick="quickSearch('浪漫時刻')"
                >
                    <i class="fas fa-heart mb-2"></i>
                    <div>浪漫時刻</div>
                </button>
                
                <button 
                    class="bg-blue-100 hover:bg-blue-200 text-blue-800 p-3 rounded text-center"
                    onclick="quickSearch('重要記憶')"
                >
                    <i class="fas fa-star mb-2"></i>
                    <div>重要記憶</div>
                </button>
                
                <button 
                    class="bg-green-100 hover:bg-green-200 text-green-800 p-3 rounded text-center"
                    onclick="quickSearch('情感里程碑')"
                >
                    <i class="fas fa-trophy mb-2"></i>
                    <div>情感里程碑</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="/public/assets/common.js"></script>
    <script>
        let currentPage = 1;
        let hasMoreResults = false;
        let lastSearchQuery = '';
        
        // 頁面初始化
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });
        
        // 處理搜尋按鍵
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }
        
        // 執行搜尋
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                UI.showToast('請輸入搜尋關鍵字', 'warning');
                return;
            }
            
            lastSearchQuery = query;
            currentPage = 1;
            
            const searchOptions = {
                chats: document.getElementById('searchChats').checked,
                memories: document.getElementById('searchMemories').checked,
                characters: document.getElementById('searchCharacters').checked,
                emotions: document.getElementById('searchEmotions').checked
            };
            
            try {
                UI.showLoading();
                
                const results = await searchContent(query, searchOptions, currentPage);
                displaySearchResults(results, true);
                
                // 顯示結果區域
                document.getElementById('searchResults').style.display = 'block';
                
            } catch (error) {
                console.error('搜尋失敗:', error);
                UI.showToast('搜尋失敗: ' + error.message, 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // 搜尋內容
        async function searchContent(query, options, page = 1) {
            const results = {
                chats: [],
                memories: [],
                characters: [],
                emotions: [],
                total: 0,
                hasMore: false,
                searchTime: 0
            };
            
            // 搜尋對話內容
            if (options.chats) {
                try {
                    const params = new URLSearchParams({
                        q: query,
                        page: page.toString(),
                        limit: '10'
                    });
                    const chatResult = await ApiClient.get(`/api/v1/search/chats?${params.toString()}`);
                    
                    if (chatResult.success && chatResult.data) {
                        results.chats = chatResult.data.results || [];
                        results.total += chatResult.data.total_found || 0;
                        results.hasMore = chatResult.data.current_page < chatResult.data.total_pages;
                        results.searchTime = chatResult.data.search_time || '0ms';
                    }
                } catch (error) {
                    console.warn('對話搜尋失敗:', error);
                    // 使用模擬數據
                    results.chats = generateMockChatResults(query);
                }
            }
            
            // 搜尋記憶片段
            if (options.memories) {
                try {
                    const params = new URLSearchParams({
                        query: query,
                        page: page.toString(),
                        limit: '5'
                    });
                    const memoryResult = await ApiClient.get(`/api/v1/memory/search?${params.toString()}`);
                    
                    if (memoryResult.success && memoryResult.data) {
                        results.memories = memoryResult.data.memories || [];
                    }
                } catch (error) {
                    console.warn('記憶搜尋失敗:', error);
                    // 使用模擬數據
                    results.memories = generateMockMemoryResults(query);
                }
            }
            
            // 全局搜尋 - 獲取角色和其他類型的內容
            try {
                const params = new URLSearchParams({
                    q: query,
                    type: 'all'
                });
                const globalResult = await ApiClient.get(`/api/v1/search/global?${params.toString()}`);
                
                if (globalResult.success && globalResult.data) {
                    const categories = globalResult.data.categories || {};
                    
                    // 合併對話結果（如果啟用）
                    if (options.chats && categories.chats) {
                        const globalChats = categories.chats.top_results || [];
                        results.chats.push(...globalChats);
                        results.total += categories.chats.count || 0;
                    }
                    
                    // 合併記憶結果（如果啟用）
                    if (options.memories && categories.memories) {
                        const globalMemories = categories.memories.top_results || [];
                        results.memories.push(...globalMemories);
                    }
                    
                    // 角色結果
                    if (options.characters && categories.characters) {
                        results.characters = categories.characters.top_results || [];
                    }
                    
                    // 設置總結果數和搜尋時間
                    results.total = Math.max(results.total, globalResult.data.total_results || 0);
                    results.searchTime = globalResult.data.search_time || results.searchTime;
                    
                    // 添加搜尋建議
                    if (globalResult.data.suggestions) {
                        results.suggestions = globalResult.data.suggestions;
                    }
                }
            } catch (error) {
                console.warn('全局搜尋失敗:', error);
            }
            
            // 去重
            results.chats = removeDuplicates(results.chats, 'id');
            results.memories = removeDuplicates(results.memories, 'id');
            
            return results;
        }
        
        // 顯示搜尋結果
        function displaySearchResults(results, clearPrevious = false) {
            const container = document.getElementById('resultsContainer');
            
            if (clearPrevious) {
                container.innerHTML = '';
            }
            
            let resultCount = 0;
            
            // 顯示對話結果
            if (results.chats && results.chats.length > 0) {
                const chatSection = createResultSection('對話內容', 'fas fa-comments', 'blue');
                results.chats.forEach(chat => {
                    chatSection.appendChild(createChatResultItem(chat));
                    resultCount++;
                });
                container.appendChild(chatSection);
            }
            
            // 顯示記憶結果
            if (results.memories && results.memories.length > 0) {
                const memorySection = createResultSection('記憶片段', 'fas fa-brain', 'purple');
                results.memories.forEach(memory => {
                    memorySection.appendChild(createMemoryResultItem(memory));
                    resultCount++;
                });
                container.appendChild(memorySection);
            }
            
            // 顯示角色結果
            if (results.characters && results.characters.length > 0) {
                const characterSection = createResultSection('角色互動', 'fas fa-users', 'green');
                results.characters.forEach(character => {
                    characterSection.appendChild(createCharacterResultItem(character));
                    resultCount++;
                });
                container.appendChild(characterSection);
            }
            
            // 顯示情感結果
            if (results.emotions && results.emotions.length > 0) {
                const emotionSection = createResultSection('情感狀態', 'fas fa-heart', 'pink');
                results.emotions.forEach(emotion => {
                    emotionSection.appendChild(createEmotionResultItem(emotion));
                    resultCount++;
                });
                container.appendChild(emotionSection);
            }
            
            // 更新載入更多按鈕
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (results.hasMore) {
                loadMoreBtn.style.display = 'block';
                hasMoreResults = true;
            } else {
                loadMoreBtn.style.display = 'none';
                hasMoreResults = false;
            }
            
            // 顯示結果統計
            if (clearPrevious) {
                const statsDiv = document.createElement('div');
                statsDiv.className = 'mb-4 text-gray-600 flex justify-between items-center';
                statsDiv.innerHTML = `
                    <span>找到 ${results.total || resultCount} 個相關結果</span>
                    <span class="text-sm">${results.searchTime ? `搜尋用時: ${results.searchTime}` : ''}</span>
                `;
                container.insertBefore(statsDiv, container.firstChild);
                
                // 顯示搜尋建議
                if (results.suggestions && results.suggestions.length > 0) {
                    const suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg';
                    suggestionsDiv.innerHTML = `
                        <div class="text-sm text-blue-800 mb-2">
                            <i class="fas fa-lightbulb mr-1"></i>相關搜尋建議：
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${results.suggestions.map(suggestion => 
                                `<button class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-2 py-1 rounded cursor-pointer" 
                                         onclick="quickSearch('${suggestion}')">${suggestion}</button>`
                            ).join('')}
                        </div>
                    `;
                    container.insertBefore(suggestionsDiv, container.firstChild);
                }
            }
        }
        
        // 創建結果區塊
        function createResultSection(title, icon, color) {
            const section = document.createElement('div');
            section.className = 'mb-6';
            section.innerHTML = `
                <h4 class="text-lg font-semibold mb-3 text-${color}-600">
                    <i class="${icon} mr-2"></i>${title}
                </h4>
                <div class="space-y-3"></div>
            `;
            return section;
        }
        
        // 創建對話結果項目
        function createChatResultItem(chat) {
            const item = document.createElement('div');
            item.className = 'bg-gray-50 border rounded-lg p-4 hover:bg-gray-100 transition-colors cursor-pointer';
            item.onclick = () => openChat(chat.session_id);
            
            const timeStr = chat.created_at ? Utils.formatDateTime(chat.created_at) : '未知時間';
            const preview = chat.content ? chat.content.substring(0, 150) + '...' : '無內容預覽';
            const characterName = chat.character ? chat.character.name : (chat.character_name || '未知角色');
            const sessionTitle = chat.session_title || '對話';
            
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium">${characterName}</div>
                    <div class="text-sm text-gray-500">${timeStr}</div>
                </div>
                <div class="text-sm text-blue-600 mb-1">${sessionTitle}</div>
                <div class="text-gray-700">${preview}</div>
                <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                    <span><i class="fas fa-message mr-1"></i>會話: ${chat.session_id}</span>
                    ${chat.nsfw_level ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded">NSFW ${chat.nsfw_level}</span>` : ''}
                    ${chat.relevance ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">相關度: ${Math.round(chat.relevance * 100)}%</span>` : ''}
                </div>
            `;
            
            return item;
        }
        
        // 創建記憶結果項目
        function createMemoryResultItem(memory) {
            const item = document.createElement('div');
            item.className = 'bg-purple-50 border border-purple-200 rounded-lg p-4';
            
            const timeStr = memory.created_at ? Utils.formatDateTime(memory.created_at) : '未知時間';
            
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium text-purple-800">${memory.type || '一般記憶'}</div>
                    <div class="text-sm text-gray-500">${timeStr}</div>
                </div>
                <div class="text-gray-700 mb-2">${memory.content || '無內容'}</div>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span>重要度: ${memory.importance || 0}/10</span>
                    <span>角色: ${memory.character_name || '未知'}</span>
                </div>
            `;
            
            return item;
        }
        
        // 創建角色結果項目
        function createCharacterResultItem(character) {
            const item = document.createElement('div');
            item.className = 'bg-green-50 border border-green-200 rounded-lg p-4 hover:bg-green-100 transition-colors cursor-pointer';
            item.onclick = () => selectCharacter(character.id);
            
            const avatarUrl = character.avatar_url || 'https://placehold.co/40x40/10b981/ffffff?text=' + encodeURIComponent(character.name[0]);
            const excerpt = character.excerpt || character.description || '無描述';
            
            item.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${avatarUrl}" 
                         alt="${character.name}" class="w-10 h-10 rounded-full">
                    <div class="flex-1">
                        <div class="font-medium">${character.name}</div>
                        <div class="text-sm text-gray-600">${excerpt}</div>
                        ${character.relevance ? `<div class="text-xs text-green-600 mt-1">相關度: ${Math.round(character.relevance * 100)}%</div>` : ''}
                    </div>
                    <div class="text-sm text-gray-500">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${character.type || '角色'}</span>
                    </div>
                </div>
            `;
            
            return item;
        }
        
        // 創建情感結果項目
        function createEmotionResultItem(emotion) {
            const item = document.createElement('div');
            item.className = 'bg-pink-50 border border-pink-200 rounded-lg p-4';
            
            const timeStr = emotion.created_at ? Utils.formatDateTime(emotion.created_at) : '未知時間';
            
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium text-pink-800">${emotion.emotion || '未知情感'}</div>
                    <div class="text-sm text-gray-500">${timeStr}</div>
                </div>
                <div class="text-gray-700 mb-2">${emotion.trigger || '無觸發描述'}</div>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span>強度: ${emotion.intensity || 0}/10</span>
                    <span>好感度: ${emotion.affection || 0}</span>
                </div>
            `;
            
            return item;
        }
        
        // 快速搜尋
        function quickSearch(query) {
            document.getElementById('searchQuery').value = query;
            performSearch();
        }
        
        // 載入更多結果
        async function loadMoreResults() {
            if (!hasMoreResults || !lastSearchQuery) return;
            
            currentPage++;
            
            const searchOptions = {
                chats: document.getElementById('searchChats').checked,
                memories: document.getElementById('searchMemories').checked,
                characters: document.getElementById('searchCharacters').checked,
                emotions: document.getElementById('searchEmotions').checked
            };
            
            try {
                UI.showLoading(document.getElementById('loadMoreBtn'));
                
                const results = await searchContent(lastSearchQuery, searchOptions, currentPage);
                displaySearchResults(results, false);
                
            } catch (error) {
                console.error('載入更多結果失敗:', error);
                UI.showToast('載入失敗: ' + error.message, 'error');
            } finally {
                UI.hideLoading(document.getElementById('loadMoreBtn'));
            }
        }
        
        // 工具函數
        function removeDuplicates(array, key) {
            const seen = new Set();
            return array.filter(item => {
                const value = item[key];
                if (seen.has(value)) {
                    return false;
                }
                seen.add(value);
                return true;
            });
        }
        
        // 生成模擬對話結果
        function generateMockChatResults(query) {
            return [
                {
                    id: 'chat_001',
                    session_id: 'session_123',
                    character_name: '陸寒淵',
                    content: `包含「${query}」的對話內容，這是一段模擬的對話記錄，展示搜尋結果的格式。`,
                    created_at: moment().toISOString(),
                    nsfw_level: 2
                },
                {
                    id: 'chat_002', 
                    session_id: 'session_124',
                    character_name: '沈言墨',
                    content: `另一段包含搜尋關鍵字「${query}」的對話，這裡會顯示匹配的內容片段。`,
                    created_at: moment().subtract(1, "day").toISOString(),
                    nsfw_level: 1
                }
            ];
        }
        
        // 生成模擬記憶結果
        function generateMockMemoryResults(query) {
            return [
                {
                    id: 'memory_001',
                    type: 'preference',
                    content: `用戶偏好記憶：與搜尋詞「${query}」相關的偏好設定或互動記錄。`,
                    importance: 8,
                    character_name: '陸寒淵',
                    created_at: moment().toISOString()
                },
                {
                    id: 'memory_002',
                    type: 'milestone',
                    content: `關係里程碑：關於「${query}」的重要時刻或特殊互動記錄。`,
                    importance: 9,
                    character_name: '沈言墨',
                    created_at: moment().subtract(2, "days").toISOString()
                }
            ];
        }
        
        // 頁面導航
        function openChat(sessionId) {
            Router.navigate('/chat', { session_id: sessionId });
        }
        
        function selectCharacter(characterId) {
            Router.navigate('/character', { character_id: characterId });
        }
        
        function goBack() {
            Router.navigate('/');
        }
    </script>
</body>
</html>