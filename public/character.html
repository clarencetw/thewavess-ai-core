<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色選擇 - Thewavess AI Core</title>
    
    <!-- Tailwind CSS 3.4.17 -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-tw.min.js"></script>
    
    <!-- Flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    
    <!-- Centralized Styles -->
    <link rel="stylesheet" href="/public/assets/styles.css">
    
    <!-- Page-specific styles -->
    <style>
        body {
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
    
</head>
<body class="h-full flex flex-col bg-white text-gray-900">
    <!-- 簡化的頂部導航 -->
    <nav class="border-b border-gray-200 p-3 md:p-4 flex-shrink-0">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center space-x-2 md:space-x-4">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <i class="fas fa-masks-theater text-blue-600 text-lg md:text-xl"></i>
                    <div class="min-w-0 flex-1">
                        <h1 class="text-base md:text-lg font-medium truncate">角色選擇</h1>
                        <div class="text-xs md:text-sm text-gray-500">
                            歡迎，<span id="userNickname" class="font-medium">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button 
                    class="btn-simple text-xs md:text-sm"
                    onclick="Router.navigate('/profile')"
                >
                    <i class="fas fa-user mr-1 md:mr-2"></i>
                    <span class="hidden sm:inline">個人</span>資料
                </button>
                <button 
                    class="btn-simple text-red-600 border-red-200 hover:bg-red-50 text-xs md:text-sm"
                    onclick="logout()"
                >
                    <i class="fas fa-sign-out-alt mr-1 md:mr-2"></i>
                    登出
                </button>
            </div>
        </div>
    </nav>
    
    <!-- 主內容區域 -->
    <div class="flex-1 overflow-auto p-3 md:p-4">
        <div class="max-w-6xl mx-auto">
            <!-- 角色篩選 -->
            <div class="card-minimal p-4 md:p-6 mb-4">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between space-y-3 md:space-y-0">
                    <div>
                        <h2 class="text-lg md:text-xl font-medium mb-2">
                            <i class="fas fa-filter text-blue-600 mr-2"></i>
                            選擇您的專屬 AI 伴侶
                        </h2>
                        <p class="text-sm md:text-base text-gray-600">
                            每個角色都有獨特的性格和對話風格
                        </p>
                    </div>
                
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <select 
                            id="nsfwFilter"
                            class="btn-simple text-xs md:text-sm min-w-0"
                            onchange="filterCharacters()"
                        >
                        <option value="all">所有角色</option>
                        <option value="safe">安全內容</option>
                        <option value="mild">輕度內容</option>
                        <option value="adult">成人內容</option>
                    </select>
                    
                        <select 
                            id="sortBy"
                            class="btn-simple text-xs md:text-sm min-w-0"
                            onchange="sortCharacters()"
                        >
                        <option value="popularity">人氣排序</option>
                        <option value="name">名稱排序</option>
                        <option value="newest">最新加入</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
            <!-- 角色卡片網格 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-4" id="characterGrid">
            <!-- 角色卡片將動態生成 -->
        </div>
        
            <!-- 已選擇的角色 -->
            <div id="selectedCharacterPanel" class="card-minimal p-4 md:p-6 mb-4 hidden">
                <h3 class="text-lg md:text-xl font-medium mb-4">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    已選擇角色
                </h3>
            
                <div class="flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6">
                    <div class="flex-shrink-0">
                        <img 
                            id="selectedAvatar"
                            class="w-20 h-20 md:w-24 md:h-24 rounded-full border-2 border-blue-500"
                            src=""
                            alt="選中的角色"
                        >
                    </div>
                
                    <div class="flex-1">
                        <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 mb-2">
                            <h4 id="selectedName" class="text-lg md:text-xl font-medium"></h4>
                            <div class="flex items-center space-x-2">
                                <span id="selectedTitle" class="px-2 py-1 rounded-full text-xs md:text-sm font-medium"></span>
                                <span id="selectedNsfwBadge" class="px-2 py-1 rounded text-xs font-medium"></span>
                            </div>
                        </div>
                    
                        <p id="selectedDescription" class="text-sm md:text-base text-gray-600 mb-3"></p>
                        
                        <div class="flex flex-wrap gap-2 mb-4 items-center">
                            <span class="text-xs md:text-sm text-gray-500">性格特徵：</span>
                            <div id="selectedPersonality" class="flex flex-wrap gap-1"></div>
                        </div>
                    
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                            <button 
                                id="chatActionButton"
                                class="btn-primary flex-1 sm:flex-initial px-4 py-2 md:px-6 md:py-3 text-sm md:text-base font-medium"
                                onclick="startChatting()"
                            >
                                <i class="fas fa-comments mr-1 md:mr-2"></i>
                                <span id="chatActionText">開始對話</span>
                            </button>
                            
                            <button 
                                class="btn-simple flex-1 sm:flex-initial px-4 py-2 md:px-6 md:py-3 text-sm md:text-base font-medium"
                                onclick="clearSelection()"
                            >
                                <i class="fas fa-times mr-1 md:mr-2"></i>
                                重新選擇
                            </button>
                        </div>
                </div>
            </div>
        </div>
        
            <!-- 角色詳情模態框 -->
            <div id="characterModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeModalOnBackdrop(event)">
                <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 md:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6 mb-6">
                        <img 
                            id="modalAvatar"
                            class="w-24 h-24 md:w-32 md:h-32 rounded-full border-2 border-purple-500 mx-auto md:mx-0"
                            src=""
                            alt="角色頭像"
                        >
                    
                        <div class="flex-1 text-center md:text-left">
                            <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-3 mb-2">
                                <h3 id="modalName" class="text-xl md:text-2xl font-medium"></h3>
                                <span id="modalTitle" class="px-3 py-1 rounded-full text-sm font-medium mx-auto md:mx-0"></span>
                            </div>
                        
                            <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4 mb-3">
                                <span id="modalNsfwBadge" class="px-2 py-1 rounded text-xs font-medium mx-auto md:mx-0"></span>
                                <span class="text-yellow-600 mx-auto md:mx-0">
                                    <i class="fas fa-star mr-1"></i>
                                    <span id="modalPopularity"></span>% 人氣
                                </span>
                            </div>
                        
                            <p id="modalDescription" class="text-sm md:text-base text-gray-600"></p>
                        </div>
                    </div>
                
                    <div class="space-y-4 mb-6">
                        <div>
                            <h4 class="text-base md:text-lg font-medium mb-2">
                                <i class="fas fa-heart text-red-500 mr-2"></i>
                                性格特徵
                            </h4>
                            <div id="modalPersonality" class="flex flex-wrap gap-2"></div>
                        </div>
                    
                        <div>
                            <h4 class="text-base md:text-lg font-medium mb-2">
                                <i class="fas fa-comment-dots text-blue-500 mr-2"></i>
                                對話風格
                            </h4>
                            <p id="modalChatStyle" class="text-sm md:text-base text-gray-600"></p>
                        </div>
                    
                        <div>
                            <h4 class="text-base md:text-lg font-medium mb-2">
                                <i class="fas fa-shield-alt text-green-500 mr-2"></i>
                                內容分級
                            </h4>
                            <p id="modalContentInfo" class="text-sm md:text-base text-gray-600"></p>
                        </div>
                    </div>
                
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button 
                            class="flex-1 btn-primary py-3 px-6 font-medium"
                            onclick="selectCharacterFromModal()"
                        >
                            <i class="fas fa-check mr-2"></i>
                            選擇這個角色
                        </button>
                        
                        <button 
                            class="btn-simple py-3 px-6 font-medium"
                            onclick="UI.modal.hide('characterModal')"
                        >
                            <i class="fas fa-times mr-2"></i>
                            關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="/public/assets/common.js"></script>
    <script>
        let characters = [];
        let filteredCharacters = [];
        let selectedCharacter = null;
        
        // 頁面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await App.init();
            
            // 檢查認證狀態
            if (!AppState.isAuthenticated) {
                Router.navigate('/auth');
                return;
            }
            
            // 載入用戶信息
            loadUserInfo();
            
            // 載入用戶偏好
            await loadUserPreferences();
            
            // 載入當前角色
            await loadCurrentCharacter();
            
            // 載入角色列表
            await loadCharacters();
            
            // 渲染角色卡片
            renderCharacters();
            
            // 標記當前選中的角色
            if (AppState.selectedCharacter && AppState.selectedCharacter.character_id) {
                await markSelectedCharacter(AppState.selectedCharacter.character_id);
            }
        });
        
        // 載入用戶信息
        function loadUserInfo() {
            const user = AppState.currentUser || Utils.storage.get('user');
            if (user) {
                document.getElementById('userNickname').textContent = user.nickname || user.username || '用戶';
            }
        }
        
        // 載入用戶偏好
        async function loadUserPreferences() {
            try {
                const result = await SpecializedApiClients.User.getPreferences();
                if (result.success && result.data) {
                    AppState.preferences = result.data;
                    console.log('載入用戶偏好成功:', result.data);
                } else {
                    AppState.preferences = {};
                    console.log('用戶偏好為空，使用默認設置');
                }
            } catch (error) {
                UI.handleError(error, '載入用戶偏好', false);
                AppState.preferences = {};
            }
        }
        
        // 載入當前角色
        async function loadCurrentCharacter() {
            // 直接從 AppState 或用戶偏好獲取
            selectedCharacter = AppState.selectedCharacter;
            if (!selectedCharacter && AppState.preferences?.default_character) {
                // 標記要自動選擇，等角色列表載入後處理
                console.log('將自動選擇默認角色:', AppState.preferences.default_character);
            }
        }
        
        // 載入角色列表
        async function loadCharacters() {
            // 顯示加載狀態
            displayLoadingState();
            
            try {
                const result = await SpecializedApiClients.Character.getList();
                
                if (result.success && result.data && result.data.characters) {
                    characters = result.data.characters;
                    
                    // 處理角色數據
                    characters = characters.map(char => {
                        const characterType = char.type || 'unknown';
                        const nsfwLevel = char.metadata?.nsfw_max_level || 1;
                        
                        return {
                            ...char,
                            // 直接使用 API 字段，無兼容性映射
                            description: char.description || `${char.name}，一位專業的AI角色。`,
                            tags: char.tags || [],
                            popularity: char.popularity || Math.floor(Math.random() * 100),
                            personality: char.metadata?.personality?.traits || ['友善', '耐心'],
                            title: char.metadata?.title || getCharacterTitle(characterType),
                            nsfw_level: nsfwLevel,
                            chatStyle: char.metadata?.talking_style || getChatStyle(char.id),
                            avatar_url: char.metadata?.avatar_url,
                            contentInfo: getContentInfo(nsfwLevel)
                        };
                    });
                    
                    filteredCharacters = [...characters];
                    renderCharacters();
                    
                    // 處理默認角色選擇
                    await handleDefaultCharacterSelection();
                } else {
                    throw new Error(result.error?.message || '無法載入角色數據');
                }
                
            } catch (error) {
                UI.handleError(error, '載入角色');
                UI.showToast(`載入角色失敗: ${error.message}`, 'error');
                
                // 顯示錯誤狀態
                displayErrorState();
            }
        }
        
        // 處理默認角色選擇
        async function handleDefaultCharacterSelection() {
            if (selectedCharacter) {
                await markSelectedCharacter(selectedCharacter.id);
            } else if (AppState.preferences?.default_character) {
                await markSelectedCharacter(AppState.preferences.default_character);
            }
        }
        
        // 顯示錯誤狀態
        function displayErrorState() {
            const charactersGrid = document.getElementById('characterGrid');
            charactersGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl md:text-5xl mb-4"></i>
                    <h3 class="text-lg md:text-xl font-medium text-gray-900 mb-2">載入角色失敗</h3>
                    <p class="text-sm md:text-base text-gray-600 mb-4">無法從伺服器載入角色數據，請檢查網路連線或稍後再試。</p>
                    <button 
                        class="btn-primary px-4 py-2 md:px-6 md:py-3 font-medium"
                        onclick="loadCharacters()"
                    >
                        <i class="fas fa-sync mr-2"></i>重新載入
                    </button>
                </div>
            `;
        }
        
        // 顯示加載狀態
        function displayLoadingState() {
            const charactersGrid = document.getElementById('characterGrid');
            charactersGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-4xl md:text-5xl mb-4"></i>
                    <h3 class="text-lg md:text-xl font-medium text-gray-900 mb-2">載入中...</h3>
                    <p class="text-sm md:text-base text-gray-600">正在載入角色資料，請稍候</p>
                </div>
            `;
        }
        
        // 根據角色類型獲取標題
        function getCharacterTitle(type) {
            const titles = {
                'dominant': '霸道總裁',
                'gentle': '溫柔醫生',
                'ascetic': '禁慾學者',
                'sunny': '陽光少年',
                'cunning': '狡猾商人'
            };
            return titles[type] || '神秘角色';
        }
        
        // 根據角色類型獲取 NSFW 級別
        function getCharacterNsfwLevel(type) {
            const nsfwLevels = {
                'dominant': 'adult',
                'gentle': 'mild',
                'ascetic': 'safe',
                'sunny': 'safe',
                'cunning': 'mild'
            };
            return nsfwLevels[type] || 'safe';
        }
        
        
        // 獲取對話風格描述
        function getChatStyle(characterId) {
            const styles = {
                'char_001': '霸道而直接，偶爾展現溫柔的一面。喜歡掌控對話節奏，但會細心觀察你的反應。',
                'char_002': '溫和而耐心，總是以關懷的口吻對話。擅長傾聽，會給出貼心的建議和安慰。',
                'char_003': '深邃而理性，喜歡分享知識和見解。對話富有哲學性，能引導你思考更深層的問題。'
            };
            return styles[characterId] || '友善而有趣的對話夥伴，能適應各種話題和情境。';
        }
        
        // 獲取內容分級信息
        function getContentInfo(nsfwLevel) {
            const info = {
                'safe': '適合所有場合的安全內容，專注於日常對話和情感交流。',
                'mild': '包含輕度浪漫內容，適合成熟的情感表達和親密對話。',
                'adult': '包含成人內容，提供更深層的情感和身體親密度表達。'
            };
            return info[nsfwLevel] || '根據對話情境動態調整內容級別。';
        }
                
        // 渲染角色卡片
        function renderCharacters() {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';
            
            filteredCharacters.forEach(character => {
                const card = createCharacterCard(character);
                grid.appendChild(card);
            });
        }
        
        // 創建角色卡片
        function createCharacterCard(character) {
            const card = document.createElement('div');
            card.className = 'character-card card-minimal p-4 md:p-6 cursor-pointer';
            card.onclick = () => showCharacterModal(character);
            
            const nsfwColor = {
                'safe': 'bg-green-500',
                'mild': 'bg-yellow-500', 
                'adult': 'bg-red-500'
            }[character.nsfw_level] || 'bg-gray-500';
            
            const titleColor = getTitleColorByType(character.type);
            
            card.innerHTML = `
                <div class="text-center mb-4">
                    <div class="relative inline-block">
                        <img 
                            src="${character.avatar_url}" 
                            alt="${character.name}"
                            class="w-16 h-16 md:w-20 md:h-20 rounded-full mx-auto border-2 border-gray-200 transition-all object-cover"
                        >
                        <div class="absolute -top-1 -right-1">
                            <span class="${nsfwColor} w-3 h-3 rounded-full block"></span>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mb-3">
                    <h3 class="text-base md:text-lg font-medium mb-1">${character.name}</h3>
                    <span class="${titleColor} px-2 py-1 rounded-full text-xs md:text-sm font-medium">${character.title}</span>
                </div>
                
                <p class="text-gray-600 text-xs md:text-sm mb-3 line-clamp-2">${character.description}</p>
                
                <div class="flex flex-wrap gap-1 mb-3">
                    ${(character.tags || []).map(tag => 
                        `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${tag}</span>`
                    ).join('')}
                </div>
                
                <div class="flex items-center justify-between text-xs md:text-sm">
                    <div class="flex items-center text-yellow-600">
                        <i class="fas fa-star mr-1"></i>
                        <span>${character.popularity}%</span>
                    </div>
                    <button 
                        class="btn-primary text-xs md:text-sm px-3 py-1 md:px-4 md:py-2"
                        onclick="event.stopPropagation(); selectCharacter('${character.id}')"
                    >
                        <i class="fas fa-hand-pointer mr-1"></i>
                        選擇
                    </button>
                </div>
            `;
            
            return card;
        }
        
        
        // 根據角色類型獲取標題顏色
        function getTitleColorByType(type) {
            const typeColors = {
                'dominant': 'bg-blue-600 text-white',    // 霸道總裁
                'gentle': 'bg-green-600 text-white',     // 溫柔醫生
                'ascetic': 'bg-purple-600 text-white',   // 禁慾系
                'sunny': 'bg-yellow-600 text-white',     // 陽光系
                'cunning': 'bg-red-600 text-white'       // 腹黑系
            };
            return typeColors[type] || 'bg-gray-600 text-white';
        }
        
        // 顯示角色詳情模態框
        function showCharacterModal(character) {
            document.getElementById('modalAvatar').src = character.avatar_url;
            document.getElementById('modalName').textContent = character.name;
            document.getElementById('modalTitle').textContent = character.title;
            document.getElementById('modalDescription').textContent = character.description;
            document.getElementById('modalPopularity').textContent = character.popularity;
            document.getElementById('modalChatStyle').textContent = character.chatStyle;
            document.getElementById('modalContentInfo').textContent = character.contentInfo;
            
            // 設置 NSFW 標籤
            const nsfwBadge = document.getElementById('modalNsfwBadge');
            const nsfwInfo = {
                'safe': { text: '安全內容', class: 'bg-green-500 text-white' },
                'mild': { text: '輕度內容', class: 'bg-yellow-500 text-white' },
                'adult': { text: '成人內容', class: 'bg-red-500 text-white' }
            }[character.nsfw_level] || { text: '未知', class: 'bg-gray-500 text-white' };
            
            nsfwBadge.textContent = nsfwInfo.text;
            nsfwBadge.className = `px-2 py-1 rounded text-xs font-medium ${nsfwInfo.class}`;
            
            // 設置標題顏色
            const titleElement = document.getElementById('modalTitle');
            const titleColor = getTitleColorByType(character.type);
            titleElement.className = `px-3 py-1 rounded-full text-sm font-medium ${titleColor}`;
            
            // 設置性格特徵
            const personalityDiv = document.getElementById('modalPersonality');
            const traits = character.personality || [];
            personalityDiv.innerHTML = traits.map(trait => 
                `<span class="bg-blue-700 text-blue-200 px-3 py-1 rounded-full text-sm">${trait}</span>`
            ).join('');
            
            // 保存當前查看的角色
            window.currentModalCharacter = character;
            
            UI.modal.show('characterModal');
        }
        
        // 從模態框選擇角色
        async function selectCharacterFromModal() {
            if (window.currentModalCharacter) {
                await selectCharacter(window.currentModalCharacter.id);
                UI.modal.hide('characterModal');
            }
        }
        
        // 點擊背景關閉模態框
        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                UI.modal.hide('characterModal');
            }
        }
        
        // 選擇角色
        async function selectCharacter(characterId) {
            // 數據驗證
            if (!characterId) {
                UI.showToast('無效的角色 ID', 'error');
                return;
            }
            
            selectedCharacter = characters.find(char => char.id === characterId);
            
            if (!selectedCharacter) {
                UI.showToast('找不到對應的角色資料', 'error');
                return;
            }
            
            try {
                // 更新本地狀態
                AppState.selectedCharacter = selectedCharacter;
                
                // 保存到用戶偏好
                await SpecializedApiClients.User.updatePreferences({
                    preferences: {
                        default_character: characterId
                    }
                });
                AppState.preferences = AppState.preferences || {};
                AppState.preferences.default_character = characterId;
                
                // 檢查現有會話
                await checkExistingSessions(characterId);
                
                // 更新顯示
                updateSelectedCharacterDisplay();
                
                // 滾動到角色面板
                document.getElementById('selectedCharacterPanel')?.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                UI.showToast(`已選擇 ${selectedCharacter.name}，點擊"開始對話"進入聊天`, 'success');
                
            } catch (error) {
                UI.handleError(error, '選擇角色');
                UI.showToast('選擇角色失敗', 'error');
            }
        }
        
        // 更新選中角色顯示
        function updateSelectedCharacterDisplay() {
            if (!selectedCharacter) return;
            
            const panel = document.getElementById('selectedCharacterPanel');
            panel.classList.remove('hidden');
            
            document.getElementById('selectedAvatar').src = selectedCharacter.avatar_url;
            document.getElementById('selectedName').textContent = selectedCharacter.name;
            document.getElementById('selectedDescription').textContent = selectedCharacter.description;
            
            // 設置標題
            const titleElement = document.getElementById('selectedTitle');
            titleElement.textContent = selectedCharacter.title;
            const titleColor = getTitleColorByType(selectedCharacter.type);
            titleElement.className = `px-3 py-1 rounded-full text-sm font-medium ${titleColor}`;
            
            // 設置 NSFW 標籤
            const nsfwBadge = document.getElementById('selectedNsfwBadge');
            const nsfwInfo = {
                'safe': { text: '安全', class: 'bg-green-500 text-white' },
                'mild': { text: '輕度', class: 'bg-yellow-500 text-white' },
                'adult': { text: '成人', class: 'bg-red-500 text-white' }
            }[selectedCharacter.nsfw_level] || { text: '未知', class: 'bg-gray-500 text-white' };
            
            nsfwBadge.textContent = nsfwInfo.text;
            nsfwBadge.className = `px-2 py-1 rounded text-xs font-medium ${nsfwInfo.class}`;
            
            // 設置性格特徵
            const personalityDiv = document.getElementById('selectedPersonality');
            const traits = selectedCharacter.personality || [];
            personalityDiv.innerHTML = traits.map(trait => 
                `<span class="bg-blue-700 text-blue-200 px-2 py-1 rounded text-xs">${trait}</span>`
            ).join('');
            
            // 更新按鈕文字
            updateChatActionButton();
        }
        
        // 更新聊天按鈕文字
        function updateChatActionButton() {
            const chatActionText = document.getElementById('chatActionText');
            const hasExistingSessions = existingSessions && existingSessions.length > 0;
            
            if (hasExistingSessions) {
                chatActionText.textContent = '繼續對話';
                chatActionText.parentElement.className = 'bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded font-semibold';
            } else {
                chatActionText.textContent = '開始對話';
                chatActionText.parentElement.className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-semibold';
            }
        }
        
        // 清除選擇
        function clearSelection() {
            selectedCharacter = null;
            AppState.selectedCharacter = null;
            Utils.storage.remove('selectedCharacter');
            
            document.getElementById('selectedCharacterPanel').classList.add('hidden');
            UI.showToast('已清除選擇', 'info');
        }
        
        // 標記選中的角色
        async function markSelectedCharacter(characterId) {
            if (!characterId) return;
            
            // 尋找對應的角色並自動選擇
            const character = characters.find(char => char.id === characterId);
            if (character) {
                selectedCharacter = character;
                
                // 檢查現有會話
                await checkExistingSessions(characterId);
                
                updateSelectedCharacterDisplay();
            }
        }
        
        // 檢查現有會話
        async function checkExistingSessions(characterId) {
            try {
                const result = await SpecializedApiClients.Chat.getSessions(characterId);
                if (result.success && result.data && result.data.sessions && result.data.sessions.length > 0) {
                    existingSessions = result.data.sessions;
                    console.log(`找到 ${result.data.sessions.length} 個現有會話`);
                    return true;
                } else {
                    existingSessions = [];
                    return false;
                }
            } catch (error) {
                UI.handleError(error, '檢查現有會話', false);
                existingSessions = [];
                return false;
            }
        }
        
        // 開始聊天
        async function startChatting() {
            if (!selectedCharacter) {
                UI.showToast('請先選擇一個角色', 'warning');
                return;
            }
            
            // 驗證角色數據完整性
            if (!selectedCharacter.id || !selectedCharacter.name) {
                UI.showToast('角色數據不完整，請重新選擇', 'error');
                return;
            }
            
            try {
                // 檢查是否有既有會話
                const hasExistingSessions = await checkExistingSessions(selectedCharacter.id);
                
                let sessionId;
                if (hasExistingSessions && existingSessions.length > 0) {
                    // 使用最新的會話
                    sessionId = existingSessions[0].id;
                    console.log('使用既有會話:', sessionId);
                } else {
                    // 創建新會話
                    console.log('創建新會話，角色ID:', selectedCharacter.id);
                    const sessionResult = await SpecializedApiClients.Chat.createSession(selectedCharacter.id, `與 ${selectedCharacter.name} 的對話`);
                    
                    if (sessionResult.success && sessionResult.data) {
                        sessionId = sessionResult.data.id;
                        console.log('新會話創建成功:', sessionId);
                    } else {
                        throw new Error('創建會話失敗：' + (sessionResult.error?.message || '未知錯誤'));
                    }
                }
                
                // 保存會話ID到本地存儲，供chat.html使用
                Utils.storage.set('currentSessionId', sessionId);
                Utils.storage.set('selectedCharacter', selectedCharacter);
                
                // 跳轉到聊天頁面
                Router.navigate('/chat');
                
            } catch (error) {
                UI.handleError(error, '開始聊天');
                UI.showToast(`開始聊天失敗: ${error.message}`, 'error');
            }
        }
        
        // 篩選角色
        function filterCharacters() {
            const nsfwFilter = document.getElementById('nsfwFilter').value;
            
            if (nsfwFilter === 'all') {
                filteredCharacters = [...characters];
            } else {
                filteredCharacters = characters.filter(char => char.nsfw_level === nsfwFilter);
            }
            
            sortCharacters();
        }
        
        // 排序角色
        function sortCharacters() {
            const sortBy = document.getElementById('sortBy').value;
            
            switch (sortBy) {
                case 'popularity':
                    filteredCharacters.sort((a, b) => b.popularity - a.popularity);
                    break;
                case 'name':
                    filteredCharacters.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'newest':
                    // 假設 ID 越大越新
                    filteredCharacters.sort((a, b) => b.id.localeCompare(a.id));
                    break;
            }
            
            renderCharacters();
        }
        
        // 登出
        function logout() {
            if (confirm('確定要登出嗎？')) {
                ApiClient.logout();
                UI.showToast('已登出', 'info');
                Router.navigate('/');
            }
        }
    </script>
    
    <!-- Flowbite Toast 容器 -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2 md:top-5 md:right-5 sm:top-4 sm:right-4 sm:left-4 sm:right-auto sm:max-w-sm"></div>
</body>
</html>