<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thewavess AI Chat - æ¸¬è©¦ç•Œé¢</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
        }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            position: relative;
        }
        
        .status-indicator.online {
            background: var(--success-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.offline {
            background: var(--danger-color);
        }
        
        .status-indicator.loading {
            background: var(--warning-color);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0 10px;
        }
        
        .message.user .avatar {
            background: var(--primary-color);
            color: white;
        }
        
        .message.ai .avatar {
            background: var(--success-color);
            color: white;
        }
        
        .message .content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
        }
        
        .message.user .content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.ai .content {
            background: white;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }
        
        .character-card {
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .character-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .character-card.selected {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .nsfw-indicator {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .nsfw-safe { background: #dcfce7; color: #166534; }
        .nsfw-mild { background: #fef3c7; color: #92400e; }
        .nsfw-adult { background: #fee2e2; color: #991b1b; }
        
        .emotion-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin: 2px;
        }
        
        .emotion-happy { background: #dcfce7; color: #166534; }
        .emotion-sad { background: #dbeafe; color: #1e40af; }
        .emotion-angry { background: #fee2e2; color: #991b1b; }
        .emotion-excited { background: #fef3c7; color: #92400e; }
        .emotion-neutral { background: #f3f4f6; color: #374151; }
        
        .age-verification {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #f87171;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .response-panel {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 12px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-left: 3px solid #e5e7eb;
            padding-left: 15px;
            margin: 5px 0;
        }
        
        .step-indicator.active {
            border-left-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .step-indicator.completed {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .step-indicator.error {
            border-left-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .token-display {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- é ‚éƒ¨ç‹€æ…‹æ¬„ -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="glass-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-robot text-primary fs-3 me-2"></i>
                            <h4 class="mb-0 text-dark">Thewavess AI Chat æ¸¬è©¦ä¸­å¿ƒ</h4>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator offline" id="systemStatus"></span>
                            <span class="text-muted me-3" id="systemStatusText">ç³»çµ±é›¢ç·š</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="checkSystemHealth()">
                                <i class="fas fa-sync-alt"></i> æª¢æŸ¥ç³»çµ±
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å·¦å´ï¼šä¸»è¦æ“ä½œå€ -->
            <div class="col-lg-8">
                <!-- ç”¨æˆ¶æµç¨‹å€ -->
                <div class="glass-card mb-3" id="userFlowSection">
                    <div class="card-header bg-transparent border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>ç”¨æˆ¶æµç¨‹</h5>
                            <div id="currentStep" class="badge bg-secondary">ç­‰å¾…é–‹å§‹</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- å¹´é½¡é©—è­‰ -->
                        <div id="ageVerificationPanel" class="age-verification mb-3" style="display: none;">
                            <h6><i class="fas fa-shield-alt"></i> å¹´é½¡é©—è­‰</h6>
                            <p class="mb-3">æœ¬ç³»çµ±åŒ…å«æˆäººå…§å®¹ï¼Œè«‹ç¢ºèªæ‚¨å·²å¹´æ»¿18æ­²</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-success" onclick="confirmAge(true)">æˆ‘å·²å¹´æ»¿18æ­²</button>
                                <button class="btn btn-danger" onclick="confirmAge(false)">æˆ‘æœªæ»¿18æ­²</button>
                            </div>
                        </div>

                        <!-- è¨»å†Š/ç™»å…¥è¡¨å–® -->
                        <div id="authPanel">
                            <div class="row">
                                <div class="col-md-6" id="authStatusPanel">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="status-indicator offline" id="authStatus"></span>
                                        <span id="authStatusText">æœªç™»å…¥</span>
                                    </div>
                                    <div class="d-grid gap-2" id="authButtons">
                                        <button class="btn btn-primary" onclick="showRegisterForm()">
                                            <i class="fas fa-user-plus"></i> æ–°ç”¨æˆ¶è¨»å†Š
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="showLoginForm()">
                                            <i class="fas fa-sign-in-alt"></i> ç”¨æˆ¶ç™»å…¥
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="quickDemo()">
                                            <i class="fas fa-rocket"></i> å¿«é€Ÿæ¼”ç¤º
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6" id="authFormPanel" style="display: none;">
                                    <!-- è¨»å†Šè¡¨å–® -->
                                    <div id="registerForm" style="display: none;">
                                        <h6>æ–°ç”¨æˆ¶è¨»å†Š</h6>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" id="regUsername" placeholder="ç”¨æˆ¶å">
                                        </div>
                                        <div class="mb-2">
                                            <input type="email" class="form-control form-control-sm" id="regEmail" placeholder="é›»å­éƒµä»¶">
                                        </div>
                                        <div class="mb-2">
                                            <input type="password" class="form-control form-control-sm" id="regPassword" placeholder="å¯†ç¢¼">
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <input type="date" class="form-control form-control-sm" id="regBirthDate">
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select form-control-sm" id="regGender">
                                                    <option value="">é¸æ“‡æ€§åˆ¥</option>
                                                    <option value="male">ç”·æ€§</option>
                                                    <option value="female">å¥³æ€§</option>
                                                    <option value="other">å…¶ä»–</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" id="regNickname" placeholder="æš±ç¨±">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success btn-sm" onclick="registerUser()">è¨»å†Š</button>
                                            <button class="btn btn-secondary btn-sm" onclick="hideAuthForm()">å–æ¶ˆ</button>
                                        </div>
                                    </div>
                                    <!-- ç™»å…¥è¡¨å–® -->
                                    <div id="loginForm" style="display: none;">
                                        <h6>ç”¨æˆ¶ç™»å…¥</h6>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" id="loginUsername" placeholder="ç”¨æˆ¶åæˆ–éƒµç®±">
                                        </div>
                                        <div class="mb-2">
                                            <input type="password" class="form-control form-control-sm" id="loginPassword" placeholder="å¯†ç¢¼">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success btn-sm" onclick="loginUser()">ç™»å…¥</button>
                                            <button class="btn btn-secondary btn-sm" onclick="hideAuthForm()">å–æ¶ˆ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è§’è‰²é¸æ“‡å€ -->
                        <div id="characterPanel" style="display: none;">
                            <h6><i class="fas fa-users me-2"></i>é¸æ“‡èŠå¤©è§’è‰²</h6>
                            <div class="row" id="characterList">
                                <!-- è§’è‰²å¡ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
                            </div>
                            <div class="mt-2 d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="loadCharacters()">
                                    <i class="fas fa-refresh"></i> é‡æ–°è¼‰å…¥è§’è‰²
                                </button>
                                <button class="btn btn-success btn-sm" onclick="startChat()" id="startChatBtn" disabled>
                                    <i class="fas fa-play"></i> é–‹å§‹å°è©±
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å°è©±å€ -->
                <div class="glass-card" id="chatSection" style="display: none;">
                    <div class="card-header bg-transparent border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>AI å°è©±</h5>
                                <small class="text-muted" id="chatInfo">é¸æ“‡è§’è‰²é–‹å§‹å°è©±</small>
                            </div>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="chatModeSelect" onchange="changeChatMode()">
                                    <option value="normal">æ™®é€šæ¨¡å¼</option>
                                    <option value="nsfw">æˆäººæ¨¡å¼</option>
                                </select>
                                <button class="btn btn-outline-danger btn-sm" onclick="endChat()">
                                    <i class="fas fa-stop"></i> çµæŸå°è©±
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="chat-container" id="chatContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-comments fs-1 mb-2"></i>
                                <p>é–‹å§‹æ‚¨çš„ AI å°è©±é«”é©—</p>
                            </div>
                        </div>
                        <div class="p-3 border-top">
                            <div class="input-group">
                                <input type="text" class="form-control" id="messageInput" placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯..." disabled>
                                <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-secondary" onclick="sendTestMessage('safe')">æ¸¬è©¦ï¼šå®‰å…¨å…§å®¹</button>
                                        <button class="btn btn-outline-warning" onclick="sendTestMessage('mild')">æ¸¬è©¦ï¼šè¼•åº¦å…§å®¹</button>
                                        <button class="btn btn-outline-danger" onclick="sendTestMessage('adult')">æ¸¬è©¦ï¼šæˆäººå…§å®¹</button>
                                    </div>
                                    <div class="text-muted small">
                                        æƒ…æ„Ÿç‹€æ…‹: <span id="emotionDisplay" class="emotion-indicator emotion-neutral">ä¸­æ€§</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šç³»çµ±ä¿¡æ¯å’Œç›£æ§ -->
            <div class="col-lg-4">
                <!-- ç³»çµ±ç‹€æ…‹ -->
                <div class="glass-card mb-3">
                    <div class="card-header bg-transparent border-0">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>ç³»çµ±ç›£æ§</h6>
                    </div>
                    <div class="card-body">
                        <div id="systemStats">
                            <div class="d-flex justify-content-between mb-2">
                                <span>API ç‹€æ…‹:</span>
                                <span class="status-indicator offline" id="apiStatusDot"></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>æ•¸æ“šåº«:</span>
                                <span class="status-indicator offline" id="dbStatusDot"></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>æ–‡æª”:</span>
                                <span class="status-indicator offline" id="docsStatusDot"></span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span>API ç«¯é»:</span>
                                <span id="apiEndpointCount">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token ç®¡ç† -->
                <div class="glass-card mb-3" id="tokenSection" style="display: none;">
                    <div class="card-header bg-transparent border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-key me-2"></i>Token ç®¡ç†</h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshToken()">
                                <i class="fas fa-sync"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="token-display" id="tokenDisplay">
                            æœªå–å¾— Token
                        </div>
                        <div class="mt-2 text-muted small">
                            éæœŸæ™‚é–“: <span id="tokenExpiry">-</span>
                        </div>
                    </div>
                </div>

                <!-- æœƒè©±ç®¡ç† -->
                <div class="glass-card mb-3" id="sessionSection" style="display: none;">
                    <div class="card-header bg-transparent border-0">
                        <h6 class="mb-0"><i class="fas fa-history me-2"></i>æœƒè©±ç®¡ç†</h6>
                    </div>
                    <div class="card-body">
                        <div id="sessionList">
                            <div class="text-muted text-center">æš«ç„¡æœƒè©±</div>
                        </div>
                    </div>
                </div>

                <!-- API éŸ¿æ‡‰æ—¥å¿— -->
                <div class="glass-card">
                    <div class="card-header bg-transparent border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>API æ—¥å¿—</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary active" onclick="filterLogs('all')">å…¨éƒ¨</button>
                                <button class="btn btn-outline-success" onclick="filterLogs('success')">æˆåŠŸ</button>
                                <button class="btn btn-outline-danger" onclick="filterLogs('error')">éŒ¯èª¤</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="response-panel" id="apiLogPanel">
ç­‰å¾… API èª¿ç”¨...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div class="glass-card mt-3" id="progressSection" style="display: none;">
            <div class="card-body">
                <h6><i class="fas fa-tasks me-2"></i>æ¸¬è©¦é€²åº¦</h6>
                <div id="progressSteps">
                    <div class="step-indicator" id="step1">
                        <i class="fas fa-heart-pulse me-2"></i>ç³»çµ±å¥åº·æª¢æŸ¥
                    </div>
                    <div class="step-indicator" id="step2">
                        <i class="fas fa-user-check me-2"></i>å¹´é½¡é©—è­‰èˆ‡ç”¨æˆ¶èªè­‰
                    </div>
                    <div class="step-indicator" id="step3">
                        <i class="fas fa-users me-2"></i>è§’è‰²è¼‰å…¥èˆ‡é¸æ“‡
                    </div>
                    <div class="step-indicator" id="step4">
                        <i class="fas fa-play me-2"></i>æœƒè©±å‰µå»ºèˆ‡åˆå§‹åŒ–
                    </div>
                    <div class="step-indicator" id="step5">
                        <i class="fas fa-comments me-2"></i>å°è©±äº¤äº’æ¸¬è©¦
                    </div>
                    <div class="step-indicator" id="step6">
                        <i class="fas fa-shield-check me-2"></i>å…§å®¹åˆ†ç´šèˆ‡æƒ…æ„Ÿç‹€æ…‹æ¸¬è©¦
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // æ‡‰ç”¨ç‹€æ…‹ç®¡ç†
        const AppState = {
            // ç³»çµ±ç‹€æ…‹
            systemOnline: false,
            apiEndpoints: 0,
            
            // ç”¨æˆ¶ç‹€æ…‹
            isAuthenticated: false,
            currentUser: null,
            accessToken: null,
            refreshToken: null,
            tokenExpiry: null,
            ageVerified: false,
            
            // èŠå¤©ç‹€æ…‹
            selectedCharacter: null,
            currentSession: null,
            chatMode: 'normal',
            messages: [],
            emotions: ['neutral'],
            
            // æ¸¬è©¦ç‹€æ…‹
            testProgress: [],
            apiLogs: []
        };

        // æ¸¬è©¦å ´æ™¯é…ç½®
        const TestScenarios = {
            safe: {
                messages: [
                    "ä½ å¥½ï¼Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼",
                    "ä½ ä»Šå¤©éå¾—æ€éº¼æ¨£ï¼Ÿ",
                    "èƒ½å‘Šè¨´æˆ‘ä¸€äº›é—œæ–¼ä½ çš„èˆˆè¶£å—ï¼Ÿ"
                ],
                nsfwLevel: 'safe'
            },
            mild: {
                messages: [
                    "ä½ å°æµªæ¼«ç´„æœƒæœ‰ä»€éº¼æƒ³æ³•ï¼Ÿ",
                    "å–œæ­¡ä»€éº¼æ¨£çš„è¦ªå¯†äº’å‹•ï¼Ÿ",
                    "å°æ–¼æ„Ÿæƒ…é—œä¿‚ä½ æœ‰ä»€éº¼æœŸå¾…ï¼Ÿ"
                ],
                nsfwLevel: 'mild'
            },
            adult: {
                messages: [
                    "ä½ å°æ–¼è¦ªå¯†é—œä¿‚æœ‰ä»€éº¼æƒ³æ³•ï¼Ÿ",
                    "åœ¨ç§äººæ™‚å…‰ä½ å–œæ­¡åšä»€éº¼ï¼Ÿ",
                    "å°æ–¼èº«é«”æ¥è§¸ä½ æœ‰ä»€éº¼åå¥½ï¼Ÿ"
                ],
                nsfwLevel: 'adult'
            }
        };

        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            updateCurrentStep('æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...');
            showProgressSection(true);
            updateProgressStep('step1', 'active');
            
            await checkSystemHealth();
            await sleep(500);
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦å¹´é½¡é©—è­‰
            if (!AppState.ageVerified) {
                showAgeVerification();
            }
        }

        // ===== ç³»çµ±å¥åº·æª¢æŸ¥ =====
        async function checkSystemHealth() {
            updateProgressStep('step1', 'active');
            updateSystemStatus('loading');
            
            try {
                // æª¢æŸ¥å¥åº·ç‹€æ…‹
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                logApiCall('GET', '/health', healthResponse.status, healthData);
                
                // æª¢æŸ¥ Swagger æ–‡æª”
                const swaggerResponse = await fetch('/swagger/doc.json');
                const swaggerData = await swaggerResponse.json();
                logApiCall('GET', '/swagger/doc.json', swaggerResponse.status, swaggerData);
                
                // æ›´æ–°ç³»çµ±ç‹€æ…‹
                const systemHealthy = healthResponse.ok && healthData.database === 'healthy';
                const docsAvailable = swaggerResponse.ok;
                
                AppState.systemOnline = systemHealthy;
                AppState.apiEndpoints = swaggerData.paths ? Object.keys(swaggerData.paths).length : 0;
                
                updateSystemStatus(systemHealthy ? 'online' : 'offline');
                updateSystemStats(systemHealthy, healthData.database === 'healthy', docsAvailable);
                
                updateProgressStep('step1', 'completed');
                showToast('ç³»çµ±æª¢æŸ¥å®Œæˆ', systemHealthy ? 'success' : 'warning');
                
            } catch (error) {
                updateProgressStep('step1', 'error');
                updateSystemStatus('offline');
                logApiCall('GET', '/health', 0, { error: error.message });
                showToast('ç³»çµ±æª¢æŸ¥å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // ===== å¹´é½¡é©—è­‰ =====
        function showAgeVerification() {
            updateCurrentStep('éœ€è¦å¹´é½¡é©—è­‰');
            updateProgressStep('step2', 'active');
            document.getElementById('ageVerificationPanel').style.display = 'block';
        }

        function confirmAge(isAdult) {
            AppState.ageVerified = isAdult;
            document.getElementById('ageVerificationPanel').style.display = 'none';
            
            if (isAdult) {
                updateProgressStep('step2', 'completed');
                showToast('å¹´é½¡é©—è­‰é€šé', 'success');
                updateCurrentStep('ç­‰å¾…ç”¨æˆ¶ç™»å…¥');
            } else {
                updateProgressStep('step2', 'error');
                showToast('å¹´é½¡é©—è­‰å¤±æ•—ï¼Œéƒ¨åˆ†åŠŸèƒ½å°‡è¢«é™åˆ¶', 'warning');
                updateCurrentStep('å—é™æ¨¡å¼ - åƒ…å®‰å…¨å…§å®¹');
            }
        }

        // ===== ç”¨æˆ¶èªè­‰ =====
        function showRegisterForm() {
            document.getElementById('authFormPanel').style.display = 'block';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
        }

        function showLoginForm() {
            document.getElementById('authFormPanel').style.display = 'block';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function hideAuthForm() {
            document.getElementById('authFormPanel').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
        }

        async function registerUser() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const birthDate = document.getElementById('regBirthDate').value;
            const gender = document.getElementById('regGender').value;
            const nickname = document.getElementById('regNickname').value;

            if (!username || !email || !password || !birthDate || !gender) {
                showToast('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'warning');
                return;
            }

            updateProgressStep('step2', 'active');
            updateCurrentStep('æ­£åœ¨è¨»å†Šç”¨æˆ¶...');

            try {
                const userData = {
                    username,
                    email,
                    password,
                    birth_date: birthDate,
                    gender,
                    nickname: nickname || username
                };

                const response = await fetch('/api/v1/user/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                logApiCall('POST', '/api/v1/user/register', response.status, data);

                if (response.ok && data.success) {
                    AppState.currentUser = userData;
                    hideAuthForm();
                    showToast('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥', 'success');
                    
                    // è‡ªå‹•å¡«å…¥ç™»å…¥è¡¨å–®
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = password;
                    showLoginForm();
                    
                } else {
                    throw new Error(data.error?.message || 'è¨»å†Šå¤±æ•—');
                }
            } catch (error) {
                updateProgressStep('step2', 'error');
                showToast('è¨»å†Šå¤±æ•—: ' + error.message, 'danger');
            }
        }

        async function loginUser() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('è«‹è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼', 'warning');
                return;
            }

            updateProgressStep('step2', 'active');
            updateCurrentStep('æ­£åœ¨ç™»å…¥...');

            try {
                const response = await fetch('/api/v1/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                logApiCall('POST', '/api/v1/user/login', response.status, data);

                if (response.ok && data.success) {
                    AppState.isAuthenticated = true;
                    AppState.accessToken = data.data.access_token;
                    AppState.refreshToken = data.data.refresh_token;
                    AppState.tokenExpiry = new Date(Date.now() + (data.data.expires_in * 1000));
                    
                    updateAuthStatus(true, username);
                    hideAuthForm();
                    showTokenSection(true);
                    updateTokenDisplay();
                    
                    updateProgressStep('step2', 'completed');
                    updateCurrentStep('ç”¨æˆ¶å·²ç™»å…¥');
                    showToast('ç™»å…¥æˆåŠŸï¼', 'success');
                    
                    // é€²å…¥ä¸‹ä¸€éšæ®µï¼šè§’è‰²é¸æ“‡
                    await nextPhase_CharacterSelection();
                    
                } else {
                    throw new Error(data.error?.message || 'ç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                updateProgressStep('step2', 'error');
                showToast('ç™»å…¥å¤±æ•—: ' + error.message, 'danger');
            }
        }

        async function quickDemo() {
            updateCurrentStep('æ­£åœ¨åŸ·è¡Œå¿«é€Ÿæ¼”ç¤º...');
            showToast('æ­£åœ¨å‰µå»ºæ¼”ç¤ºç”¨æˆ¶...', 'info');
            
            // è‡ªå‹•ç”Ÿæˆæ¼”ç¤ºç”¨æˆ¶è³‡æ–™
            const timestamp = Date.now();
            const demoUser = {
                username: `demo_${timestamp}`,
                email: `demo_${timestamp}@test.com`,
                password: 'Demo123456!',
                birth_date: '1995-06-15',
                gender: 'female',
                nickname: 'æ¼”ç¤ºç”¨æˆ¶'
            };

            // è‡ªå‹•å¡«å…¥è¨»å†Šè¡¨å–®
            document.getElementById('regUsername').value = demoUser.username;
            document.getElementById('regEmail').value = demoUser.email;
            document.getElementById('regPassword').value = demoUser.password;
            document.getElementById('regBirthDate').value = demoUser.birth_date;
            document.getElementById('regGender').value = demoUser.gender;
            document.getElementById('regNickname').value = demoUser.nickname;

            // åŸ·è¡Œè¨»å†Šå’Œç™»å…¥
            await registerUser();
            await sleep(1000);
            if (AppState.currentUser) {
                await loginUser();
            }
        }

        // ===== è§’è‰²é¸æ“‡éšæ®µ =====
        async function nextPhase_CharacterSelection() {
            updateProgressStep('step3', 'active');
            updateCurrentStep('è¼‰å…¥è§’è‰²åˆ—è¡¨...');
            
            document.getElementById('characterPanel').style.display = 'block';
            await loadCharacters();
        }

        async function loadCharacters() {
            if (!AppState.isAuthenticated) {
                showToast('è«‹å…ˆç™»å…¥', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/v1/character/list', {
                    headers: { 'Authorization': `Bearer ${AppState.accessToken}` }
                });

                const data = await response.json();
                logApiCall('GET', '/api/v1/character/list', response.status, data);

                if (response.ok && data.success && data.data) {
                    displayCharacters(data.data);
                    updateProgressStep('step3', 'completed');
                    updateCurrentStep('è«‹é¸æ“‡èŠå¤©è§’è‰²');
                } else {
                    // å¦‚æœæ²’æœ‰è§’è‰²ï¼Œå‰µå»ºä¸€äº›æ¸¬è©¦è§’è‰²
                    displayTestCharacters();
                }
            } catch (error) {
                updateProgressStep('step3', 'error');
                showToast('è¼‰å…¥è§’è‰²å¤±æ•—: ' + error.message, 'danger');
                displayTestCharacters();
            }
        }

        function displayCharacters(characters) {
            const container = document.getElementById('characterList');
            container.innerHTML = '';

            characters.forEach(character => {
                const card = createCharacterCard(character);
                container.appendChild(card);
            });
        }

        function displayTestCharacters() {
            const testCharacters = [
                {
                    id: 'char_001',
                    name: 'Luna',
                    description: 'å‹å–„çš„AIåŠ©æ‰‹ï¼Œæ“…é•·æ—¥å¸¸å°è©±',
                    avatar: 'ğŸ‘©â€ğŸ¦°',
                    personality: ['friendly', 'helpful', 'creative'],
                    nsfw_level: 'safe'
                },
                {
                    id: 'char_002',
                    name: 'Alex',
                    description: 'æˆç†Ÿçš„å°è©±ä¼´ä¾¶ï¼Œå¯ä»¥è¨è«–å„ç¨®è©±é¡Œ',
                    avatar: 'ğŸ‘¨â€ğŸ’¼',
                    personality: ['mature', 'intelligent', 'romantic'],
                    nsfw_level: 'mild'
                },
                {
                    id: 'char_003',
                    name: 'Sophia',
                    description: 'é–‹æ”¾çš„èŠå¤©å¤¥ä¼´ï¼Œé©åˆæ·±åº¦äº¤æµ',
                    avatar: 'ğŸ‘¸',
                    personality: ['open', 'passionate', 'intimate'],
                    nsfw_level: 'adult'
                }
            ];

            displayCharacters(testCharacters);
            updateProgressStep('step3', 'completed');
        }

        function createCharacterCard(character) {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-3';
            
            const nsfwClass = {
                'safe': 'nsfw-safe',
                'mild': 'nsfw-mild', 
                'adult': 'nsfw-adult'
            };

            col.innerHTML = `
                <div class="character-card" onclick="selectCharacter('${character.id}', this)">
                    <div class="text-center mb-2">
                        <div style="font-size: 3rem;">${character.avatar || 'ğŸ¤–'}</div>
                    </div>
                    <h6 class="text-center mb-2">${character.name}</h6>
                    <p class="text-muted small mb-2">${character.description}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="nsfw-indicator ${nsfwClass[character.nsfw_level] || 'nsfw-safe'}">${character.nsfw_level}</span>
                        <div>
                            ${(character.personality || []).map(trait => 
                                `<span class="badge bg-light text-dark me-1">${trait}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        function selectCharacter(characterId, cardElement) {
            // ç§»é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é¸ä¸­ç•¶å‰è§’è‰²
            cardElement.classList.add('selected');
            AppState.selectedCharacter = characterId;
            
            document.getElementById('startChatBtn').disabled = false;
            updateCurrentStep(`å·²é¸æ“‡è§’è‰²: ${characterId}`);
        }

        async function startChat() {
            if (!AppState.selectedCharacter) {
                showToast('è«‹å…ˆé¸æ“‡ä¸€å€‹è§’è‰²', 'warning');
                return;
            }

            updateProgressStep('step4', 'active');
            updateCurrentStep('æ­£åœ¨å‰µå»ºå°è©±æœƒè©±...');

            try {
                const response = await fetch('/api/v1/chat/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AppState.accessToken}`
                    },
                    body: JSON.stringify({
                        character_id: AppState.selectedCharacter,
                        title: `èˆ‡ ${AppState.selectedCharacter} çš„å°è©±`,
                        mode: AppState.chatMode
                    })
                });

                const data = await response.json();
                logApiCall('POST', '/api/v1/chat/session', response.status, data);

                if (response.ok && data.success) {
                    AppState.currentSession = data.data;
                    
                    // åˆ‡æ›åˆ°èŠå¤©ç•Œé¢
                    document.getElementById('chatSection').style.display = 'block';
                    document.getElementById('characterPanel').style.display = 'none';
                    
                    // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    
                    // æ›´æ–°æœƒè©±ä¿¡æ¯
                    updateChatInfo();
                    showSessionSection(true);
                    
                    updateProgressStep('step4', 'completed');
                    updateProgressStep('step5', 'active');
                    updateCurrentStep('å°è©±æœƒè©±å·²æº–å‚™å°±ç·’');
                    showToast('å°è©±æœƒè©±å‰µå»ºæˆåŠŸï¼', 'success');
                    
                    // ç™¼é€æ­¡è¿æ¶ˆæ¯
                    addMessage('ai', `ä½ å¥½ï¼æˆ‘æ˜¯ ${AppState.selectedCharacter}ï¼Œå¾ˆé«˜èˆˆå’Œä½ èŠå¤©ï¼`, 'happy');
                    
                } else {
                    throw new Error(data.error?.message || 'å‰µå»ºæœƒè©±å¤±æ•—');
                }
            } catch (error) {
                updateProgressStep('step4', 'error');
                showToast('å‰µå»ºæœƒè©±å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // ===== å°è©±ç®¡ç† =====
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!AppState.currentSession) {
                showToast('è«‹å…ˆé–‹å§‹å°è©±æœƒè©±', 'warning');
                return;
            }

            input.value = '';
            addMessage('user', message);
            
            updateProgressStep('step5', 'active');
            await sendApiMessage(message);
        }

        async function sendTestMessage(scenario) {
            const testData = TestScenarios[scenario];
            if (!testData) return;

            const message = testData.messages[Math.floor(Math.random() * testData.messages.length)];
            addMessage('user', `[${scenario.toUpperCase()} æ¸¬è©¦] ${message}`);
            
            updateProgressStep('step6', 'active');
            await sendApiMessage(message, testData.nsfwLevel);
        }

        async function sendApiMessage(message, expectedNsfwLevel = null) {
            try {
                const response = await fetch('/api/v1/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AppState.accessToken}`
                    },
                    body: JSON.stringify({
                        session_id: AppState.currentSession.id,
                        message: message
                    })
                });

                const data = await response.json();
                logApiCall('POST', '/api/v1/chat/message', response.status, data);

                if (response.ok && data.success) {
                    // è™•ç†AIå›æ‡‰
                    const aiResponse = data.data.reply || 'æˆ‘æ”¶åˆ°äº†ä½ çš„è¨Šæ¯ï¼';
                    const emotion = data.data.emotion || 'neutral';
                    const nsfwLevel = data.data.nsfw_level || 'safe';
                    
                    addMessage('ai', aiResponse, emotion, nsfwLevel);
                    updateEmotionDisplay(emotion);
                    
                    // å¦‚æœæ˜¯NSFWæ¸¬è©¦ï¼Œé©—è­‰åˆ†ç´š
                    if (expectedNsfwLevel && expectedNsfwLevel !== nsfwLevel) {
                        addMessage('system', `âš ï¸ NSFWåˆ†ç´šæ¸¬è©¦: é æœŸ ${expectedNsfwLevel}, å¯¦éš› ${nsfwLevel}`, 'neutral', 'system');
                    }
                    
                    updateProgressStep('step5', 'completed');
                    if (expectedNsfwLevel) {
                        updateProgressStep('step6', 'completed');
                    }
                    
                } else {
                    throw new Error(data.error?.message || 'APIèª¿ç”¨å¤±æ•—');
                }
            } catch (error) {
                addMessage('system', `âŒ ç™¼é€å¤±æ•—: ${error.message}`, 'neutral', 'error');
                updateProgressStep('step5', 'error');
            }
        }

        function addMessage(sender, content, emotion = 'neutral', nsfwLevel = 'safe') {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            let avatar, bgClass = '';
            switch (sender) {
                case 'user':
                    avatar = 'ğŸ‘¤';
                    break;
                case 'ai':
                    avatar = 'ğŸ¤–';
                    break;
                case 'system':
                    avatar = 'âš™ï¸';
                    bgClass = 'bg-light';
                    break;
            }

            const nsfwBadge = nsfwLevel !== 'safe' ? 
                `<span class="nsfw-indicator nsfw-${nsfwLevel} ms-2">${nsfwLevel}</span>` : '';

            messageDiv.innerHTML = `
                <div class="avatar">${avatar}</div>
                <div class="content ${bgClass}">
                    ${content}
                    ${nsfwBadge}
                    <div class="text-muted small mt-1">
                        ${new Date().toLocaleTimeString()}
                        ${emotion !== 'neutral' ? `<span class="emotion-indicator emotion-${emotion} ms-2">${emotion}</span>` : ''}
                    </div>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // ä¿å­˜åˆ°ç‹€æ…‹
            AppState.messages.push({
                sender, content, emotion, nsfwLevel, timestamp: new Date()
            });
        }

        function changeChatMode() {
            const mode = document.getElementById('chatModeSelect').value;
            AppState.chatMode = mode;
            
            if (mode === 'nsfw' && !AppState.ageVerified) {
                showToast('æˆäººæ¨¡å¼éœ€è¦å¹´é½¡é©—è­‰', 'warning');
                document.getElementById('chatModeSelect').value = 'normal';
                AppState.chatMode = 'normal';
                return;
            }
            
            addMessage('system', `åˆ‡æ›åˆ° ${mode === 'nsfw' ? 'æˆäºº' : 'æ™®é€š'} æ¨¡å¼`, 'neutral', 'system');
        }

        function endChat() {
            AppState.currentSession = null;
            AppState.selectedCharacter = null;
            AppState.messages = [];
            
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('characterPanel').style.display = 'block';
            document.getElementById('chatContainer').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-comments fs-1 mb-2"></i>
                    <p>é–‹å§‹æ‚¨çš„ AI å°è©±é«”é©—</p>
                </div>
            `;
            
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('startChatBtn').disabled = true;
            
            // ç§»é™¤è§’è‰²é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            updateCurrentStep('å°è©±å·²çµæŸï¼Œè«‹é‡æ–°é¸æ“‡è§’è‰²');
            showToast('å°è©±å·²çµæŸ', 'info');
        }

        // ===== Token ç®¡ç† =====
        async function refreshToken() {
            if (!AppState.refreshToken) {
                showToast('ç„¡æ³•åˆ·æ–°Tokenï¼Œè«‹é‡æ–°ç™»å…¥', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/v1/user/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: AppState.refreshToken })
                });

                const data = await response.json();
                logApiCall('POST', '/api/v1/user/refresh', response.status, data);

                if (response.ok && data.success) {
                    AppState.accessToken = data.data.access_token;
                    AppState.tokenExpiry = new Date(Date.now() + (data.data.expires_in * 1000));
                    updateTokenDisplay();
                    showToast('Tokenåˆ·æ–°æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error?.message || 'Tokenåˆ·æ–°å¤±æ•—');
                }
            } catch (error) {
                showToast('Tokenåˆ·æ–°å¤±æ•—: ' + error.message, 'danger');
            }
        }

        // ===== UI æ›´æ–°å‡½æ•¸ =====
        function updateSystemStatus(status) {
            const indicator = document.getElementById('systemStatus');
            const text = document.getElementById('systemStatusText');
            
            indicator.className = `status-indicator ${status}`;
            switch (status) {
                case 'online':
                    text.textContent = 'ç³»çµ±åœ¨ç·š';
                    break;
                case 'loading':
                    text.textContent = 'æª¢æŸ¥ä¸­...';
                    break;
                default:
                    text.textContent = 'ç³»çµ±é›¢ç·š';
            }
        }

        function updateSystemStats(apiOnline, dbOnline, docsOnline) {
            document.getElementById('apiStatusDot').className = `status-indicator ${apiOnline ? 'online' : 'offline'}`;
            document.getElementById('dbStatusDot').className = `status-indicator ${dbOnline ? 'online' : 'offline'}`;
            document.getElementById('docsStatusDot').className = `status-indicator ${docsOnline ? 'online' : 'offline'}`;
            document.getElementById('apiEndpointCount').textContent = AppState.apiEndpoints;
        }

        function updateAuthStatus(isLoggedIn, username = '') {
            const indicator = document.getElementById('authStatus');
            const text = document.getElementById('authStatusText');
            
            if (isLoggedIn) {
                indicator.className = 'status-indicator online';
                text.textContent = `å·²ç™»å…¥: ${username}`;
                document.getElementById('authButtons').style.display = 'none';
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = 'æœªç™»å…¥';
                document.getElementById('authButtons').style.display = 'block';
            }
        }

        function updateTokenDisplay() {
            if (AppState.accessToken) {
                const tokenPreview = AppState.accessToken.substring(0, 50) + '...';
                document.getElementById('tokenDisplay').textContent = tokenPreview;
                document.getElementById('tokenExpiry').textContent = 
                    AppState.tokenExpiry ? AppState.tokenExpiry.toLocaleString() : 'æœªçŸ¥';
            }
        }

        function updateChatInfo() {
            if (AppState.currentSession) {
                document.getElementById('chatInfo').textContent = 
                    `æœƒè©± ${AppState.currentSession.id} | è§’è‰²: ${AppState.selectedCharacter}`;
            }
        }

        function updateCurrentStep(step) {
            document.getElementById('currentStep').textContent = step;
        }

        function updateProgressStep(stepId, status) {
            const element = document.getElementById(stepId);
            if (element) {
                element.className = `step-indicator ${status}`;
            }
        }

        function updateEmotionDisplay(emotion) {
            const display = document.getElementById('emotionDisplay');
            const emotionMap = {
                'happy': 'å¿«æ¨‚',
                'sad': 'æ‚²å‚·', 
                'angry': 'æ†¤æ€’',
                'excited': 'èˆˆå¥®',
                'neutral': 'ä¸­æ€§'
            };
            
            display.className = `emotion-indicator emotion-${emotion}`;
            display.textContent = emotionMap[emotion] || emotion;
            
            AppState.emotions.push(emotion);
        }

        function showProgressSection(show) {
            document.getElementById('progressSection').style.display = show ? 'block' : 'none';
        }

        function showTokenSection(show) {
            document.getElementById('tokenSection').style.display = show ? 'block' : 'none';
        }

        function showSessionSection(show) {
            document.getElementById('sessionSection').style.display = show ? 'block' : 'none';
        }

        // ===== API æ—¥èªŒç®¡ç† =====
        function logApiCall(method, endpoint, status, data) {
            const log = {
                timestamp: new Date().toLocaleTimeString(),
                method,
                endpoint,
                status,
                data,
                isSuccess: status >= 200 && status < 300
            };
            
            AppState.apiLogs.unshift(log);
            if (AppState.apiLogs.length > 50) {
                AppState.apiLogs = AppState.apiLogs.slice(0, 50);
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const panel = document.getElementById('apiLogPanel');
            if (AppState.apiLogs.length === 0) {
                panel.textContent = 'ç­‰å¾… API èª¿ç”¨...';
                return;
            }
            
            const latest = AppState.apiLogs.slice(0, 5);
            let content = '';
            
            latest.forEach(log => {
                const icon = log.isSuccess ? 'âœ…' : 'âŒ';
                content += `${icon} [${log.timestamp}] ${log.method} ${log.endpoint} (${log.status})\n`;
                content += JSON.stringify(log.data, null, 2) + '\n\n';
            });
            
            panel.textContent = content;
        }

        function filterLogs(type) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#apiLogPanel').parent().find('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // TODO: å¯¦ç¾æ—¥èªŒç¯©é¸é‚è¼¯
            updateLogDisplay();
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function showToast(message, type = 'info') {
            // ç°¡å–®çš„æç¤ºå¯¦ç¾ï¼Œå¯ä»¥æ›¿æ›ç‚º Bootstrap Toast
            const alertClass = {
                'success': 'alert-success',
                'danger': 'alert-danger', 
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // ä¹Ÿå¯ä»¥æ·»åŠ å¯¦éš›çš„ toast é€šçŸ¥
            const toast = document.createElement('div');
            toast.className = `alert ${alertClass[type]} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== éµç›¤äº‹ä»¶ =====
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'messageInput') {
                sendMessage();
            }
        });

        // ===== é–‹ç™¼è€…å·¥å…· =====
        window.AppState = AppState; // èª¿è©¦ç”¨
        window.TestScenarios = TestScenarios; // èª¿è©¦ç”¨
    </script>
</body>
</html>