<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°è©± - Thewavess AI Core</title>
    
    <!-- Tailwind CSS 3.4.17 -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
</head>
<body class="h-full flex flex-col bg-gray-50 text-gray-900">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-white border rounded-lg m-4 mb-0 p-4 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button 
                    class="bg-gray-600 hover:bg-gray-700 text-white p-2 rounded"
                    onclick="Router.navigate('/character')"
                >
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <div class="flex items-center space-x-3">
                    <img 
                        id="characterAvatar"
                        class="w-10 h-10 rounded-full border-2 border-purple-400"
                        src=""
                        alt="è§’è‰²é ­åƒ"
                    >
                    <div>
                        <h1 class="text-lg font-bold" id="characterName">--</h1>
                        <div class="text-sm" id="characterStatus">æ­£åœ¨è¼¸å…¥...</div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <!-- æƒ…æ„Ÿç‹€æ…‹ -->
                <div class="bg-gray-100 border rounded px-3 py-2 text-sm">
                    <i class="fas fa-heart text-red-400 mr-1"></i>
                    <span id="affectionLevel">50</span>
                </div>
                
                <!-- æ¨¡å¼åˆ‡æ› -->
                <select 
                    id="chatMode"
                    class="px-3 py-2 rounded bg-white border border-gray-300 text-gray-900 text-sm"
                    onchange="changeChatMode()"
                >
                    <option value="normal">æ™®é€šæ¨¡å¼</option>
                    <option value="novel">å°èªªæ¨¡å¼</option>
                    <option value="nsfw">æˆäººæ¨¡å¼</option>
                </select>
                
                <!-- åŠŸèƒ½èœå–® -->
                <div class="relative">
                    <button 
                        id="menuToggle"
                        class="bg-gray-600 hover:bg-gray-700 text-white p-2 rounded"
                        onclick="toggleMenu()"
                    >
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    
                    <div id="menuDropdown" class="hidden absolute right-0 top-12 bg-white border rounded p-2 min-w-[150px] z-10">
                        <button class="w-full text-left px-3 py-2 hover:bg-white hover:bg-opacity-10 rounded" onclick="newSession()">
                            <i class="fas fa-plus mr-2"></i>æ–°å°è©±
                        </button>
                        <button class="w-full text-left px-3 py-2 hover:bg-white hover:bg-opacity-10 rounded" onclick="showSessionList()">
                            <i class="fas fa-list mr-2"></i>æœƒè©±åˆ—è¡¨
                        </button>
                        <button class="w-full text-left px-3 py-2 hover:bg-white hover:bg-opacity-10 rounded" onclick="exportChat()">
                            <i class="fas fa-download mr-2"></i>åŒ¯å‡ºå°è©±
                        </button>
                        <button class="w-full text-left px-3 py-2 hover:bg-white hover:bg-opacity-10 rounded" onclick="clearChat()">
                            <i class="fas fa-trash mr-2"></i>æ¸…ç©ºå°è©±
                        </button>
                        <button class="w-full text-left px-3 py-2 hover:bg-white hover:bg-opacity-10 rounded text-red-600" onclick="deleteCurrentSession()">
                            <i class="fas fa-trash-alt mr-2"></i>åˆªé™¤æœƒè©±
                        </button>
                        <hr class="my-2 border-gray-600">
                        <button class="w-full text-left px-3 py-2 hover:bg-white hover:bg-opacity-10 rounded" onclick="Router.navigate('/profile')">
                            <i class="fas fa-user mr-2"></i>å€‹äººè³‡æ–™
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- èŠå¤©å€åŸŸ -->
    <div class="flex-1 flex mx-4 mb-4 space-x-4 min-h-0">
        <!-- ä¸»èŠå¤©å€ -->
        <div class="flex-1 flex flex-col bg-white border rounded-lg overflow-hidden">
            <!-- å ´æ™¯æè¿° -->
            <div id="sceneDescription" class="bg-blue-50 border-b border-gray-200 p-4 text-sm italic text-gray-700">
                <i class="fas fa-image mr-2"></i>
                <span id="sceneText">æº–å‚™é–‹å§‹å°è©±...</span>
            </div>
            
            <!-- æ¶ˆæ¯å€åŸŸ -->
            <div class="flex-1 p-4 overflow-y-auto overflow-y-auto" id="messagesArea">
                <div class="space-y-4" id="messagesList">
                    <!-- æ­¡è¿æ¶ˆæ¯ -->
                    <div class="flex items-start space-x-3">
                        <img 
                            id="welcomeAvatar"
                            class="w-8 h-8 rounded-full"
                            src=""
                            alt="AI"
                        >
                        <div class="bg-white border rounded p-3 max-w-[80%]">
                            <p id="welcomeMessage">æ­¡è¿ä¾†åˆ° AI å°è©±ï¼æ­£åœ¨ç‚ºæ‚¨å‰µå»ºå°ˆå±¬æœƒè©±...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¼¸å…¥å€åŸŸ -->
            <div class="border-t border-gray-600 p-4">
                <div class="flex space-x-3">
                    <div class="flex-1 relative">
                        <textarea 
                            id="messageInput"
                            class="w-full px-4 py-3 rounded bg-white border border-gray-300 text-gray-900 resize-none"
                            placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯..."
                            rows="1"
                            disabled
                        ></textarea>
                        
                        <!-- è¼¸å…¥å¢å¼·åŠŸèƒ½ -->
                        <div class="absolute right-2 top-2 flex space-x-1">
                            <button 
                                class="hover:opacity-80 p-1 transition-colors"
                                onclick="insertEmoji()"
                                title="è¡¨æƒ…ç¬¦è™Ÿ"
                            >
                                <i class="fas fa-smile"></i>
                            </button>
                            <button 
                                class="hover:opacity-80 p-1 transition-colors"
                                onclick="clearInput()"
                                title="æ¸…ç©ºè¼¸å…¥"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button 
                        id="sendButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="sendMessage()"
                        disabled
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- å¿«é€Ÿå›å¾© -->
                <div class="mt-3 flex flex-wrap gap-2" id="quickReplies">
                    <!-- å¿«é€Ÿå›å¾©æŒ‰éˆ•æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- å´é‚Šæ¬„ -->
        <div class="w-80 flex flex-col space-y-4">
            <!-- æƒ…æ„Ÿç‹€æ…‹å¡ç‰‡ -->
            <div class="bg-white border rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3">
                    <i class="fas fa-heart text-red-400 mr-2"></i>
                    æƒ…æ„Ÿç‹€æ…‹
                </h3>
                
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>å¥½æ„Ÿåº¦</span>
                            <span id="affectionDisplay">50/100</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2">
                            <div id="affectionBar" class="bg-gradient-to-r from-green-400 to-green-500 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-center">
                            <div class="text-blue-400 font-medium" id="currentMood">ä¸­æ€§</div>
                            <div>å¿ƒæƒ…</div>
                        </div>
                        <div class="text-center">
                            <div class="text-green-400 font-medium" id="relationshipStatus">é™Œç”Ÿäºº</div>
                            <div>é—œä¿‚</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NSFW æª¢æ¸¬ -->
            <div class="bg-white border rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3">
                    <i class="fas fa-shield-alt text-green-400 mr-2"></i>
                    å…§å®¹åˆ†æ
                </h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">ç•¶å‰ç´šåˆ¥</span>
                        <span id="currentNsfwLevel" class="bg-green-600 text-white px-2 py-1 rounded text-xs font-medium">Level 1</span>
                    </div>
                    
                    <div class="text-xs" id="nsfwDescription">
                        æ—¥å¸¸å°è©±å…§å®¹ï¼Œå®‰å…¨é©å®œ
                    </div>
                    
                    <div class="text-xs">
                        <i class="fas fa-info-circle mr-1"></i>
                        AI å¼•æ“: <span id="currentEngine">OpenAI</span>
                    </div>
                </div>
            </div>
            
            <!-- å°è©±æ­·å² -->
            <div class="bg-white border border-gray-200 shadow-lg rounded-xl p-4 flex-1 min-h-0">
                <h3 class="text-lg font-semibold mb-3">
                    <i class="fas fa-history text-yellow-400 mr-2"></i>
                    å°è©±è¨˜éŒ„
                </h3>
                
                <div class="space-y-2 overflow-y-auto overflow-y-auto max-h-40" id="chatHistory">
                    <div class="text-sm text-center py-4">
                        æš«ç„¡æ­·å²è¨˜éŒ„
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æœƒè©±åˆ—è¡¨æ¨¡æ…‹æ¡† -->
    <div id="sessionListModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white border rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <h3 class="text-2xl font-bold mb-4">
                <i class="fas fa-list text-blue-400 mr-2"></i>
                å°è©±æœƒè©±åˆ—è¡¨
            </h3>
            
            <div class="flex-1 overflow-y-auto">
                <div id="sessionsList" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end">
                <button 
                    type="button"
                    class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded font-semibold"
                    onclick="UI.modal.hide('sessionListModal')"
                >
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
    
    <!-- è¡¨æƒ…ç¬¦è™Ÿé¢æ¿ -->
    <div id="emojiPanel" class="hidden fixed bottom-20 right-4 bg-white border rounded-lg p-4 z-50">
        <div class="grid grid-cols-6 gap-2 text-2xl">
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ˜Š')">ğŸ˜Š</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ˜')">ğŸ˜</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ¥°')">ğŸ¥°</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ˜˜')">ğŸ˜˜</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ˜¢')">ğŸ˜¢</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ˜¡')">ğŸ˜¡</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ¤”')">ğŸ¤”</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ˜‰')">ğŸ˜‰</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('â¤ï¸')">â¤ï¸</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ’•')">ğŸ’•</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ”¥')">ğŸ”¥</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-10 p-2 rounded" onclick="insertEmojiText('ğŸ’”')">ğŸ’”</span>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="/public/assets/common.js"></script>
    <script>
        let currentSession = null;
        let currentCharacter = null;
        let isAIResponding = false;
        let messageHistory = [];
        let emotionState = {
            affection: 50,
            mood: 'neutral',
            relationship: 'stranger',
            intimacyLevel: 'friendly'
        };
        
        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await App.init();
            
            // æª¢æŸ¥èªè­‰ç‹€æ…‹
            if (!AppState.isAuthenticated) {
                Router.navigate('/auth');
                return;
            }
            
            // è¼‰å…¥é¸ä¸­çš„è§’è‰²
            currentCharacter = AppState.selectedCharacter || Utils.storage.get('selectedCharacter');
            if (!currentCharacter) {
                Router.navigate('/character');
                return;
            }
            
            // åˆå§‹åŒ–é é¢
            initializePage();
            
            // æ™ºèƒ½åˆå§‹åŒ–èŠå¤©æœƒè©±
            await initializeChat();
            
            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            setupEventListeners();
        });
        
        // åˆå§‹åŒ–é é¢
        function initializePage() {
            // è¨­ç½®è§’è‰²ä¿¡æ¯
            document.getElementById('characterAvatar').src = currentCharacter.avatar;
            document.getElementById('welcomeAvatar').src = currentCharacter.avatar;
            document.getElementById('characterName').textContent = currentCharacter.name;
            document.getElementById('characterStatus').textContent = 'åœ¨ç·š';
            
            // è¨­ç½®æ­¡è¿æ¶ˆæ¯
            setupWelcomeMessage();
            
            // è¨­ç½®å¿«é€Ÿå›å¾©
            setupQuickReplies();
        }
        
        // è¨­ç½®æ­¡è¿æ¶ˆæ¯
        function setupWelcomeMessage() {
            const welcomeMessages = {
                'char_001': 'ä½ å¥½ï¼Œæˆ‘æ˜¯é™¸å¯’æ·µã€‚å¾ˆé«˜èˆˆèªè­˜ä½ ...æœ‰ä»€éº¼éœ€è¦æˆ‘å¹«åŠ©çš„å—ï¼Ÿ',
                'char_002': 'ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯æ²ˆè¨€å¢¨ã€‚ä»Šå¤©éå¾—æ€éº¼æ¨£ï¼Ÿéœ€è¦èŠèŠå—ï¼Ÿ',
                'char_003': 'æ­¡è¿ä¾†åˆ°çŸ¥è­˜çš„ä¸–ç•Œï¼Œæˆ‘æ˜¯æ—å¤œç™½ã€‚æœ‰ä»€éº¼æƒ³äº†è§£çš„å—ï¼Ÿ'
            };
            
            const welcomeMessage = welcomeMessages[currentCharacter.id] || 'ä½ å¥½ï¼å¾ˆé«˜èˆˆèˆ‡ä½ å°è©±ã€‚';
            
            // æ›´æ–°é é¢ä¸Šçš„æ­¡è¿æ¶ˆæ¯
            document.getElementById('welcomeMessage').textContent = welcomeMessage;
        }
        
        // è¨­ç½®å¿«é€Ÿå›å¾©
        function setupQuickReplies() {
            const quickReplies = [
                { text: 'ä½ å¥½', value: 'ä½ å¥½' },
                { text: 'ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ', value: 'ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ' },
                { text: 'æƒ³èŠèŠ', value: 'æˆ‘æƒ³å’Œä½ èŠèŠ' },
                { text: 'å·¥ä½œè©±é¡Œ', value: 'èŠèŠå·¥ä½œçš„äº‹' }
            ];
            
            const container = document.getElementById('quickReplies');
            container.innerHTML = quickReplies.map(reply => 
                `<button class="bg-gray-600 bg-opacity-70 border border-gray-500 px-3 py-1 rounded-full text-sm transition-all hover:bg-opacity-90" onclick="sendQuickReply('${reply.value}')">${reply.text}</button>`
            ).join('');
        }
        
        // æ™ºèƒ½åˆå§‹åŒ–èŠå¤©
        async function initializeChat() {
            try {
                // æŸ¥è©¢è©²è§’è‰²çš„ç¾æœ‰æœƒè©±
                const sessionsResult = await ApiClient.get(`/api/v1/chat/sessions?character_id=${currentCharacter.id}`);
                
                if (sessionsResult.success && sessionsResult.data && sessionsResult.data.sessions && sessionsResult.data.sessions.length > 0) {
                    // ä½¿ç”¨æœ€æ–°çš„æœƒè©±ï¼ˆæŒ‰å‰µå»ºæ™‚é–“æ’åºï¼‰
                    const characterSessions = sessionsResult.data.sessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    currentSession = characterSessions[0];
                    AppState.currentSession = currentSession;
                    
                    console.log('è¼‰å…¥ç¾æœ‰æœƒè©±:', currentSession.id);
                    
                    // è¼‰å…¥æ­·å²è¨˜éŒ„
                    await loadChatHistory();
                    
                    // å•Ÿç”¨è¼¸å…¥
                    enableChatInput();
                    
                    // æ›´æ–°å ´æ™¯æè¿°
                    updateSceneDescription();
                    
                    UI.showToast(`å·²è¼‰å…¥èˆ‡ ${currentCharacter.name} çš„å°è©±è¨˜éŒ„`, 'success');
                    return;
                }
                
                // æ²’æœ‰ç¾æœ‰æœƒè©±ï¼Œå‰µå»ºæ–°æœƒè©±
                console.log('æ²’æœ‰æ‰¾åˆ°ç¾æœ‰æœƒè©±ï¼Œå‰µå»ºæ–°æœƒè©±');
                await createNewChatSession();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–èŠå¤©å¤±æ•—:', error);
                UI.showToast('åˆå§‹åŒ–èŠå¤©å¤±æ•—ï¼Œå‰µå»ºæœ¬åœ°æœƒè©±', 'warning');
                createLocalSession();
            }
        }
        
        // å‰µå»ºæ–°çš„èŠå¤©æœƒè©±
        async function createNewChatSession() {
            try {
                const result = await ApiClient.post('/api/v1/chat/session', {
                    character_id: currentCharacter.id,
                    title: `èˆ‡ ${currentCharacter.name} çš„å°è©±`,
                    mode: 'normal'
                });
                
                if (result.success) {
                    currentSession = result.data;
                    AppState.currentSession = currentSession;
                    
                    // é‡ç½®æ¶ˆæ¯æ­·å²
                    messageHistory = [];
                    
                    // è¨­ç½®æ­¡è¿æ¶ˆæ¯
                    setupWelcomeMessage();
                    
                    // è¼‰å…¥æ­·å²è¨˜éŒ„ï¼ˆå¯èƒ½ç‚ºç©ºï¼‰
                    await loadChatHistory();
                    
                    // å•Ÿç”¨è¼¸å…¥
                    enableChatInput();
                    
                    // æ›´æ–°å ´æ™¯æè¿°
                    updateSceneDescription();
                    
                    UI.showToast('æœƒè©±å‰µå»ºæˆåŠŸ', 'success');
                } else {
                    throw new Error(result.error?.message || 'å‰µå»ºæœƒè©±å¤±æ•—');
                }
            } catch (error) {
                console.error('å‰µå»ºæœƒè©±å¤±æ•—:', error);
                UI.showToast('å‰µå»ºæœƒè©±å¤±æ•—: ' + error.message, 'error');
                
                // å‰µå»ºæœ¬åœ°æœƒè©±
                createLocalSession();
            }
        }
        
        // è¼‰å…¥å°è©±æ­·å²
        async function loadChatHistory() {
            if (!currentSession || !currentSession.id) return;
            
            try {
                const result = await ApiClient.get(`/api/v1/chat/session/${currentSession.id}/history`);
                
                if (result.success && result.data && result.data.messages && result.data.messages.length > 0) {
                    // æ¸…ç©ºç¾æœ‰æ¶ˆæ¯ï¼Œå°‡é‡æ–°è¼‰å…¥æ­·å²è¨˜éŒ„
                    const messagesList = document.getElementById('messagesList');
                    messagesList.innerHTML = '';
                    
                    // æ·»åŠ æ­·å²æ¶ˆæ¯
                    result.data.messages.forEach(message => {
                        if (message.role === 'user') {
                            addMessageToChat('user', message.content, {
                                timestamp: message.created_at
                            });
                        } else if (message.role === 'assistant') {
                            addMessageToChat('ai', message.content, {
                                scene_description: message.scene_description,
                                character_action: message.character_action,
                                nsfw_level: message.nsfw_level || 1,
                                ai_engine: message.ai_engine,
                                timestamp: message.created_at
                            });
                        }
                    });
                    
                    // æ›´æ–°æ¶ˆæ¯æ­·å²
                    messageHistory = result.data.messages.map(msg => ({
                        sender: msg.role === 'user' ? 'user' : 'ai',
                        content: msg.content,
                        metadata: {
                            scene_description: msg.scene_description,
                            character_action: msg.character_action,
                            nsfw_level: msg.nsfw_level,
                            ai_engine: msg.ai_engine
                        },
                        timestamp: msg.created_at
                    }));
                    
                    // æ›´æ–°å´é‚Šæ¬„æ­·å²è¨˜éŒ„
                    updateChatHistorySidebar();
                    
                    UI.showToast(`è¼‰å…¥äº† ${result.data.length} æ¢æ­·å²æ¶ˆæ¯`, 'info');
                } else {
                    // æ²’æœ‰æ­·å²è¨˜éŒ„ï¼Œç¢ºä¿æ­¡è¿æ¶ˆæ¯é¡¯ç¤º
                    console.log('æ²’æœ‰æ­·å²è¨˜éŒ„ï¼Œä¿æŒæ­¡è¿æ¶ˆæ¯');
                }
            } catch (error) {
                console.error('è¼‰å…¥å°è©±æ­·å²å¤±æ•—:', error);
                UI.showToast('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—', 'warning');
            }
        }
        
        // å‰µå»ºæœ¬åœ°æœƒè©±
        function createLocalSession() {
            currentSession = {
                id: 'local_' + Date.now(),
                character_id: currentCharacter.id,
                title: `èˆ‡ ${currentCharacter.name} çš„å°è©±`,
                mode: 'normal',
                created_at: new Date().toISOString()
            };
            
            enableChatInput();
            updateSceneDescription();
            
            UI.showToast('å·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼', 'warning');
        }
        
        // å•Ÿç”¨èŠå¤©è¼¸å…¥
        function enableChatInput() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = 'è¼¸å…¥æ‚¨çš„è¨Šæ¯...';
            
            // èšç„¦åˆ°è¼¸å…¥æ¡†
            messageInput.focus();
        }
        
        // æ›´æ–°å ´æ™¯æè¿°
        function updateSceneDescription() {
            const scenes = {
                'char_001': 'è¾¦å…¬å®¤è£¡ç‡ˆå…‰å¾®æš–ï¼Œé™¸å¯’æ·µæ”¾ä¸‹æ‰‹ä¸­çš„æ–‡ä»¶ï¼Œæ·±é‚ƒçš„çœ¼çœ¸æœ›å‘ä½ ...',
                'char_002': 'é†«é™¢çš„èµ°å»Šè£¡äººä¾†äººå¾€ï¼Œæ²ˆè¨€å¢¨æº«å’Œåœ°æœä½ å¾®ç¬‘ï¼Œç™½å¤§è¤‚åœ¨ç‡ˆå…‰ä¸‹é¡¯å¾—æ ¼å¤–ä¹¾æ·¨...',
                'char_003': 'åˆå¾Œçš„é™½å…‰ç‘åœ¨åœ–æ›¸é¤¨è£¡ï¼Œæ—å¤œç™½éœéœåœ°ååœ¨ä½ å°é¢ï¼Œå°ˆæ³¨åœ°ç¿»é–±è‘—å¤ç±...'
            };
            
            const sceneText = scenes[currentCharacter.id] || 'ä½ å€‘åœ¨ä¸€å€‹å®‰éœèˆ’é©çš„ç’°å¢ƒä¸­é–‹å§‹å°è©±...';
            document.getElementById('sceneText').textContent = sceneText;
        }
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è¼¸å…¥æ¡†äº‹ä»¶
            const messageInput = document.getElementById('messageInput');
            
            // è‡ªå‹•èª¿æ•´é«˜åº¦
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // éµç›¤äº‹ä»¶
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // é»æ“Šå¤–éƒ¨é—œé–‰èœå–®
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('menuDropdown');
                const toggle = document.getElementById('menuToggle');
                
                if (!menu.contains(e.target) && !toggle.contains(e.target)) {
                    menu.classList.add('hidden');
                }
                
                const emojiPanel = document.getElementById('emojiPanel');
                if (!emojiPanel.contains(e.target) && !e.target.closest('[onclick="insertEmoji()"]')) {
                    emojiPanel.classList.add('hidden');
                }
            });
        }
        
        // ç™¼é€æ¶ˆæ¯
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isAIResponding) return;
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°èŠå¤©å€
            addMessageToChat('user', message);
            
            // è¨­ç½® AI æ­£åœ¨å›æ‡‰ç‹€æ…‹
            setAIResponding(true);
            
            try {
                // ç™¼é€åˆ° API
                const result = await ApiClient.post('/api/v1/chat/message', {
                    session_id: currentSession.id,
                    message: message
                });
                
                if (result.success && result.data) {
                    // è™•ç† AI å›æ‡‰
                    handleAIResponse(result.data);
                } else {
                    throw new Error(result.error?.message || 'AI å›æ‡‰å¤±æ•—');
                }
            } catch (error) {
                console.error('ç™¼é€æ¶ˆæ¯å¤±æ•—:', error);
                
                // ç”Ÿæˆæœ¬åœ°å›æ‡‰
                generateLocalResponse(message);
                
                UI.showToast('å·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼', 'warning');
            } finally {
                setAIResponding(false);
            }
        }
        
        // ç™¼é€å¿«é€Ÿå›å¾©
        function sendQuickReply(message) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = message;
            sendMessage();
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å€
        function addMessageToChat(sender, content, metadata = {}) {
            const messagesList = document.getElementById('messagesList');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'flex items-start space-x-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white rounded p-3 max-w-[80%]">
                        <p>${content}</p>
                        <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString()}</div>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold flex-shrink-0">
                        U
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-start space-x-3';
                
                const sceneHtml = metadata.scene_description ? 
                    `<div class="text-xs italic text-gray-400 mb-2">${metadata.scene_description}</div>` : '';
                
                const actionHtml = metadata.character_action ? 
                    `<div class="text-xs italic text-gray-600 mt-2">${metadata.character_action}</div>` : '';
                
                messageDiv.innerHTML = `
                    <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                    <div class="bg-white border border-gray-200 shadow-xl rounded-lg p-3 max-w-[80%]">
                        ${sceneHtml}
                        <p>${content}</p>
                        ${actionHtml}
                        <div class="text-xs opacity-75 mt-1 flex items-center justify-between">
                            <span>${metadata.timestamp ? new Date(metadata.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString()}</span>
                            <div class="flex items-center space-x-2">
                                ${metadata.nsfw_level ? `<span class="bg-gray-600 text-white px-1 py-0.5 rounded text-xs">L${metadata.nsfw_level}</span>` : ''}
                                <button class="hover:text-blue-500 transition-colors" onclick="regenerateMessage(this)" title="é‡æ–°ç”Ÿæˆ">
                                    <i class="fas fa-redo text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            messagesList.appendChild(messageDiv);
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„
            messageHistory.push({
                sender,
                content,
                metadata,
                timestamp: new Date().toISOString()
            });
        }
        
        // è™•ç† AI å›æ‡‰
        function handleAIResponse(responseData) {
            // æ·»åŠ  AI æ¶ˆæ¯ - ä½¿ç”¨å¯¦éš›çš„APIéŸ¿æ‡‰å­—æ®µ
            addMessageToChat('ai', responseData.content || responseData.character_dialogue, {
                scene_description: responseData.scene_description,
                character_action: responseData.character_action,
                nsfw_level: responseData.nsfw_level || 0,
                ai_engine: responseData.ai_engine
            });
            
            // æ›´æ–°æƒ…æ„Ÿç‹€æ…‹
            if (responseData.emotion_state) {
                updateEmotionState(responseData.emotion_state);
            }
            
            // æ›´æ–° NSFW æª¢æ¸¬ä¿¡æ¯
            updateNSFWDisplay(responseData.nsfw_level || 0, responseData.ai_engine);
            
            // æ›´æ–°å ´æ™¯æè¿°
            if (responseData.scene_description) {
                document.getElementById('sceneText').textContent = responseData.scene_description;
            }
            
            // ä¿å­˜åˆ°èŠå¤©æ­·å²
            if (currentSession && responseData.id) {
                currentSession.messages.push({
                    id: responseData.id,
                    role: responseData.role || 'assistant',
                    content: responseData.content,
                    timestamp: responseData.created_at || new Date().toISOString()
                });
            }
        }
        
        // ç”Ÿæˆæœ¬åœ°å›æ‡‰
        function generateLocalResponse(userMessage) {
            const responses = {
                'char_001': [
                    'å—¯ï¼Œæˆ‘æ˜ç™½ä½ çš„æ„æ€ã€‚ä½œç‚ºä¸€å€‹å•†æ¥­é ˜è¢–ï¼Œæˆ‘èªç‚º...',
                    'é€™ç¢ºå¯¦æ˜¯å€‹æœ‰è¶£çš„è§€é»ã€‚è®“æˆ‘å€‘ä¾†è¨è«–ä¸€ä¸‹...',
                    'ä½ çš„æƒ³æ³•å¾ˆæœ‰é“ç†ã€‚ä¸éï¼Œå¾æˆ‘çš„ç¶“é©—ä¾†çœ‹...'
                ],
                'char_002': [
                    'ä½ èªªå¾—å°å‘¢ã€‚ä½œç‚ºé†«ç”Ÿï¼Œæˆ‘ç¶“å¸¸é‡åˆ°é¡ä¼¼çš„æƒ…æ³...',
                    'é€™è½èµ·ä¾†å¾ˆé‡è¦ã€‚è®“æˆ‘å€‘ä¸€èµ·æƒ³æƒ³è§£æ±ºæ–¹æ¡ˆ...',
                    'æˆ‘å¾ˆç†è§£ä½ çš„æ„Ÿå—ã€‚è¦ä¸è¦è·Ÿæˆ‘è©³ç´°èªªèªªï¼Ÿ'
                ],
                'char_003': [
                    'å¾å­¸è¡“çš„è§’åº¦ä¾†çœ‹ï¼Œé€™å€‹å•é¡Œå¾ˆå€¼å¾—æ·±å…¥æ¢è¨...',
                    'æ ¹æ“šæˆ‘çš„ç ”ç©¶ï¼Œé€™ç¨®ç¾è±¡æœ‰è‘—æ·±å±¤çš„åŸå› ...',
                    'é€™è®“æˆ‘æƒ³åˆ°äº†ä¸€å€‹å¤è€çš„å“²å­¸å•é¡Œ...'
                ]
            };
            
            const characterResponses = responses[currentCharacter.id] || [
                'é€™æ˜¯ä¸€å€‹å¾ˆæœ‰è¶£çš„è©±é¡Œï¼Œè®“æˆ‘å€‘ç¹¼çºŒèŠèŠå§ã€‚',
                'æˆ‘å¾ˆå–œæ­¡å’Œä½ çš„å°è©±ï¼Œè«‹å‘Šè¨´æˆ‘æ›´å¤šå§ã€‚',
                'ä½ çš„æƒ³æ³•ç¸½æ˜¯è®“æˆ‘å°è±¡æ·±åˆ»ã€‚'
            ];
            
            const randomResponse = characterResponses[Math.floor(Math.random() * characterResponses.length)];
            
            // æ¨¡æ“¬å»¶é²
            setTimeout(() => {
                addMessageToChat('ai', randomResponse, {
                    scene_description: null,
                    character_action: 'ä»–æº«å’Œåœ°çœ‹è‘—ä½ ï¼Œç­‰å¾…ä½ çš„å›æ‡‰',
                    nsfw_level: 1
                });
                
                // è¼•å¾®å¢åŠ å¥½æ„Ÿåº¦
                emotionState.affection = Math.min(emotionState.affection + 1, 100);
                updateEmotionDisplay();
                updateNSFWDisplay(1, 'local');
            }, 1000 + Math.random() * 2000);
        }
        
        // è¨­ç½® AI å›æ‡‰ç‹€æ…‹
        function setAIResponding(responding) {
            isAIResponding = responding;
            const statusElement = document.getElementById('characterStatus');
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            
            if (responding) {
                statusElement.textContent = 'æ­£åœ¨è¼¸å…¥...';
                statusElement.className = 'text-sm text-yellow-400 animate-pulse';
                sendButton.disabled = true;
                messageInput.disabled = true;
            } else {
                statusElement.textContent = 'åœ¨ç·š';
                statusElement.className = 'text-sm text-green-400';
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }
        
        // æ›´æ–°æƒ…æ„Ÿç‹€æ…‹
        function updateEmotionState(newState) {
            emotionState = { ...emotionState, ...newState };
            updateEmotionDisplay();
        }
        
        // æ›´æ–°æƒ…æ„Ÿé¡¯ç¤º
        function updateEmotionDisplay() {
            document.getElementById('affectionLevel').textContent = emotionState.affection;
            document.getElementById('affectionDisplay').textContent = `${emotionState.affection}/100`;
            document.getElementById('affectionBar').style.width = `${emotionState.affection}%`;
            document.getElementById('currentMood').textContent = getMoodText(emotionState.mood);
            document.getElementById('relationshipStatus').textContent = getRelationshipText(emotionState.relationship);
        }
        
        // ç²å–å¿ƒæƒ…æ–‡å­—
        function getMoodText(mood) {
            const moodMap = {
                'happy': 'é–‹å¿ƒ',
                'sad': 'é›£é',
                'excited': 'èˆˆå¥®',
                'shy': 'å®³ç¾',
                'neutral': 'ä¸­æ€§',
                'concerned': 'é—œå¿ƒ',
                'pleased': 'æ„‰å¿«'
            };
            return moodMap[mood] || 'ä¸­æ€§';
        }
        
        // ç²å–é—œä¿‚æ–‡å­—
        function getRelationshipText(relationship) {
            const relationshipMap = {
                'stranger': 'é™Œç”Ÿäºº',
                'friend': 'æœ‹å‹',
                'close_friend': 'å¥½å‹',
                'ambiguous': 'æ›–æ˜§',
                'lover': 'æˆ€äºº'
            };
            return relationshipMap[relationship] || 'é™Œç”Ÿäºº';
        }
        
        // æ›´æ–° NSFW é¡¯ç¤º
        function updateNSFWDisplay(level, engine) {
            const levelElement = document.getElementById('currentNsfwLevel');
            const descriptionElement = document.getElementById('nsfwDescription');
            const engineElement = document.getElementById('currentEngine');
            
            const levelInfo = NSFWSystem.getLevelInfo(level);
            
            levelElement.textContent = `Level ${level}`;
            levelElement.className = `bg-gray-600 text-white px-2 py-1 rounded text-xs font-medium`;
            descriptionElement.textContent = levelInfo.description;
            engineElement.textContent = engine === 'grok' ? 'Grok' : 'OpenAI';
        }
        
        // åˆ‡æ›èŠå¤©æ¨¡å¼
        function changeChatMode() {
            const mode = document.getElementById('chatMode').value;
            // TODO: å¯¦ç¾æ¨¡å¼åˆ‡æ›
            UI.showToast(`åˆ‡æ›åˆ° ${mode} æ¨¡å¼`, 'info');
        }
        
        // åˆ‡æ›èœå–®
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('hidden');
        }
        
        // æ–°å»ºæœƒè©±
        async function newSession() {
            if (confirm('ç¢ºå®šè¦é–‹å§‹æ–°çš„å°è©±å—ï¼Ÿç•¶å‰å°è©±å°‡è¢«ä¿å­˜ã€‚')) {
                try {
                    // æ¸…ç©ºç•¶å‰æ¶ˆæ¯
                    document.getElementById('messagesList').innerHTML = `
                        <div class="flex items-start space-x-3">
                            <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                            <div class="bg-white border rounded p-3 max-w-[80%]">
                                <p>æ­£åœ¨å‰µå»ºæ–°çš„å°è©±æœƒè©±...</p>
                            </div>
                        </div>
                    `;
                    messageHistory = [];
                    
                    // å‰µå»ºæ–°æœƒè©±
                    await createNewChatSession();
                    UI.showToast('æ–°æœƒè©±å‰µå»ºæˆåŠŸ', 'success');
                } catch (error) {
                    console.error('å‰µå»ºæ–°æœƒè©±å¤±æ•—:', error);
                    UI.showToast('å‰µå»ºæ–°æœƒè©±å¤±æ•—ï¼Œé‡æ–°è¼‰å…¥é é¢', 'error');
                    location.reload();
                }
            }
        }
        
        // åŒ¯å‡ºå°è©±
        function exportChat() {
            if (messageHistory.length === 0) {
                UI.showToast('æ²’æœ‰å°è©±è¨˜éŒ„å¯åŒ¯å‡º', 'warning');
                return;
            }
            
            const chatData = {
                character: currentCharacter.name,
                session_id: currentSession.id,
                created_at: currentSession.created_at,
                messages: messageHistory
            };
            
            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${currentCharacter.name}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            UI.showToast('å°è©±å·²åŒ¯å‡º', 'success');
        }
        
        // æ¸…ç©ºå°è©±
        function clearChat() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
                document.getElementById('messagesList').innerHTML = `
                    <div class="flex items-start space-x-3">
                        <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                        <div class="bg-white border rounded p-3 max-w-[80%]">
                            <p>å°è©±å·²æ¸…ç©ºï¼Œæˆ‘å€‘é‡æ–°é–‹å§‹å§ï¼</p>
                        </div>
                    </div>
                `;
                messageHistory = [];
                UI.showToast('å°è©±å·²æ¸…ç©º', 'info');
            }
        }
        
        // æ’å…¥è¡¨æƒ…ç¬¦è™Ÿ
        function insertEmoji() {
            const panel = document.getElementById('emojiPanel');
            panel.classList.toggle('hidden');
        }
        
        // æ’å…¥è¡¨æƒ…ç¬¦è™Ÿæ–‡å­—
        function insertEmojiText(emoji) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value += emoji;
            messageInput.focus();
            document.getElementById('emojiPanel').classList.add('hidden');
        }
        
        // æ¸…ç©ºè¼¸å…¥
        function clearInput() {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.focus();
        }
        
        // æ›´æ–°å´é‚Šæ¬„æ­·å²è¨˜éŒ„
        function updateChatHistorySidebar() {
            const historyContainer = document.getElementById('chatHistory');
            
            if (messageHistory.length === 0) {
                historyContainer.innerHTML = '<div class="text-sm text-center py-4">æš«ç„¡æ­·å²è¨˜éŒ„</div>';
                return;
            }
            
            const recentMessages = messageHistory.slice(-10).reverse(); // æœ€è¿‘10æ¢æ¶ˆæ¯
            
            historyContainer.innerHTML = recentMessages.map((msg, index) => {
                const time = new Date(msg.timestamp).toLocaleTimeString('zh-TW', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const preview = msg.content.length > 20 ? msg.content.substring(0, 20) + '...' : msg.content;
                const isUser = msg.sender === 'user';
                
                return `
                    <div class="p-2 rounded hover:bg-white hover:bg-opacity-10 cursor-pointer text-sm border-l-2 ${isUser ? 'border-blue-400' : 'border-green-400'}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium ${isUser ? 'text-blue-400' : 'text-green-400'}">${isUser ? 'ä½ ' : currentCharacter.name}</span>
                            <span class="text-xs opacity-75">${time}</span>
                        </div>
                        <div class="text-xs opacity-75">${preview}</div>
                    </div>
                `;
            }).join('');
        }
        
        // é¡¯ç¤ºæœƒè©±åˆ—è¡¨
        async function showSessionList() {
            UI.modal.show('sessionListModal');
            
            try {
                const result = await ApiClient.get(`/api/v1/chat/sessions?character_id=${currentCharacter.id}`);
                const sessionsList = document.getElementById('sessionsList');
                
                if (result.success && result.data && result.data.sessions && result.data.sessions.length > 0) {
                    sessionsList.innerHTML = result.data.sessions.map(session => {
                        const createdTime = new Date(session.created_at).toLocaleString('zh-TW');
                        const isCurrentSession = currentSession && session.id === currentSession.id;
                        
                        return `
                            <div class="border rounded-lg p-4 ${isCurrentSession ? 'border-blue-400 bg-blue-50' : 'border-gray-200'} hover:border-blue-300 transition-colors">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 mr-4">
                                        <h4 class="font-semibold text-lg mb-1">${session.title || 'æœªå‘½åå°è©±'}</h4>
                                        <p class="text-sm text-gray-600 mb-2">è§’è‰²: ${session.character_name || 'æœªçŸ¥'}</p>
                                        <p class="text-xs text-gray-500">å‰µå»ºæ™‚é–“: ${createdTime}</p>
                                        <div class="flex items-center space-x-4 text-xs text-gray-500 mt-2">
                                            <span>æ¶ˆæ¯: ${session.message_count || 0}</span>
                                            <span>æ¨¡å¼: ${session.mode || 'normal'}</span>
                                            ${isCurrentSession ? '<span class="text-blue-600 font-medium">ç•¶å‰æœƒè©±</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${!isCurrentSession ? `<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm" onclick="loadSession('${session.id}')">è¼‰å…¥</button>` : ''}
                                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" onclick="deleteSession('${session.id}', this)">åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    sessionsList.innerHTML = '<div class="text-center py-8 text-gray-500">æ²’æœ‰æ‰¾åˆ°å°è©±æœƒè©±</div>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æœƒè©±åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('sessionsList').innerHTML = '<div class="text-center py-8 text-red-500">è¼‰å…¥å¤±æ•—</div>';
            }
        }
        
        // è¼‰å…¥æŒ‡å®šæœƒè©±
        async function loadSession(sessionId) {
            if (confirm('ç¢ºå®šè¦åˆ‡æ›åˆ°é€™å€‹æœƒè©±å—ï¼Ÿç•¶å‰æœƒè©±çš„æœªä¿å­˜å…§å®¹å¯èƒ½æœƒä¸Ÿå¤±ã€‚')) {
                try {
                    const result = await ApiClient.get(`/api/v1/chat/session/${sessionId}`);
                    
                    if (result.success && result.data) {
                        currentSession = result.data;
                        AppState.currentSession = currentSession;
                        
                        // æ¸…ç©ºç•¶å‰æ¶ˆæ¯
                        document.getElementById('messagesList').innerHTML = `
                            <div class="flex items-start space-x-3">
                                <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                                <div class="bg-white border rounded p-3 max-w-[80%]">
                                    <p>æœƒè©±å·²åˆ‡æ›ï¼Œè¼‰å…¥æ­·å²è¨˜éŒ„ä¸­...</p>
                                </div>
                            </div>
                        `;
                        
                        messageHistory = [];
                        
                        // è¼‰å…¥æœƒè©±æ­·å²
                        await loadChatHistory();
                        
                        UI.modal.hide('sessionListModal');
                        UI.showToast('æœƒè©±åˆ‡æ›æˆåŠŸ', 'success');
                    } else {
                        throw new Error('è¼‰å…¥æœƒè©±å¤±æ•—');
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æœƒè©±å¤±æ•—:', error);
                    UI.showToast('è¼‰å…¥æœƒè©±å¤±æ•—: ' + error.message, 'error');
                }
            }
        }
        
        // åˆªé™¤æŒ‡å®šæœƒè©±
        async function deleteSession(sessionId, buttonElement) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æœƒè©±å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
                try {
                    UI.showLoading(buttonElement);
                    
                    const result = await ApiClient.delete(`/api/v1/chat/session/${sessionId}`);
                    
                    if (result.success) {
                        // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰æœƒè©±ï¼Œå‰µå»ºæ–°æœƒè©±
                        if (currentSession && sessionId === currentSession.id) {
                            await createChatSession();
                        }
                        
                        // é‡æ–°è¼‰å…¥æœƒè©±åˆ—è¡¨
                        await showSessionList();
                        
                        UI.showToast('æœƒè©±å·²åˆªé™¤', 'success');
                    } else {
                        throw new Error(result.error?.message || 'åˆªé™¤å¤±æ•—');
                    }
                } catch (error) {
                    console.error('åˆªé™¤æœƒè©±å¤±æ•—:', error);
                    UI.showToast('åˆªé™¤æœƒè©±å¤±æ•—: ' + error.message, 'error');
                } finally {
                    UI.showLoading(buttonElement, false);
                }
            }
        }
        
        // åˆªé™¤ç•¶å‰æœƒè©±
        async function deleteCurrentSession() {
            if (currentSession && currentSession.id) {
                await deleteSession(currentSession.id, document.querySelector('[onclick="deleteCurrentSession()"]'));
            } else {
                UI.showToast('æ²’æœ‰ç•¶å‰æœƒè©±å¯åˆªé™¤', 'warning');
            }
        }
        
        // é‡æ–°ç”Ÿæˆæ¶ˆæ¯
        async function regenerateMessage(buttonElement) {
            if (isAIResponding) {
                UI.showToast('AIæ­£åœ¨å›æ‡‰ä¸­ï¼Œè«‹ç¨å€™', 'warning');
                return;
            }
            
            if (messageHistory.length === 0) {
                UI.showToast('æ²’æœ‰æ¶ˆæ¯å¯é‡æ–°ç”Ÿæˆ', 'warning');
                return;
            }
            
            // æ‰¾åˆ°æœ€å¾Œä¸€æ¢ç”¨æˆ¶æ¶ˆæ¯
            const lastUserMessage = [...messageHistory].reverse().find(msg => msg.sender === 'user');
            
            if (!lastUserMessage) {
                UI.showToast('æ‰¾ä¸åˆ°ç”¨æˆ¶æ¶ˆæ¯', 'warning');
                return;
            }
            
            try {
                UI.showLoading(buttonElement);
                setAIResponding(true);
                
                const result = await ApiClient.post('/api/v1/chat/regenerate', {
                    session_id: currentSession.id,
                    message: lastUserMessage.content
                });
                
                if (result.success && result.data) {
                    // ç§»é™¤æœ€å¾Œä¸€æ¢AIå›æ‡‰(å¦‚æœå­˜åœ¨)
                    const messagesList = document.getElementById('messagesList');
                    const lastMessage = messagesList.lastElementChild;
                    if (lastMessage && !lastMessage.querySelector('.bg-blue-600')) { // ä¸æ˜¯ç”¨æˆ¶æ¶ˆæ¯
                        lastMessage.remove();
                        messageHistory.pop(); // ç§»é™¤å°æ‡‰çš„æ­·å²è¨˜éŒ„
                    }
                    
                    // æ·»åŠ æ–°çš„AIå›æ‡‰
                    handleAIResponse(result.data);
                    
                    UI.showToast('æ¶ˆæ¯é‡æ–°ç”Ÿæˆå®Œæˆ', 'success');
                } else {
                    throw new Error(result.error?.message || 'é‡æ–°ç”Ÿæˆå¤±æ•—');
                }
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå¤±æ•—:', error);
                UI.showToast('é‡æ–°ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            } finally {
                UI.showLoading(buttonElement, false);
                setAIResponding(false);
            }
        }
        
        // è¼‰å…¥æƒ…æ„Ÿç‹€æ…‹
        async function loadEmotionStatus() {
            try {
                const statusResult = await ApiClient.get('/api/v1/emotion/status');
                const affectionResult = await ApiClient.get('/api/v1/emotion/affection');
                
                if (statusResult.success && statusResult.data) {
                    updateEmotionState(statusResult.data);
                }
                
                if (affectionResult.success && affectionResult.data) {
                    emotionState.affection = affectionResult.data.affection || 50;
                    updateEmotionDisplay();
                }
            } catch (error) {
                console.error('è¼‰å…¥æƒ…æ„Ÿç‹€æ…‹å¤±æ•—:', error);
                // ä½¿ç”¨é è¨­å€¼ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤
            }
        }
        
        // åˆå§‹åŒ–æƒ…æ„Ÿé¡¯ç¤º
        updateEmotionDisplay();
        updateNSFWDisplay(1, 'OpenAI');
        
        // è¼‰å…¥æƒ…æ„Ÿç‹€æ…‹
        loadEmotionStatus();
    </script>
</body>
</html>