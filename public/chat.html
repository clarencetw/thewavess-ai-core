<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 對話 - Thewavess AI Core</title>
    
    <!-- Tailwind CSS 3.4.17 -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-tw.min.js"></script>
    
    <!-- Flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    
    <!-- 簡約化自定義樣式 -->
    <style>
        /* 基礎設定 */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-none {
            display: block;
        }
        
        body {
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* 簡化的動作敘述 */
        .action-narrative {
            background: #f8f9fa;
            border-left: 3px solid #6366f1;
            padding: 8px 12px;
            margin-top: 8px;
            font-style: italic;
            font-size: 0.875rem;
            color: #4b5563;
            border-radius: 4px;
        }
        
        /* 簡化的場景描述 */
        .scene-description {
            background: #f1f5f9;
            border-left: 3px solid #0ea5e9;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: #475569;
            border-radius: 4px;
        }
        
        /* 消息內容 */
        .message-content {
            line-height: 1.6;
        }
        
        /* 簡化的按鈕樣式 */
        .btn-simple {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        
        .btn-simple:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .btn-primary {
            background: #6366f1;
            border: 1px solid #6366f1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5856eb;
        }
        
        /* 去除過度的陰影和圓角 */
        .card-minimal {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        /* 統一的間距 */
        .space-minimal > * + * {
            margin-top: 1rem;
        }
    </style>
    
</head>
<body class="h-full flex flex-col bg-white text-gray-900">
    <!-- 簡化的頂部導航 -->
    <nav class="border-b border-gray-200 p-3 md:p-4 flex-shrink-0">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center space-x-2 md:space-x-4">
                <button 
                    class="btn-simple text-sm md:text-base"
                    onclick="Router.navigate('/character')"
                >
                    ← 返回
                </button>
                
                <div class="flex items-center space-x-2 md:space-x-3">
                    <img 
                        id="characterAvatar"
                        class="w-8 h-8 md:w-10 md:h-10 rounded-full"
                        src=""
                        alt="角色頭像"
                    >
                    <div class="min-w-0 flex-1">
                        <h1 class="text-base md:text-lg font-medium truncate" id="characterName">--</h1>
                        <div class="text-xs md:text-sm text-gray-500" id="characterStatus">在線</div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-3">
                <!-- 簡化的狀態顯示 -->
                <div class="hidden md:flex items-center space-x-4 text-sm text-gray-600">
                    <span>好感度: <span id="affectionLevel" class="font-medium">50</span></span>
                    <span class="text-green-600">對話中</span>
                </div>
                
                <!-- 手機版簡化顯示 -->
                <div class="md:hidden text-xs text-gray-600">
                    <span id="affectionLevelMobile">50</span>♥
                </div>
                
                <!-- 功能按鈕 -->
                <button 
                    id="mobileSidebarToggle"
                    class="lg:hidden btn-simple text-xs md:text-sm"
                    onclick="toggleMobileSidebar()"
                >
                    資訊
                </button>
                
                <div class="relative">
                    <button 
                        id="menuToggle"
                        class="btn-simple text-sm md:text-base"
                        onclick="toggleMenu()"
                    >
                        ⋯
                    </button>
                    
                    <div id="menuDropdown" class="hidden absolute right-0 top-12 card-minimal p-2 min-w-[160px] z-10 shadow-lg">
                        <button class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm" onclick="exportChat()">
                            匯出對話
                        </button>
                        <button class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm" onclick="clearChat()">
                            清空對話
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- 簡化的聊天區域 -->
    <div class="flex-1 flex max-w-6xl mx-auto w-full space-x-6 min-h-0">
        <!-- 主聊天區 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 簡化的場景描述 -->
            <div id="sceneDescription" class="border-b border-gray-100 p-4 text-sm text-gray-600">
                <span id="sceneText" class="line-clamp-1 md:line-clamp-none">準備開始對話...</span>
                <button 
                    class="md:hidden ml-2 text-gray-400 hover:text-gray-600"
                    onclick="toggleSceneDescription()"
                >
                    <span id="sceneToggle">▼</span>
                </button>
            </div>
            
            <!-- 消息區域 -->
            <div class="flex-1 p-4 overflow-y-auto" id="messagesArea">
                <div class="space-y-4" id="messagesList">
                    <!-- 歡迎消息 -->
                    <div class="flex items-start space-x-3">
                        <img 
                            id="welcomeAvatar"
                            class="w-8 h-8 rounded-full flex-shrink-0"
                            src=""
                            alt="AI"
                        >
                        <div class="bg-gray-50 rounded-lg p-3 max-w-[80%]">
                            <p id="welcomeMessage" class="text-sm">歡迎來到 AI 對話！正在為您創建專屬會話...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 簡化的輸入區域 -->
            <div class="border-t border-gray-100 p-4">
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <textarea 
                            id="messageInput"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg resize-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="輸入您的訊息..."
                            rows="1"
                            disabled
                        ></textarea>
                    </div>
                    
                    <button 
                        id="sendButton"
                        class="btn-primary px-6 py-3 disabled:opacity-50 disabled:cursor-not-allowed"
                        onclick="sendMessage()"
                        disabled
                    >
                        發送
                    </button>
                </div>
                
                <!-- 簡化的快速回復 -->
                <div class="mt-3 flex flex-wrap gap-2" id="quickReplies">
                    <!-- 快速回復按鈕會動態生成 -->
                </div>
            </div>
        </div>
        
        <!-- 簡化的側邊欄 -->
        <div id="desktopSidebar" class="hidden lg:flex w-72 flex-col space-y-6">
            <!-- 簡化的情感狀態 -->
            <div class="card-minimal p-4">
                <h3 class="font-medium mb-4">情感狀態</h3>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span>好感度</span>
                            <span id="affectionDisplay">50/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="affectionBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 50%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-gray-500">心情</div>
                            <div class="font-medium" id="currentMood">中性</div>
                        </div>
                        <div>
                            <div class="text-gray-500">關係</div>
                            <div class="font-medium" id="relationshipStatus">陌生人</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 簡化的內容分析 -->
            <div class="card-minimal p-4">
                <h3 class="font-medium mb-4">內容分析</h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">等級</span>
                        <span id="currentNsfwLevel" class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Level 1</span>
                    </div>
                    
                    <div class="text-xs text-gray-600" id="nsfwDescription">
                        日常對話內容，安全適宜
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        AI 引擎: <span id="currentEngine">OpenAI</span>
                    </div>
                </div>
            </div>
            
            <!-- 簡化的對話記錄 -->
            <div class="card-minimal p-4 flex-1">
                <h3 class="font-medium mb-4">對話記錄</h3>
                
                <div class="space-y-2 overflow-y-auto max-h-40" id="chatHistory">
                    <div class="text-sm text-center py-4 text-gray-500">
                        暫無歷史記錄
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 手機版側邊欄遮罩 -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden [&.show]:opacity-100 [&.show]:pointer-events-auto" onclick="closeMobileSidebar()"></div>
    
    <!-- 簡化的手機版側邊欄 -->
    <div id="mobileSidebar" class="fixed top-0 right-0 h-screen w-80 bg-white z-50 transform translate-x-full transition-transform duration-300 ease-out overflow-y-auto lg:hidden [&.show]:translate-x-0 border-l border-gray-200">
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h3 class="font-medium">資訊面板</h3>
                <button 
                    class="btn-simple text-sm"
                    onclick="closeMobileSidebar()"
                >
                    關閉
                </button>
            </div>
        </div>
        
        <div class="p-4 space-y-6">
            <!-- 情感狀態 -->
            <div class="space-y-4">
                <h4 class="font-medium">情感狀態</h4>
                
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span>好感度</span>
                            <span id="mobileAffectionDisplay">50/100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="mobileAffectionBar" class="bg-blue-500 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-gray-500">心情</div>
                            <div class="font-medium" id="mobileCurrentMood">中性</div>
                        </div>
                        <div>
                            <div class="text-gray-500">關係</div>
                            <div class="font-medium" id="mobileRelationshipStatus">陌生人</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 內容分析 -->
            <div class="space-y-3">
                <h4 class="font-medium">內容分析</h4>
                
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">等級</span>
                        <span id="mobileCurrentNsfwLevel" class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Level 1</span>
                    </div>
                    
                    <div class="text-xs text-gray-600" id="mobileNsfwDescription">
                        日常對話內容，安全適宜
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        AI 引擎: <span id="mobileCurrentEngine">OpenAI</span>
                    </div>
                </div>
            </div>
            
            <!-- 對話記錄 -->
            <div class="space-y-3">
                <h4 class="font-medium">對話記錄</h4>
                
                <div class="space-y-2 max-h-40 overflow-y-auto" id="mobileChatHistory">
                    <div class="text-sm text-center py-4 text-gray-500">
                        暫無歷史記錄
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flowbite Toast 容器 -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    
    <!-- 會話列表模態框 -->
    <div id="sessionListModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white border rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
            <h3 class="text-2xl font-bold mb-4">
                <i class="fas fa-list text-blue-400 mr-2"></i>
                對話會話列表
            </h3>
            
            <div class="flex-1 overflow-y-auto">
                <div id="sessionsList" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        載入中...
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end">
                <button 
                    type="button"
                    class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded font-semibold"
                    onclick="UI.modal.hide('sessionListModal')"
                >
                    關閉
                </button>
            </div>
        </div>
    </div>
    
    
    <!-- JavaScript -->
    <script src="/public/assets/common.js"></script>
    <script>
        let currentSession = null;
        let currentCharacter = null;
        let isAIResponding = false;
        let messageHistory = [];
        let emotionState = {
            affection: 50,
            mood: 'neutral',
            relationship: 'stranger',
            intimacyLevel: 'friendly'
        };
        
        // 頁面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await App.init();
            
            // 檢查認證狀態
            if (!AppState.isAuthenticated) {
                Router.navigate('/auth');
                return;
            }
            
            // 載入選中的角色
            currentCharacter = AppState.selectedCharacter || Utils.storage.get('selectedCharacter');
            if (!currentCharacter) {
                Router.navigate('/character');
                return;
            }
            
            // 初始化頁面
            initializePage();
            
            // 智能初始化聊天會話
            await initializeChat();
            
            // 設置事件監聽器
            setupEventListeners();
        });
        
        // 初始化頁面
        function initializePage() {
            // 設置角色信息
            document.getElementById('characterAvatar').src = currentCharacter.avatar;
            document.getElementById('welcomeAvatar').src = currentCharacter.avatar;
            document.getElementById('characterName').textContent = currentCharacter.name;
            document.getElementById('characterStatus').textContent = '在線';
            
            // 設置歡迎消息
            setupWelcomeMessage();
            
            // 設置快速回復
            setupQuickReplies();
        }
        
        // 設置歡迎消息
        function setupWelcomeMessage() {
            const welcomeMessages = {
                'char_001': '你好，我是陸寒淵。很高興認識你...有什麼需要我幫助的嗎？',
                'char_002': '你好呀，我是沈言墨。今天過得怎麼樣？需要聊聊嗎？',
                'char_003': '歡迎來到知識的世界，我是林夜白。有什麼想了解的嗎？'
            };
            
            const welcomeMessage = welcomeMessages[currentCharacter.id] || '你好！很高興與你對話。';
            
            // 更新頁面上的歡迎消息
            document.getElementById('welcomeMessage').textContent = welcomeMessage;
        }
        
        // 設置快速回復
        function setupQuickReplies() {
            const quickReplies = [
                { text: '你好', value: '你好' },
                { text: '今天過得如何？', value: '今天過得如何？' },
                { text: '想聊聊', value: '我想和你聊聊' },
                { text: '工作話題', value: '聊聊工作的事' }
            ];
            
            const container = document.getElementById('quickReplies');
            container.innerHTML = quickReplies.map(reply => 
                `<button class="bg-gray-600 bg-opacity-70 border border-gray-500 px-2 py-1 md:px-3 md:py-1 rounded-full text-xs md:text-sm transition-all hover:bg-opacity-90" onclick="sendQuickReply('${reply.value}')">${reply.text}</button>`
            ).join('');
        }
        
        // 智能初始化聊天
        async function initializeChat() {
            try {
                // 查詢該角色的現有會話
                const sessionsResult = await ApiClient.get(`/api/v1/chat/sessions?character_id=${currentCharacter.id}`);
                
                if (sessionsResult.success && sessionsResult.data && sessionsResult.data.sessions && sessionsResult.data.sessions.length > 0) {
                    // 使用最新的會話（按創建時間排序）
                    const characterSessions = sessionsResult.data.sessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    currentSession = characterSessions[0];
                    AppState.currentSession = currentSession;
                    
                    console.log('載入現有會話:', currentSession.id);
                    
                    // 載入歷史記錄
                    await loadChatHistory();
                    
                    // 啟用輸入
                    enableChatInput();
                    
                    // 更新場景描述
                    updateSceneDescription();
                    
                    const characterName = currentCharacter?.name || '角色';
                    UI.showToast(`已載入與 ${characterName} 的對話記錄`, 'success');
                    return;
                }
                
                // 沒有現有會話，創建新會話
                console.log('沒有找到現有會話，創建新會話');
                await createNewChatSession();
                
            } catch (error) {
                console.error('初始化聊天失敗:', error);
                UI.showToast('初始化聊天失敗，創建本地會話', 'warning');
                createLocalSession();
            }
        }
        
        // 創建新的聊天會話
        async function createNewChatSession() {
            try {
                const result = await ApiClient.post('/api/v1/chat/session', {
                    character_id: currentCharacter.id,
                    title: `與 ${currentCharacter.name} 的對話`
                });
                
                if (result.success) {
                    currentSession = result.data;
                    AppState.currentSession = currentSession;
                    
                    // 更新對話狀態
                    updateChatStatus();
                    
                    // 重置消息歷史
                    messageHistory = [];
                    
                    // 設置歡迎消息
                    setupWelcomeMessage();
                    
                    // 載入歷史記錄（可能為空）
                    await loadChatHistory();
                    
                    // 啟用輸入
                    enableChatInput();
                    
                    // 更新場景描述
                    updateSceneDescription();
                    
                    UI.showToast('會話創建成功', 'success');
                } else {
                    throw new Error(result.error?.message || '創建會話失敗');
                }
            } catch (error) {
                console.error('創建會話失敗:', error);
                UI.showToast('創建會話失敗: ' + error.message, 'error');
                
                // 創建本地會話
                createLocalSession();
            }
        }
        
        // 載入對話歷史
        async function loadChatHistory() {
            if (!currentSession || !currentSession.id) {
                console.warn('無法載入歷史記錄：會話資訊不完整');
                return;
            }
            
            try {
                console.log('載入歷史記錄，會話ID:', currentSession.id);
                const result = await ApiClient.get(`/api/v1/chat/session/${currentSession.id}/history`);
                
                if (result.success && result.data && result.data.messages && result.data.messages.length > 0) {
                    // 清空現有消息，將重新載入歷史記錄
                    const messagesList = document.getElementById('messagesList');
                    messagesList.innerHTML = '';
                    
                    // 添加歷史消息
                    result.data.messages.forEach(message => {
                        if (message.role === 'user') {
                            addMessageToChat('user', message.content, {
                                timestamp: message.created_at
                            });
                        } else if (message.role === 'assistant') {
                            addMessageToChat('ai', message.content, {
                                scene_description: message.scene_description,
                                character_action: message.character_action,
                                nsfw_level: message.nsfw_level || 1,
                                ai_engine: message.ai_engine,
                                timestamp: message.created_at
                            });
                        }
                    });
                    
                    // 更新消息歷史
                    messageHistory = result.data.messages.map(msg => ({
                        sender: msg.role === 'user' ? 'user' : 'ai',
                        content: msg.content,
                        metadata: {
                            scene_description: msg.scene_description,
                            character_action: msg.character_action,
                            nsfw_level: msg.nsfw_level,
                            ai_engine: msg.ai_engine
                        },
                        timestamp: msg.created_at
                    }));
                    
                    // 更新側邊欄歷史記錄
                    updateChatHistorySidebar();
                    
                    const messageCount = result.data.messages ? result.data.messages.length : 0;
                    UI.showToast(`載入了 ${messageCount} 條歷史消息`, 'info');
                } else {
                    // 沒有歷史記錄，確保歡迎消息顯示
                    console.log('沒有歷史記錄，保持歡迎消息');
                }
            } catch (error) {
                console.error('載入對話歷史失敗:', error);
                UI.showToast('載入歷史記錄失敗', 'warning');
            }
        }
        
        // 創建本地會話
        function createLocalSession() {
            currentSession = {
                id: 'local_' + Date.now(),
                character_id: currentCharacter.id,
                title: `與 ${currentCharacter.name} 的對話`,
                created_at: moment().toISOString()
            };
            
            enableChatInput();
            updateSceneDescription();
            updateChatStatus();
            
            UI.showToast('已切換到離線模式', 'warning');
        }
        
        // 啟用聊天輸入
        function enableChatInput() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = '輸入您的訊息...';
            
            // 聚焦到輸入框
            messageInput.focus();
        }
        
        // 更新場景描述 - 從數據庫獲取場景
        async function updateSceneDescription() {
            if (!currentCharacter.id) {
                document.getElementById('sceneText').textContent = '準備開始對話...';
                return;
            }
            
            try {
                // 使用角色信息中的場景描述，如果沒有則使用默認描述
                const defaultScenes = {
                    'char_001': '陸寒淵坐在他的專屬辦公室裡，陽光透過落地窗灑在他英俊的側臉上',
                    'char_002': '沈言墨穿著整潔的白大褂，在溫馨的診療室裡溫和地看著你',
                    'char_003': '你們在一個安靜舒適的環境中準備開始對話'
                };
                
                const sceneText = defaultScenes[currentCharacter.id] || '你們在一個安靜舒適的環境中準備開始對話...';
                document.getElementById('sceneText').textContent = sceneText;
            } catch (error) {
                console.log('更新場景描述時發生錯誤:', error);
                document.getElementById('sceneText').textContent = '你們在一個安靜舒適的環境中準備開始對話...';
            }
        }
        
        // 設置事件監聽器
        function setupEventListeners() {
            // 輸入框事件
            const messageInput = document.getElementById('messageInput');
            
            // 自動調整高度
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // 鍵盤事件
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 點擊外部關閉菜單
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('menuDropdown');
                const toggle = document.getElementById('menuToggle');
                
                if (!menu.contains(e.target) && !toggle.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });
        }
        
        // 發送消息
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isAIResponding) return;
            
            // 清空輸入框
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // 添加用戶消息到聊天區
            addMessageToChat('user', message);
            
            // 設置 AI 正在回應狀態
            setAIResponding(true);
            
            try {
                // 發送到 API
                const result = await ApiClient.post('/api/v1/chat/message', {
                    session_id: currentSession.id,
                    message: message
                });
                
                if (result.success && result.data) {
                    // 處理 AI 回應
                    handleAIResponse(result.data);
                } else {
                    throw new Error(result.error?.message || 'AI 回應失敗');
                }
            } catch (error) {
                console.error('發送消息失敗:', error);
                
                // 生成本地回應
                generateLocalResponse(message);
                
                UI.showToast('已切換到離線模式', 'warning');
            } finally {
                setAIResponding(false);
            }
        }
        
        // 發送快速回復
        function sendQuickReply(message) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = message;
            sendMessage();
        }
        
        // 解析訊息內容（移除 ||| 處理，使用 character_action）
        function parseMessageContent(content) {
            if (!content || typeof content !== 'string') {
                return { dialogue: content || '', action: '' };
            }
            
            // 直接返回完整內容作為對話，不再分割
            return {
                dialogue: content.trim(),
                action: '' // 動作由 character_action 字段提供
            };
        }
        
        // 添加消息到聊天區
        function addMessageToChat(sender, content, metadata = {}) {
            const messagesList = document.getElementById('messagesList');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'flex items-start space-x-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white rounded p-2 md:p-3 max-w-[85%] md:max-w-[80%]">
                        <p class="text-sm md:text-base">${content}</p>
                        <div class="text-xs opacity-75 mt-1">${Utils.formatShortTime(new Date())}</div>
                    </div>
                    <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold flex-shrink-0">
                        <span class="text-xs md:text-sm">U</span>
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-start space-x-3';
                
                // 解析訊息內容
                const { dialogue, action } = parseMessageContent(content);
                
                const sceneHtml = metadata.scene_description ? 
                    `<div class="scene-description">
                        <i class="scene-icon fas fa-image"></i>${metadata.scene_description}
                    </div>` : '';
                
                // 建立動作敘述的 HTML（只使用 API 的 character_action）
                const actionText = metadata.character_action || '';
                const actionHtml = actionText ? 
                    `<div class="action-narrative">
                        <i class="action-icon fas fa-theater-masks"></i>
                        <span class="font-medium">${actionText}</span>
                    </div>` : '';
                
                messageDiv.innerHTML = `
                    <img class="w-6 h-6 md:w-8 md:h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                    <div class="bg-white border border-gray-200 shadow-xl rounded-lg p-2 md:p-3 max-w-[85%] md:max-w-[80%]">
                        ${sceneHtml}
                        ${dialogue ? `<p class="message-content text-sm md:text-base">${dialogue}</p>` : ''}
                        ${actionHtml}
                        <div class="text-xs opacity-75 mt-1 flex items-center justify-between">
                            <span>${metadata.timestamp ? Utils.formatShortTime(metadata.timestamp) : Utils.formatShortTime(new Date())}</span>
                            <div class="flex items-center space-x-2">
                                ${metadata.nsfw_level ? `<span class="bg-gray-600 text-white px-1 py-0.5 rounded text-xs">L${metadata.nsfw_level}</span>` : ''}
                                <button class="hover:text-blue-500 transition-colors" onclick="regenerateMessage(this)" title="重新生成">
                                    <i class="fas fa-redo text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            messagesList.appendChild(messageDiv);
            
            // 優化動作敘述顯示（對於AI消息）
            if (sender === 'ai') {
                const actionElement = messageDiv.querySelector('.action-narrative');
                if (actionElement) {
                    optimizeActionDisplay(actionElement);
                }
            }
            
            // 滾動到底部
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // 保存到歷史記錄
            messageHistory.push({
                sender,
                content,
                metadata,
                timestamp: moment().toISOString()
            });
            
            // 更新側邊欄歷史記錄
            updateChatHistorySidebar();
        }
        
        // 處理 AI 回應
        function handleAIResponse(responseData) {
            // 添加 AI 消息 - 使用實際的API響應字段
            addMessageToChat('ai', responseData.content || responseData.character_dialogue, {
                scene_description: responseData.scene_description,
                character_action: responseData.character_action,
                nsfw_level: responseData.nsfw_level || 0,
                ai_engine: responseData.ai_engine
            });
            
            // 更新情感狀態
            if (responseData.emotion_state) {
                updateEmotionState(responseData.emotion_state);
            }
            
            // 更新 NSFW 檢測信息
            updateNSFWDisplay(responseData.nsfw_level || 0, responseData.ai_engine);
            
            // 更新場景描述
            if (responseData.scene_description) {
                document.getElementById('sceneText').textContent = responseData.scene_description;
            }
            
            // 保存到聊天歷史
            if (currentSession && responseData.id) {
                currentSession.messages.push({
                    id: responseData.id,
                    role: responseData.role || 'assistant',
                    content: responseData.content,
                    timestamp: responseData.created_at || moment().toISOString()
                });
            }
        }
        
        // 生成本地回應
        function generateLocalResponse(userMessage) {
            const responses = {
                'char_001': [
                    '嗯，我明白你的意思。作為一個商業領袖，我認為...',
                    '這確實是個有趣的觀點。讓我們來討論一下...',
                    '你的想法很有道理。不過，從我的經驗來看...'
                ],
                'char_002': [
                    '你說得對呢。作為醫生，我經常遇到類似的情況...',
                    '這聽起來很重要。讓我們一起想想解決方案...',
                    '我很理解你的感受。要不要跟我詳細說說？'
                ],
                'char_003': [
                    '從學術的角度來看，這個問題很值得深入探討...',
                    '根據我的研究，這種現象有著深層的原因...',
                    '這讓我想到了一個古老的哲學問題...'
                ]
            };
            
            const characterResponses = responses[currentCharacter.id] || [
                '這是一個很有趣的話題，讓我們繼續聊聊吧。',
                '我很喜歡和你的對話，請告訴我更多吧。',
                '你的想法總是讓我印象深刻。'
            ];
            
            const randomResponse = characterResponses[Math.floor(Math.random() * characterResponses.length)];
            
            // 模擬延遲
            setTimeout(() => {
                addMessageToChat('ai', randomResponse, {
                    scene_description: null,
                    character_action: '他溫和地看著你，等待你的回應',
                    nsfw_level: 1
                });
                
                // 輕微增加好感度
                emotionState.affection = Math.min(emotionState.affection + 1, 100);
                updateEmotionDisplay();
                updateNSFWDisplay(1, 'local');
            }, 1000 + Math.random() * 2000);
        }
        
        // 設置 AI 回應狀態
        function setAIResponding(responding) {
            isAIResponding = responding;
            const statusElement = document.getElementById('characterStatus');
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            
            if (responding) {
                statusElement.textContent = '正在輸入...';
                statusElement.className = 'text-sm text-yellow-400 animate-pulse';
                sendButton.disabled = true;
                messageInput.disabled = true;
            } else {
                statusElement.textContent = '在線';
                statusElement.className = 'text-sm text-green-400';
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }
        
        // 更新情感狀態
        function updateEmotionState(newState) {
            emotionState = { ...emotionState, ...newState };
            updateEmotionDisplay();
        }
        
        // 更新情感顯示
        function updateEmotionDisplay() {
            document.getElementById('affectionLevel').textContent = emotionState.affection;
            document.getElementById('affectionDisplay').textContent = `${emotionState.affection}/100`;
            document.getElementById('affectionBar').style.width = `${emotionState.affection}%`;
            document.getElementById('currentMood').textContent = getMoodText(emotionState.mood);
            document.getElementById('relationshipStatus').textContent = getRelationshipText(emotionState.relationship);
        }
        
        // 獲取心情文字
        function getMoodText(mood) {
            const moodMap = {
                'happy': '開心',
                'sad': '難過',
                'excited': '興奮',
                'shy': '害羞',
                'neutral': '中性',
                'concerned': '關心',
                'pleased': '愉快'
            };
            return moodMap[mood] || '中性';
        }
        
        // 獲取關係文字
        function getRelationshipText(relationship) {
            const relationshipMap = {
                'stranger': '陌生人',
                'friend': '朋友',
                'close_friend': '好友',
                'ambiguous': '曖昧',
                'lover': '戀人'
            };
            return relationshipMap[relationship] || '陌生人';
        }
        
        // 更新 NSFW 顯示
        function updateNSFWDisplay(level, engine) {
            const levelElement = document.getElementById('currentNsfwLevel');
            const descriptionElement = document.getElementById('nsfwDescription');
            const engineElement = document.getElementById('currentEngine');
            
            const levelInfo = NSFWSystem.getLevelInfo(level);
            
            levelElement.textContent = `Level ${level}`;
            levelElement.className = `bg-gray-600 text-white px-2 py-1 rounded text-xs font-medium`;
            descriptionElement.textContent = levelInfo.description;
            engineElement.textContent = engine === 'grok' ? 'Grok' : 'OpenAI';
        }
        
        // 更新對話狀態
        function updateChatStatus() {
            // 根據當前會話狀態更新顯示
            if (currentSession && currentSession.id) {
                // 顯示對話中狀態
                document.querySelector('.text-blue-600').textContent = '對話中';
            } else {
                // 顯示準備中狀態
                document.querySelector('.text-blue-600').textContent = '準備中';
            }
        }
        
        // 刷新對話狀態
        function refreshChatStatus() {
            updateChatStatus();
            UI.showToast('對話狀態已更新', 'info');
        }
        
        // 切換菜單
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('hidden');
        }
        
        // 新建會話
        async function newSession() {
            if (confirm('確定要開始新的對話嗎？當前對話將被保存。')) {
                try {
                    // 清空當前消息
                    document.getElementById('messagesList').innerHTML = `
                        <div class="flex items-start space-x-3">
                            <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                            <div class="bg-white border rounded p-3 max-w-[80%]">
                                <p>正在創建新的對話會話...</p>
                            </div>
                        </div>
                    `;
                    messageHistory = [];
                    
                    // 創建新會話
                    await createNewChatSession();
                    UI.showToast('新會話創建成功', 'success');
                } catch (error) {
                    console.error('創建新會話失敗:', error);
                    UI.showToast('創建新會話失敗，重新載入頁面', 'error');
                    location.reload();
                }
            }
        }
        
        // 匯出對話
        function exportChat() {
            if (messageHistory.length === 0) {
                UI.showToast('沒有對話記錄可匯出', 'warning');
                return;
            }
            
            const chatData = {
                character: currentCharacter.name,
                session_id: currentSession.id,
                created_at: currentSession.created_at,
                messages: messageHistory
            };
            
            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${currentCharacter.name}_${Utils.formatDate(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            UI.showToast('對話已匯出', 'success');
        }
        
        // 清空對話
        function clearChat() {
            if (confirm('確定要清空所有對話記錄嗎？此操作無法撤銷。')) {
                document.getElementById('messagesList').innerHTML = `
                    <div class="flex items-start space-x-3">
                        <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                        <div class="bg-white border rounded p-3 max-w-[80%]">
                            <p>對話已清空，我們重新開始吧！</p>
                        </div>
                    </div>
                `;
                messageHistory = [];
                UI.showToast('對話已清空', 'info');
            }
        }
        
        
        // 清空輸入
        function clearInput() {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.focus();
        }
        
        // 更新側邊欄歷史記錄
        function updateChatHistorySidebar() {
            const historyContainer = document.getElementById('chatHistory');
            
            if (messageHistory.length === 0) {
                historyContainer.innerHTML = '<div class="text-sm text-center py-4">暫無歷史記錄</div>';
                return;
            }
            
            const recentMessages = messageHistory.slice(-10).reverse(); // 最近10條消息
            
            historyContainer.innerHTML = recentMessages.map((msg, index) => {
                const time = Utils.formatShortTime(msg.timestamp);
                const preview = msg.content.length > 20 ? msg.content.substring(0, 20) + '...' : msg.content;
                const isUser = msg.sender === 'user';
                
                return `
                    <div class="p-2 rounded hover:bg-white hover:bg-opacity-10 cursor-pointer text-sm border-l-2 ${isUser ? 'border-blue-400' : 'border-green-400'}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium ${isUser ? 'text-blue-400' : 'text-green-400'}">${isUser ? '你' : currentCharacter.name}</span>
                            <span class="text-xs opacity-75">${time}</span>
                        </div>
                        <div class="text-xs opacity-75">${preview}</div>
                    </div>
                `;
            }).join('');
        }
        
        // 顯示會話列表
        async function showSessionList() {
            UI.modal.show('sessionListModal');
            
            try {
                const result = await ApiClient.get(`/api/v1/chat/sessions?character_id=${currentCharacter.id}`);
                const sessionsList = document.getElementById('sessionsList');
                
                if (result.success && result.data && result.data.sessions && result.data.sessions.length > 0) {
                    sessionsList.innerHTML = result.data.sessions.map(session => {
                        const createdTime = Utils.formatFriendlyDateTime(session.created_at);
                        const isCurrentSession = currentSession && session.id === currentSession.id;
                        
                        return `
                            <div class="border rounded-lg p-4 ${isCurrentSession ? 'border-blue-400 bg-blue-50' : 'border-gray-200'} hover:border-blue-300 transition-colors">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 mr-4">
                                        <h4 class="font-semibold text-lg mb-1">${session.title || '未命名對話'}</h4>
                                        <p class="text-sm text-gray-600 mb-2">角色: ${session.character_name || '未知'}</p>
                                        <p class="text-xs text-gray-500">創建時間: ${createdTime}</p>
                                        <div class="flex items-center space-x-4 text-xs text-gray-500 mt-2">
                                            <span>消息: ${session.message_count || 0}</span>
                                            <span>狀態: ${session.status || 'active'}</span>
                                            ${isCurrentSession ? '<span class="text-blue-600 font-medium">當前會話</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${!isCurrentSession ? `<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm" onclick="loadSession('${session.id}')">載入</button>` : ''}
                                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" onclick="deleteSession('${session.id}', this)">刪除</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    sessionsList.innerHTML = '<div class="text-center py-8 text-gray-500">沒有找到對話會話</div>';
                }
            } catch (error) {
                console.error('載入會話列表失敗:', error);
                document.getElementById('sessionsList').innerHTML = '<div class="text-center py-8 text-red-500">載入失敗</div>';
            }
        }
        
        // 載入指定會話
        async function loadSession(sessionId) {
            if (confirm('確定要切換到這個會話嗎？當前會話的未保存內容可能會丟失。')) {
                try {
                    const result = await ApiClient.get(`/api/v1/chat/session/${sessionId}`);
                    
                    if (result.success && result.data) {
                        currentSession = result.data;
                        AppState.currentSession = currentSession;
                        
                        // 更新對話狀態
                        updateChatStatus();
                        
                        // 清空當前消息
                        document.getElementById('messagesList').innerHTML = `
                            <div class="flex items-start space-x-3">
                                <img class="w-8 h-8 rounded-full flex-shrink-0" src="${currentCharacter.avatar}" alt="AI">
                                <div class="bg-white border rounded p-3 max-w-[80%]">
                                    <p>會話已切換，載入歷史記錄中...</p>
                                </div>
                            </div>
                        `;
                        
                        messageHistory = [];
                        
                        // 載入會話歷史
                        await loadChatHistory();
                        
                        UI.modal.hide('sessionListModal');
                        UI.showToast('會話切換成功', 'success');
                    } else {
                        throw new Error('載入會話失敗');
                    }
                } catch (error) {
                    console.error('載入會話失敗:', error);
                    UI.showToast('載入會話失敗: ' + error.message, 'error');
                }
            }
        }
        
        // 刪除指定會話
        async function deleteSession(sessionId, buttonElement) {
            if (confirm('確定要刪除這個會話嗎？此操作無法撤銷。')) {
                try {
                    UI.showLoading(buttonElement);
                    
                    const result = await ApiClient.delete(`/api/v1/chat/session/${sessionId}`);
                    
                    if (result.success) {
                        // 如果刪除的是當前會話，創建新會話
                        if (currentSession && sessionId === currentSession.id) {
                            await createChatSession();
                        }
                        
                        // 重新載入會話列表
                        await showSessionList();
                        
                        UI.showToast('會話已刪除', 'success');
                    } else {
                        throw new Error(result.error?.message || '刪除失敗');
                    }
                } catch (error) {
                    console.error('刪除會話失敗:', error);
                    UI.showToast('刪除會話失敗: ' + error.message, 'error');
                } finally {
                    UI.showLoading(buttonElement, false);
                }
            }
        }
        
        // 刪除當前會話
        async function deleteCurrentSession() {
            if (currentSession && currentSession.id) {
                await deleteSession(currentSession.id, document.querySelector('[onclick="deleteCurrentSession()"]'));
            } else {
                UI.showToast('沒有當前會話可刪除', 'warning');
            }
        }
        
        // 重新生成消息
        async function regenerateMessage(buttonElement) {
            if (isAIResponding) {
                UI.showToast('AI正在回應中，請稍候', 'warning');
                return;
            }
            
            if (messageHistory.length === 0) {
                UI.showToast('沒有消息可重新生成', 'warning');
                return;
            }
            
            // 找到最後一條用戶消息
            const lastUserMessage = [...messageHistory].reverse().find(msg => msg.sender === 'user');
            
            if (!lastUserMessage) {
                UI.showToast('找不到用戶消息', 'warning');
                return;
            }
            
            try {
                UI.showLoading(buttonElement);
                setAIResponding(true);
                
                const result = await ApiClient.post('/api/v1/chat/regenerate', {
                    session_id: currentSession.id,
                    message: lastUserMessage.content
                });
                
                if (result.success && result.data) {
                    // 移除最後一條AI回應(如果存在)
                    const messagesList = document.getElementById('messagesList');
                    const lastMessage = messagesList.lastElementChild;
                    if (lastMessage && !lastMessage.querySelector('.bg-blue-600')) { // 不是用戶消息
                        lastMessage.remove();
                        messageHistory.pop(); // 移除對應的歷史記錄
                    }
                    
                    // 添加新的AI回應
                    handleAIResponse(result.data);
                    
                    UI.showToast('消息重新生成完成', 'success');
                } else {
                    throw new Error(result.error?.message || '重新生成失敗');
                }
            } catch (error) {
                console.error('重新生成失敗:', error);
                UI.showToast('重新生成失敗: ' + error.message, 'error');
            } finally {
                UI.showLoading(buttonElement, false);
                setAIResponding(false);
            }
        }
        
        // 載入情感狀態（映射 API 欄位到 UI 狀態）
        async function loadEmotionStatus() {
            try {
                const statusResult = await ApiClient.get('/api/v1/emotion/status');
                const affectionResult = await ApiClient.get('/api/v1/emotion/affection');

                // 映射心情（mood）
                if (statusResult.success && statusResult.data) {
                    const moodType = statusResult.data.current_emotion?.type || 'neutral';
                    updateEmotionState({ mood: moodType });
                }

                // 映射好感度與關係（relationship）
                if (affectionResult.success && affectionResult.data?.affection_level) {
                    const level = affectionResult.data.affection_level;
                    const current = typeof level.current === 'number' ? level.current : 50;
                    const tier = level.level_tier;
                    const relationship = mapRelationshipByTier(tier);
                    updateEmotionState({ affection: current, relationship });
                } else if (affectionResult.success && affectionResult.data?.affection) {
                    // 後備鍵（保險處理）
                    updateEmotionState({ affection: affectionResult.data.affection });
                }
            } catch (error) {
                console.error('載入情感狀態失敗:', error);
                // 使用預設值，不顯示錯誤
            }
        }

        // 將等級層（1..5）映射為內部關係碼
        function mapRelationshipByTier(tier) {
            switch (tier) {
                case 1: return 'stranger';
                case 2: return 'acquaintance';
                case 3: return 'friend';
                case 4: return 'close_friend';
                case 5: return 'lover';
                default: return emotionState.relationship || 'stranger';
            }
        }
        
        // 手機版專屬功能初始化
        function initMobileFeatures() {
            // 同步手機版好感度顯示
            updateMobileAffectionDisplay();
            
            // 場景描述切換功能
            setupSceneToggle();
            
            // 手機版狀態欄顯示
            setupMobileStatusBar();
        }
        
        // 同步手機版好感度顯示
        function updateMobileAffectionDisplay() {
            const mobileElement = document.getElementById('affectionLevelMobile');
            const desktopElement = document.getElementById('affectionLevel');
            if (mobileElement && desktopElement) {
                mobileElement.textContent = desktopElement.textContent;
            }
        }
        
        // 場景描述切換功能
        function setupSceneToggle() {
            window.toggleSceneDescription = function() {
                const sceneText = document.getElementById('sceneText');
                const toggleIcon = document.getElementById('sceneToggle');
                
                if (sceneText.classList.contains('line-clamp-1')) {
                    sceneText.classList.remove('line-clamp-1');
                    sceneText.classList.add('line-clamp-none');
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                } else {
                    sceneText.classList.add('line-clamp-1');
                    sceneText.classList.remove('line-clamp-none');
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                }
            };
        }
        
        // 手機版狀態欄顯示
        function setupMobileStatusBar() {
            // 可以添加更多手機版專屬的狀態顯示邏輯
            console.log('Mobile status bar initialized');
        }
        
        // 覆寫原有的更新情感顯示功能，支援手機版
        function updateEmotionDisplay() {
            document.getElementById('affectionLevel').textContent = emotionState.affection;
            document.getElementById('affectionDisplay').textContent = `${emotionState.affection}/100`;
            document.getElementById('affectionBar').style.width = `${emotionState.affection}%`;
            document.getElementById('currentMood').textContent = getMoodText(emotionState.mood);
            document.getElementById('relationshipStatus').textContent = getRelationshipText(emotionState.relationship);
            
            // 更新手機版好感度顯示
            updateMobileAffectionDisplay();
            
            // 同步手機版側邊欄顯示
            syncMobileSidebar();
        }
        
        // 同步手機版側邊欄數據
        function syncMobileSidebar() {
            // 同步好感度
            const mobileAffectionDisplay = document.getElementById('mobileAffectionDisplay');
            const mobileAffectionBar = document.getElementById('mobileAffectionBar');
            if (mobileAffectionDisplay && mobileAffectionBar) {
                mobileAffectionDisplay.textContent = `${emotionState.affection}/100`;
                mobileAffectionBar.style.width = `${emotionState.affection}%`;
            }
            
            // 同步心情和關係
            const mobileMood = document.getElementById('mobileCurrentMood');
            const mobileRelationship = document.getElementById('mobileRelationshipStatus');
            if (mobileMood) mobileMood.textContent = getMoodText(emotionState.mood);
            if (mobileRelationship) mobileRelationship.textContent = getRelationshipText(emotionState.relationship);
        }
        
        // 初始化情感顯示
        updateEmotionDisplay();
        updateNSFWDisplay(1, 'OpenAI');
        
        // 載入情感狀態
        loadEmotionStatus();
        
        // 手機版專屬功能
        initMobileFeatures();
        
        // 初始化側邊欄功能
        initSidebarFunctions();
        
        // 側邊欄功能初始化
        function initSidebarFunctions() {
            // 確保桌面版側邊欄可見
            const desktopSidebar = document.getElementById('desktopSidebar');
            if (desktopSidebar) {
                // 立即檢查螢幕寬度並顯示桌面版側邊欄
                if (window.innerWidth >= 1024) {
                    desktopSidebar.classList.remove('hidden');
                    desktopSidebar.classList.add('flex');
                    console.log('桌面版側邊欄已顯示');
                } else {
                    desktopSidebar.classList.add('hidden');
                    desktopSidebar.classList.remove('flex');
                }
                
                // 監聽窗口大小變化
                window.addEventListener('resize', function() {
                    if (window.innerWidth >= 1024) {
                        desktopSidebar.classList.remove('hidden');
                        desktopSidebar.classList.add('flex');
                        // 關閉手機版側邊欄（如果開啟的話）
                        closeMobileSidebar();
                    } else {
                        desktopSidebar.classList.add('hidden');
                        desktopSidebar.classList.remove('flex');
                    }
                });
            }
        }
        
        // 切換手機版側邊欄
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('show');
                
                if (isOpen) {
                    closeMobileSidebar();
                } else {
                    openMobileSidebar();
                }
            }
        }
        
        // 打開手機版側邊欄
        function openMobileSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.add('show');
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden'; // 防止背景滾動
                
                // 同步數據到手機版側邊欄
                syncMobileSidebar();
                syncMobileNSFWDisplay();
                syncMobileChatHistory();
            }
        }
        
        // 關閉手機版側邊欄
        function closeMobileSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                document.body.style.overflow = ''; // 恢復背景滾動
            }
        }
        
        // 同步手機版 NSFW 顯示
        function syncMobileNSFWDisplay() {
            const mobileLevel = document.getElementById('mobileCurrentNsfwLevel');
            const mobileDescription = document.getElementById('mobileNsfwDescription');
            const mobileEngine = document.getElementById('mobileCurrentEngine');
            
            const desktopLevel = document.getElementById('currentNsfwLevel');
            const desktopDescription = document.getElementById('nsfwDescription');
            const desktopEngine = document.getElementById('currentEngine');
            
            if (mobileLevel && desktopLevel) mobileLevel.textContent = desktopLevel.textContent;
            if (mobileDescription && desktopDescription) mobileDescription.textContent = desktopDescription.textContent;
            if (mobileEngine && desktopEngine) mobileEngine.textContent = desktopEngine.textContent;
        }
        
        // 同步手機版聊天歷史
        function syncMobileChatHistory() {
            const mobileHistory = document.getElementById('mobileChatHistory');
            const desktopHistory = document.getElementById('chatHistory');
            
            if (mobileHistory && desktopHistory) {
                mobileHistory.innerHTML = desktopHistory.innerHTML;
            }
        }
        
        // 更新 NSFW 顯示函數，同步到手機版
        const originalUpdateNSFWDisplay = updateNSFWDisplay;
        updateNSFWDisplay = function(level, engine) {
            // 調用原始函數
            originalUpdateNSFWDisplay(level, engine);
            
            // 同步到手機版
            syncMobileNSFWDisplay();
        };
        
        // 更新側邊欄歷史記錄函數，同步到手機版
        const originalUpdateChatHistorySidebar = updateChatHistorySidebar;
        updateChatHistorySidebar = function() {
            // 調用原始函數
            originalUpdateChatHistorySidebar();
            
            // 同步到手機版
            syncMobileChatHistory();
        };
        
        // 將函數暴露到全局範圍
        window.toggleMobileSidebar = toggleMobileSidebar;
        window.openMobileSidebar = openMobileSidebar;
        window.closeMobileSidebar = closeMobileSidebar;
        
        
        // 檢測並處理長動作敘述的顯示優化
        function optimizeActionDisplay(actionElement) {
            if (!actionElement) return;
            
            const maxLength = window.innerWidth < 768 ? 80 : 120; // 手機版和桌面版不同的長度限制
            const actionText = actionElement.querySelector('.font-medium');
            
            if (actionText && actionText.textContent.length > maxLength) {
                const fullText = actionText.textContent;
                const truncatedText = fullText.substring(0, maxLength) + '...';
                
                actionText.textContent = truncatedText;
                actionText.title = fullText; // 鼠標懸停顯示全文
                
                // 添加展開/收縮功能
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'ml-2 text-purple-600 hover:text-purple-800 underline text-xs';
                toggleBtn.textContent = '展開';
                
                let isExpanded = false;
                toggleBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (isExpanded) {
                        actionText.textContent = truncatedText;
                        toggleBtn.textContent = '展開';
                    } else {
                        actionText.textContent = fullText;
                        toggleBtn.textContent = '收縮';
                    }
                    isExpanded = !isExpanded;
                };
                
                actionElement.appendChild(toggleBtn);
            }
        }
        
        // 增強歷史記錄顯示，支持動作敘述預覽
        const originalUpdateChatHistorySidebar2 = updateChatHistorySidebar;
        updateChatHistorySidebar = function() {
            const historyContainer = document.getElementById('chatHistory');
            
            if (messageHistory.length === 0) {
                historyContainer.innerHTML = '<div class="text-sm text-center py-4">暫無歷史記錄</div>';
                return;
            }
            
            const recentMessages = messageHistory.slice(-10).reverse(); // 最近10條消息
            
            historyContainer.innerHTML = recentMessages.map((msg, index) => {
                const time = Utils.formatShortTime(msg.timestamp);
                const { dialogue, action } = parseMessageContent(msg.content);
                
                // 為歷史記錄創建預覽文本
                let preview = dialogue || msg.content;
                if (preview.length > 15) preview = preview.substring(0, 15) + '...';
                
                const hasAction = (msg.metadata && msg.metadata.character_action);
                const actionIndicator = hasAction ? '<i class="fas fa-theater-masks text-purple-400 text-xs ml-1" title="包含動作敘述"></i>' : '';
                
                const isUser = msg.sender === 'user';
                
                return `
                    <div class="p-2 rounded hover:bg-white hover:bg-opacity-10 cursor-pointer text-sm border-l-2 ${isUser ? 'border-blue-400' : 'border-green-400'}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium ${isUser ? 'text-blue-400' : 'text-green-400'} flex items-center">
                                ${isUser ? '你' : currentCharacter.name}${actionIndicator}
                            </span>
                            <span class="text-xs opacity-75">${time}</span>
                        </div>
                        <div class="text-xs opacity-75">${preview}</div>
                    </div>
                `;
            }).join('');
            
            // 同步到手機版
            syncMobileChatHistory();
        };
        
        // Toast 系統統一使用 common.js 中的 UI.showToast 函數
    </script>
</body>
</html>
