<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人資料 - Thewavess AI Core</title>
    
    <!-- Tailwind CSS 3.4.17 -->
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-tw.min.js"></script>
    
    <!-- Flowbite -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/public/assets/styles.css">
    
</head>
<body class="min-h-full p-4 bg-gray-50 text-gray-900">
    <!-- 頂部導航 -->
    <nav class="bg-white border rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button 
                    class="bg-gray-600 hover:bg-gray-700 text-white p-2 rounded"
                    onclick="goBack()"
                >
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <h1 class="text-2xl font-bold">
                    <i class="fas fa-user text-blue-400 mr-2"></i>
                    個人資料
                </h1>
            </div>
            
            <div class="flex items-center space-x-2">
                <button 
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"
                    onclick="saveProfile()"
                >
                    <i class="fas fa-save mr-2"></i>
                    儲存變更
                </button>
                <button 
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded"
                    onclick="logout()"
                >
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    登出
                </button>
            </div>
        </div>
    </nav>
    
    <!-- 主內容區域 -->
    <div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 左側 - 用戶信息 -->
        <div class="lg:col-span-2 space-y-6">
            <!-- 基本信息 -->
            <div class="bg-white border rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-id-card text-blue-400 mr-2"></i>
                    基本信息
                </h2>
                
                <!-- 頭像設置 -->
                <div class="mb-6 flex items-center space-x-6">
                    <div class="relative">
                        <img 
                            id="userAvatar"
                            class="w-20 h-20 rounded-full border-4 border-blue-400 object-cover"
                            src=""
                            alt="用戶頭像"
                        >
                        <button 
                            class="absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 shadow-lg"
                            onclick="changeAvatar()"
                            title="更換頭像"
                        >
                            <i class="fas fa-camera text-sm"></i>
                        </button>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold" id="displayNameHeader">--</h3>
                        <p class="text-gray-600 text-sm">點擊相機圖標更換頭像</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-medium mb-2">用戶 ID</label>
                        <input 
                            type="text" 
                            id="userId"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900"
                            readonly
                        >
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">用戶名</label>
                        <input 
                            type="text" 
                            id="username"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900"
                            readonly
                        >
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">顯示名稱</label>
                        <input 
                            type="text" 
                            id="displayName"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900 focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">信箱</label>
                        <input 
                            type="email" 
                            id="email"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900 focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">帳號狀態</label>
                        <input 
                            type="text" 
                            id="status"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900"
                            readonly
                        >
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2">註冊時間</label>
                        <input 
                            type="text" 
                            id="createdAt"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900"
                            readonly
                        >
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block font-medium mb-2">個人簡介</label>
                    <textarea 
                        id="bio"
                        rows="3"
                        class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900 focus:ring-2 focus:ring-blue-500"
                        placeholder="介紹一下自己..."
                    ></textarea>
                </div>
            </div>
            
            <!-- 偏好設定 -->
            <div class="bg-white border rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-cogs text-blue-600 mr-2"></i>
                    偏好設定
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block font-medium mb-2">預設角色</label>
                        <select 
                            id="defaultCharacter"
                            class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900 focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">請選擇預設角色</option>
                            <option value="character_01">沈宸 - 霸道企業家</option>
                            <option value="character_02">林知遠 - 溫柔心理師</option>
                            <option value="character_03">周曜 - 陽光歌手</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 安全設定 -->
            <div class="bg-white border rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-shield-alt text-green-400 mr-2"></i>
                    安全設定
                </h2>
                
                <div class="space-y-4">
                    <button 
                        class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-3 px-4 rounded text-left"
                        onclick="changePassword()"
                    >
                        <i class="fas fa-key mr-2"></i>
                        變更密碼
                    </button>
                    
                    <button 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded text-left"
                        onclick="refreshTokens()"
                    >
                        <i class="fas fa-sync mr-2"></i>
                        刷新登入狀態
                    </button>
                    
                    <button 
                        class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded text-left"
                        onclick="clearAllData()"
                    >
                        <i class="fas fa-trash mr-2"></i>
                        清除所有本地數據
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 右側 - 統計和狀態 -->
        <div class="space-y-6">
            
            <!-- 帳號狀態 -->
            <div class="bg-white border rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-user-check text-green-400 mr-2"></i>
                    帳號狀態
                </h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span>信箱驗證</span>
                        <span id="emailVerificationStatus" class="text-yellow-400">
                            <i class="fas fa-clock"></i>
                            待驗證
                        </span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span>成人內容權限</span>
                        <span id="adultContentStatus" class="text-red-400">
                            <i class="fas fa-times-circle"></i>
                            未啟用
                        </span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span>最後登入</span>
                        <span id="lastLoginAt" class="text-gray-600">
                            --
                        </span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span>更新時間</span>
                        <span id="updatedAt" class="text-gray-600">
                            --
                        </span>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- 頭像更換模態框 -->
    <div id="avatarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white border rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4">
                <i class="fas fa-camera text-blue-400 mr-2"></i>
                更換頭像
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">頭像URL</label>
                    <input 
                        type="url" 
                        id="avatarUrl"
                        class="w-full px-4 py-3 rounded bg-gray-100 border text-gray-900 focus:ring-2 focus:ring-blue-500"
                        placeholder="https://example.com/avatar.jpg"
                    >
                    <p class="text-sm text-gray-600 mt-1">請輸入有效的圖片網址</p>
                </div>
                
                <div class="text-center">
                    <img 
                        id="avatarPreview"
                        class="w-20 h-20 rounded-full border-2 border-gray-300 mx-auto object-cover"
                        src="https://placehold.co/80x80/6366f1/ffffff?text=預覽"
                        alt="頭像預覽"
                    >
                </div>
                
                <div class="flex space-x-4">
                    <button 
                        type="button"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded font-semibold"
                        onclick="updateAvatar()"
                    >
                        <i class="fas fa-save mr-2"></i>
                        確認更新
                    </button>
                    
                    <button 
                        type="button"
                        class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded font-semibold"
                        onclick="UI.modal.hide('avatarModal')"
                    >
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- JavaScript -->
    <script src="/public/assets/common.js"></script>
    <script>
        let userProfile = null;
        let hasChanges = false;
        
        // 頁面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await App.init();
            
            // 檢查認證狀態
            if (!AppState.isAuthenticated) {
                Router.navigate('/auth');
                return;
            }
            
            // 載入用戶資料
            await loadUserProfile();
            
            // 設置事件監聽器
            setupEventListeners();
            
            // 註：統計功能和最喜愛角色功能已移除，因為缺少相應的API支持
        });
        
        // 載入用戶資料
        async function loadUserProfile() {
            try {
                const result = await SpecializedApiClients.User.getProfile();
                
                if (result.success && result.data) {
                    userProfile = result.data;
                    populateProfile(userProfile);
                } else {
                    throw new Error(result.error?.message || '載入用戶資料失敗');
                }
            } catch (error) {
                UI.handleError(error, '載入用戶資料');
                
                // 使用本地數據
                userProfile = AppState.currentUser || Utils.storage.get('user') || {
                    id: 'demo_user_id',
                    username: 'demo_user',
                    display_name: '演示用戶',
                    email: 'demo@example.com',
                    bio: '',
                    status: 'active',
                    is_verified: false,
                    is_adult: false,
                    created_at: moment().toISOString(),
                    updated_at: moment().toISOString(),
                    last_login_at: moment().toISOString()
                };
                
                populateProfile(userProfile);
                UI.showToast('使用本地用戶資料', 'warning');
            }
        }
        
        // 填充用戶資料
        function populateProfile(profile) {
            document.getElementById('userId').value = profile.id || '';
            document.getElementById('username').value = profile.username || '';
            document.getElementById('displayName').value = profile.display_name || '';
            document.getElementById('email').value = profile.email || '';
            document.getElementById('bio').value = profile.bio || '';
            document.getElementById('status').value = profile.status || '';
            
            // 設置頭像
            const avatarUrl = profile.avatar || 'https://placehold.co/80x80/6366f1/ffffff?text=' + encodeURIComponent(profile.display_name || profile.username || 'U');
            document.getElementById('userAvatar').src = avatarUrl;
            
            // 設置顯示名稱 (頭像旁邊的名字)
            const displayNameHeader = document.getElementById('displayNameHeader');
            if (displayNameHeader) {
                displayNameHeader.textContent = profile.display_name || profile.username || '--';
            }
            
            // 格式化時間
            if (profile.created_at) {
                const createDate = new Date(profile.created_at);
                document.getElementById('createdAt').value = createDate.toLocaleDateString('zh-TW') + ' ' + createDate.toLocaleTimeString('zh-TW');
            }
            
            if (profile.last_login_at) {
                const lastLoginDate = new Date(profile.last_login_at);
                document.getElementById('lastLoginAt').textContent = lastLoginDate.toLocaleDateString('zh-TW') + ' ' + lastLoginDate.toLocaleTimeString('zh-TW');
            }
            
            if (profile.updated_at) {
                const updatedDate = new Date(profile.updated_at);
                document.getElementById('updatedAt').textContent = updatedDate.toLocaleDateString('zh-TW') + ' ' + updatedDate.toLocaleTimeString('zh-TW');
            }
            
            // 設置驗證狀態
            updateVerificationStatus(profile);
            
            // 載入偏好設定
            loadPreferences();
        }
        
        // 載入偏好設定
        async function loadPreferences() {
            const preferences = AppState.preferences;
            
            // 載入角色列表並設置當前選中角色
            await loadCharacterOptions();
        }
        
        // 載入角色選項
        async function loadCharacterOptions() {
            try {
                const result = await SpecializedApiClients.Character.getAll();
                const select = document.getElementById('defaultCharacter');
                
                if (result.success && result.data.characters) {
                    // 清空選項(保留空選項)
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // 添加角色選項
                    result.data.characters.forEach(character => {
                        const option = document.createElement('option');
                        option.value = character.id;
                        option.textContent = `${character.name} - ${character.metadata?.description || ''}`;
                        select.appendChild(option);
                    });
                    
                    // 設置預設選中角色
                    if (AppState.preferences?.default_character) {
                        select.value = AppState.preferences.default_character;
                    }
                } else {
                    console.warn('載入角色列表失敗，使用本地數據');
                    // 使用本地預設角色
                    const defaultCharacters = [
                        { id: 'character_01', name: '沈宸', description: '霸道企業家' },
                        { id: 'character_02', name: '林知遠', description: '溫柔心理師' },
                        { id: 'character_03', name: '周曜', description: '陽光歌手' }
                    ];
                    
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    defaultCharacters.forEach(character => {
                        const option = document.createElement('option');
                        option.value = character.id;
                        option.textContent = `${character.name} - ${character.description}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                UI.handleError(error, '載入角色選項');
            }
        }
        
        // 設置事件監聽器
        function setupEventListeners() {
            // 監聽表單變更
            const inputs = ['displayName', 'email', 'bio', 'defaultCharacter'];
            
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        hasChanges = true;
                        updateSaveButtonState();
                    });
                    
                    if (element.tagName === 'TEXTAREA') {
                        element.addEventListener('input', () => {
                            hasChanges = true;
                            updateSaveButtonState();
                        });
                    }
                }
            });
            
            // 頭像URL預覽
            const avatarUrlInput = document.getElementById('avatarUrl');
            if (avatarUrlInput) {
                avatarUrlInput.addEventListener('input', function() {
                    const preview = document.getElementById('avatarPreview');
                    if (this.value && this.value.startsWith('http')) {
                        preview.src = this.value;
                        preview.onerror = function() {
                            this.src = 'https://placehold.co/80x80/6366f1/ffffff?text=錯誤';
                        };
                    }
                });
            }
            
            // 頁面卸載前檢查未保存的變更
            window.addEventListener('beforeunload', (e) => {
                if (hasChanges) {
                    e.preventDefault();
                    e.returnValue = '您有未保存的變更，確定要離開嗎？';
                }
            });
        }
        
        // 更新保存按鈕狀態
        function updateSaveButtonState() {
            const saveButton = document.querySelector('[onclick="saveProfile()"]');
            if (hasChanges) {
                saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>儲存變更 *';
            } else {
                saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-700');
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>儲存變更';
            }
        }
        
        // 儲存用戶資料
        async function saveProfile() {
            if (!hasChanges) {
                UI.showToast('沒有變更需要保存', 'info');
                return;
            }
            
            const updatedProfile = {
                display_name: document.getElementById('displayName').value,
                email: document.getElementById('email').value,
                bio: document.getElementById('bio').value
            };
            
            const updatedPreferences = {
                default_character: document.getElementById('defaultCharacter').value
            };
            
            try {
                // 保存用戶資料
                const profileResult = await SpecializedApiClients.User.updateProfile(updatedProfile);
                
                // 保存偏好設定（包含角色選擇）
                const preferencesResult = await SpecializedApiClients.User.updatePreferences(updatedPreferences);
                
                if (profileResult.success && preferencesResult.success) {
                    // 更新本地狀態
                    userProfile = { ...userProfile, ...updatedProfile };
                    AppState.currentUser = userProfile;
                    AppState.preferences = { ...AppState.preferences, ...updatedPreferences };
                    
                    // 更新選中的角色
                    if (updatedPreferences.default_character) {
                        const characterSelect = document.getElementById('defaultCharacter');
                        const selectedOption = characterSelect.options[characterSelect.selectedIndex];
                        if (selectedOption) {
                            AppState.selectedCharacter = {
                                id: updatedPreferences.default_character,
                                name: selectedOption.textContent.split(' - ')[0]
                            };
                            Utils.storage.set('selectedCharacter', AppState.selectedCharacter);
                        }
                    }
                    
                    // 保存到本地存儲
                    Utils.storage.set('user', userProfile);
                    Utils.storage.set('preferences', AppState.preferences);
                    
                    hasChanges = false;
                    updateSaveButtonState();
                    
                    UI.showToast('資料已成功保存', 'success');
                } else {
                    throw new Error('部分設定保存失敗');
                }
            } catch (error) {
                UI.handleError(error, '保存資料');
                
                // 至少保存本地數據
                AppState.currentUser = { ...userProfile, ...updatedProfile };
                AppState.preferences = { ...AppState.preferences, ...updatedPreferences };
                Utils.storage.set('user', AppState.currentUser);
                Utils.storage.set('preferences', AppState.preferences);
                
                hasChanges = false;
                updateSaveButtonState();
                
                UI.showToast('已保存到本地', 'warning');
            }
        }
        
        
        
        // 變更密碼
        function changePassword() {
            UI.modal.show('passwordModal');
        }
        
        // 處理密碼變更
        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                UI.showToast('新密碼確認不匹配', 'error');
                return;
            }
            
            if (!Utils.validation.password(newPassword)) {
                UI.showToast('新密碼不符合要求', 'error');
                return;
            }
            
            try {
                // TODO: 實現密碼變更 API
                UI.showToast('密碼變更功能暫未實現', 'warning');
                UI.modal.hide('passwordModal');
                
                // 清空表單
                document.getElementById('passwordForm').reset();
            } catch (error) {
                UI.showToast('密碼變更失敗: ' + error.message, 'error');
            }
        }
        
        // 刷新登入狀態
        async function refreshTokens() {
            try {
                if (AppState.refreshToken) {
                    const result = await SpecializedApiClients.Auth.refresh(AppState.refreshToken);
                    
                    if (result.success) {
                        AppState.accessToken = result.data.access_token;
                        AppState.refreshToken = result.data.refresh_token;
                        
                        Utils.storage.set('tokens', {
                            access: AppState.accessToken,
                            refresh: AppState.refreshToken
                        });
                        
                        UI.showToast('登入狀態已刷新', 'success');
                    } else {
                        throw new Error(result.error?.message || '刷新失敗');
                    }
                } else {
                    throw new Error('沒有有效的 refresh token');
                }
            } catch (error) {
                UI.showToast('刷新失敗: ' + error.message, 'error');
            }
        }
        
        // 清除所有本地數據
        function clearAllData() {
            if (confirm('確定要清除所有本地數據嗎？此操作無法撤銷，您需要重新登入。')) {
                try {
                    // 清除所有本地存儲
                    localStorage.clear();
                    
                    // 重置應用狀態
                    AppState.isAuthenticated = false;
                    AppState.currentUser = null;
                    AppState.accessToken = null;
                    AppState.refreshToken = null;
                    AppState.selectedCharacter = null;
                    AppState.currentSession = null;
                    
                    UI.showToast('本地數據已清除', 'info');
                    
                    // 跳轉到首頁
                    setTimeout(() => {
                        Router.navigate('/');
                    }, 1000);
                } catch (error) {
                    UI.showToast('清除失敗: ' + error.message, 'error');
                }
            }
        }
        
        // 登出
        function logout() {
            if (hasChanges) {
                if (!confirm('您有未保存的變更，確定要登出嗎？')) {
                    return;
                }
            }
            
            if (confirm('確定要登出嗎？')) {
                ApiClient.logout();
                UI.showToast('已登出', 'info');
                Router.navigate('/');
            }
        }
        
        // 更新驗證狀態
        function updateVerificationStatus(profile) {
            // 信箱驗證狀態
            const emailStatus = document.getElementById('emailVerificationStatus');
            if (profile.is_verified) {
                emailStatus.innerHTML = '<i class="fas fa-check-circle"></i> 已驗證';
                emailStatus.className = 'text-green-400';
            } else {
                emailStatus.innerHTML = '<i class="fas fa-times-circle"></i> 未驗證';
                emailStatus.className = 'text-red-400';
            }
            
            // 成人內容權限狀態
            const adultStatus = document.getElementById('adultContentStatus');
            if (profile.is_adult) {
                adultStatus.innerHTML = '<i class="fas fa-check-circle"></i> 已啟用';
                adultStatus.className = 'text-green-400';
            } else {
                adultStatus.innerHTML = '<i class="fas fa-times-circle"></i> 未啟用';
                adultStatus.className = 'text-red-400';
            }
        }
        
        
        // 更換頭像
        function changeAvatar() {
            UI.modal.show('avatarModal');
        }
        
        // 更新頭像
        async function updateAvatar() {
            const avatarUrl = document.getElementById('avatarUrl').value;
            
            if (!avatarUrl || !avatarUrl.startsWith('http')) {
                UI.showToast('請輸入有效的圖片網址', 'error');
                return;
            }
            
            try {
                UI.showLoading(document.querySelector('#avatarModal button[onclick="updateAvatar()"]'));
                
                const result = await SpecializedApiClients.User.updateAvatar(avatarUrl);
                
                if (result.success) {
                    // 更新頭像顯示
                    document.getElementById('userAvatar').src = avatarUrl;
                    
                    // 更新用戶資料
                    if (userProfile) {
                        userProfile.avatar = avatarUrl;
                        Utils.storage.set('user', userProfile);
                    }
                    
                    UI.modal.hide('avatarModal');
                    UI.showToast('頭像更新成功', 'success');
                    
                    // 清空輸入框
                    document.getElementById('avatarUrl').value = '';
                } else {
                    throw new Error(result.error?.message || '頭像更新失敗');
                }
            } catch (error) {
                UI.handleError(error, '頭像更新');
                UI.showToast('頭像更新失敗: ' + error.message, 'error');
            } finally {
                UI.showLoading(document.querySelector('#avatarModal button[onclick="updateAvatar()"]'), false);
            }
        }
        
        
        // 返回上一頁
        function goBack() {
            if (hasChanges) {
                if (!confirm('您有未保存的變更，確定要離開嗎？')) {
                    return;
                }
            }
            
            // 檢查來源頁面
            if (AppState.selectedCharacter) {
                Router.navigate('/character');
            } else {
                Router.navigate('/');
            }
        }
    </script>
    
    <!-- Flowbite Toast 容器 -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2 md:top-5 md:right-5 sm:top-4 sm:right-4 sm:left-4 sm:right-auto sm:max-w-sm"></div>
</body>
</html>