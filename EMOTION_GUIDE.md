# 情感系統設計指南（Emotion Guide）

本指南說明對話系統中的「情感系統」設計目標、資料與訊號來源、狀態與關係的推進規則、與聊天/記憶/角色的整合方式。內容聚焦方法與原則，不包含程式碼細節。

## 目標

- 連續性：從單輪情緒到長期關係，平滑演進且可解釋。
- 可控性：明確的加/減分規則與節流機制，避免暴衝與失真。
- 個人化：結合個人偏好/禁忌/里程碑，反映專屬互動歷史。
- 可維運：可觀測、可審計、可回溯，支援回放與重算。

## 核心模型

- 即時情緒（Mood）：happy / sad / shy / excited / worried 等。
- 好感度（Affection：0–100）：單調非線性增長，具有上限與時間衰減機制。
- 關係狀態（Relationship）：stranger → acquaintance → friend → close_friend → lover。
- 親密度（Intimacy）：distant → friendly → close → intimate（與好感度/NSFW 互動）。

## 訊號來源（加/減分）

- 對話內容：
  - 正向：支持/共情/稱讚/自我揭露/穩定出席（按強度與頻率加分）。
  - 負向：冷漠/打斷/拒絕/攻擊（按嚴重度扣分）。
- 記憶：
  - 偏好命中：使用對方偏好的稱呼/關懷方式（加分）。
  - 禁忌觸犯：觸及對方禁忌（扣分，嚴重則重置）。
  - 里程碑達成：加較大分值，並解鎖內容/場景。
- NSFW 等級：
  - L1–L2 對關係有弱正向影響；L3 正向中等；L4–L5 僅在關係達標時正向，否則負向/無效。
- 互動節奏：
  - 過度高頻或長期沉默均觸發節流/衰減機制。

## 更新規則（回合級）

- 計分流程：
  1) 解析本輪訊息（內容、長度、情緒、NSFW、是否命中偏好/禁忌）。
  2) 根據規則表計分：加總正負向分值（限制單輪上限）。
  3) 節流：應用冷卻時間與日上限，避免短時間暴衝。
  4) 更新好感度與即時情緒；根據閾值調整關係/親密度。
- 關係躍遷：需跨越門檻且滿足條件（互動天數、正向事件數、未觸犯禁忌等）。
- 里程碑：在指定條件達成時生成（首次牽手、第一次約會等），並寫入時間線。

## 資料持久化與查詢

- 表建議：
  - emotion_states（user×character 當前狀態與分數）
  - emotion_history（回合級變動記錄，含前/後值與原因）
  - emotion_milestones（達成的里程碑與關聯條件）
- 查詢：
  - 狀態：即時讀取 emotion_states。
  - 歷史：分頁查 emotion_history（支援最近 N 天）。
  - 里程碑：查 emotion_milestones。
- 審計：在 history 內保留「規則命中摘要」以追蹤來源與可解釋性。

## 與聊天/記憶/角色整合

- 聊天：在訊息處理末端更新情感（同回合進行），並將新情感注入 Prompt 情境（可選）。
- 記憶：偏好/禁忌/里程碑作為加減分的條件與放大器；反向地，重大情感事件也可寫入長期記憶。
- 角色：不同角色提供不同的加權（如霸總對「依賴/崇拜」更敏感，醫生對「健康關懷」更敏感）。

## 觀測與 SLO

- 指標：平均每輪分值變化、日/週增長、關係躍遷率、里程碑達成率、退化率。
- SLO：單輪更新 < 10ms；歷史查詢 P95 < 50ms；里程碑寫入成功率 > 99.9%。

## 實際實現狀態

### ✅ 已實現功能

- **回合級情感更新**: ✅ 完整實現
  - 每次對話自動更新好感度、心情、關係狀態和親密度
  - 包含基礎分值 (+2) 和正面詞彙加成 (+3)
  - NSFW內容信任加成機制 (L2-L3: +1, L4-L5: +2)

- **關係狀態躍遷**: ✅ 完整實現
  - stranger (0-19) → acquaintance (20-39) → friend (40-59) → close_friend (60-79) → romantic (80+) → lover (80+)
  - 親密度同步更新: distant → polite → friendly → close → intimate → deeply_intimate

- **數據庫持久化**: ✅ 完整實現
  - `emotion_states`: 當前狀態存儲
  - `emotion_history`: 變化記錄和原因追蹤
  - `emotion_milestones`: 關係里程碑記錄

- **查詢功能**: ✅ 完整實現
  - 即時情感狀態查詢
  - 好感度歷史追蹤
  - 關係里程碑記錄

### ⚠️  已知問題

- **緩存同步**: 對話系統返回實時更新的情感狀態，但狀態查詢可能返回緩存值
- **解決方案**: 系統功能正常，數據庫正確更新，主要是查詢緩存的時序問題

### 🔧 關鍵配置

- **初始好感度**: 25-50 (基於用戶和角色ID的穩定散列)
- **好感度範圍**: 0-100，具有上下限保護
- **變化記錄**: 完整的 old→new 狀態追蹤和原因記錄
- **里程碑觸發**: 關係狀態變化時自動生成

